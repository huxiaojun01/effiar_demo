/*
 * ShinevvSdk v3.0.1
 * shinevv SDK
 * Copyright: 2017-2020 shinevv <shinevv@shinevv.com>
 * License: All Rights Reserved
 */

!function(){return function e(t,r,i){function a(s,o){if(!r[s]){if(!t[s]){var c="function"==typeof require&&require;if(!o&&c)return c(s,!0);if(n)return n(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var l=r[s]={exports:{}};t[s][0].call(l.exports,function(e){return a(t[s][1][e]||e)},l,l.exports,e,t,r,i)}return r[s].exports}for(var n="function"==typeof require&&require,s=0;s<i.length;s++)a(i[s]);return a}}()({1:[function(e,t,r){function i(e,t,r,i,a,n,s){try{var o=e[n](s),c=o.value}catch(e){return void r(e)}o.done?t(c):Promise.resolve(c).then(i,a)}t.exports=function(e){return function(){var t=this,r=arguments;return new Promise(function(a,n){var s=e.apply(t,r);function o(e){i(s,a,n,o,c,"next",e)}function c(e){i(s,a,n,o,c,"throw",e)}o(void 0)})}}},{}],2:[function(e,t,r){t.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},{}],3:[function(e,t,r){function i(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}t.exports=function(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}},{}],4:[function(e,t,r){t.exports=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}},{}],5:[function(e,t,r){t.exports=function(e){return e&&e.__esModule?e:{default:e}}},{}],6:[function(e,t,r){var i=e("../helpers/typeof");function a(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return a=function(){return e},e}t.exports=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!==i(e)&&"function"!=typeof e)return{default:e};var t=a();if(t&&t.has(e))return t.get(e);var r={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var o=n?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(r,s,o):r[s]=e[s]}return r.default=e,t&&t.set(e,r),r}},{"../helpers/typeof":7}],7:[function(e,t,r){function i(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=i=function(e){return typeof e}:t.exports=i=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}t.exports=i},{}],8:[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":59}],9:[function(e,t,r){"use strict";var i=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(a,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function o(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((i=i.apply(e,t||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0});r.AwaitQueue=class{constructor({ClosedErrorClass:e,StoppedErrorClass:t}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this._closed=!1,this._pendingTasks=[],this._ClosedErrorClass=Error,this._StoppedErrorClass=Error,this._ClosedErrorClass=e,this._StoppedErrorClass=t}close(){this._closed=!0}push(e){return i(this,void 0,void 0,function*(){if("function"!=typeof e)throw new TypeError("given task is not a function");return new Promise((t,r)=>{const i={execute:e,resolve:t,reject:r,stopped:!1};this._pendingTasks.push(i),1===this._pendingTasks.length&&this._next()})})}stop(){for(const e of this._pendingTasks)e.stopped=!0,e.reject(new this._StoppedErrorClass("AwaitQueue stopped"));this._pendingTasks.length=0}_next(){return i(this,void 0,void 0,function*(){const e=this._pendingTasks[0];e&&(yield this._executeTask(e),this._pendingTasks.shift(),this._next())})}_executeTask(e){return i(this,void 0,void 0,function*(){if(this._closed)e.reject(new this._ClosedErrorClass("AwaitQueue closed"));else if(!e.stopped)try{const t=yield e.execute();if(this._closed)return void e.reject(new this._ClosedErrorClass("AwaitQueue closed"));if(e.stopped)return;e.resolve(t)}catch(t){if(this._closed)return void e.reject(new this._ClosedErrorClass("AwaitQueue closed"));if(e.stopped)return;e.reject(t)}})}}},{}],10:[function(e,t,r){var i,a;i=this,a=function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(i,a,function(t){return e[t]}.bind(null,a));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=90)}({17:function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var i=r(18),a=function(){function e(){}return e.getFirstMatch=function(e,t){var r=t.match(e);return r&&r.length>0&&r[1]||""},e.getSecondMatch=function(e,t){var r=t.match(e);return r&&r.length>1&&r[2]||""},e.matchAndReturnConst=function(e,t,r){if(e.test(t))return r},e.getWindowsVersionName=function(e){switch(e){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},e.getMacOSVersionName=function(e){var t=e.split(".").splice(0,2).map(function(e){return parseInt(e,10)||0});if(t.push(0),10===t[0])switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},e.getAndroidVersionName=function(e){var t=e.split(".").splice(0,2).map(function(e){return parseInt(e,10)||0});if(t.push(0),!(1===t[0]&&t[1]<5))return 1===t[0]&&t[1]<6?"Cupcake":1===t[0]&&t[1]>=6?"Donut":2===t[0]&&t[1]<2?"Eclair":2===t[0]&&2===t[1]?"Froyo":2===t[0]&&t[1]>2?"Gingerbread":3===t[0]?"Honeycomb":4===t[0]&&t[1]<1?"Ice Cream Sandwich":4===t[0]&&t[1]<4?"Jelly Bean":4===t[0]&&t[1]>=4?"KitKat":5===t[0]?"Lollipop":6===t[0]?"Marshmallow":7===t[0]?"Nougat":8===t[0]?"Oreo":9===t[0]?"Pie":void 0},e.getVersionPrecision=function(e){return e.split(".").length},e.compareVersions=function(t,r,i){void 0===i&&(i=!1);var a=e.getVersionPrecision(t),n=e.getVersionPrecision(r),s=Math.max(a,n),o=0,c=e.map([t,r],function(t){var r=s-e.getVersionPrecision(t),i=t+new Array(r+1).join(".0");return e.map(i.split("."),function(e){return new Array(20-e.length).join("0")+e}).reverse()});for(i&&(o=s-Math.min(a,n)),s-=1;s>=o;){if(c[0][s]>c[1][s])return 1;if(c[0][s]===c[1][s]){if(s===o)return 0;s-=1}else if(c[0][s]<c[1][s])return-1}},e.map=function(e,t){var r,i=[];if(Array.prototype.map)return Array.prototype.map.call(e,t);for(r=0;r<e.length;r+=1)i.push(t(e[r]));return i},e.find=function(e,t){var r,i;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(r=0,i=e.length;r<i;r+=1){var a=e[r];if(t(a,r))return a}},e.assign=function(e){for(var t,r,i=e,a=arguments.length,n=new Array(a>1?a-1:0),s=1;s<a;s++)n[s-1]=arguments[s];if(Object.assign)return Object.assign.apply(Object,[e].concat(n));var o=function(){var e=n[t];"object"==typeof e&&null!==e&&Object.keys(e).forEach(function(t){i[t]=e[t]})};for(t=0,r=n.length;t<r;t+=1)o();return e},e.getBrowserAlias=function(e){return i.BROWSER_ALIASES_MAP[e]},e.getBrowserTypeByAlias=function(e){return i.BROWSER_MAP[e]||""},e}();t.default=a,e.exports=t.default},18:function(e,t,r){"use strict";t.__esModule=!0,t.ENGINE_MAP=t.OS_MAP=t.PLATFORMS_MAP=t.BROWSER_MAP=t.BROWSER_ALIASES_MAP=void 0,t.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},t.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},t.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},t.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},t.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var i,a=(i=r(91))&&i.__esModule?i:{default:i},n=r(18);function s(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var o=function(){function e(){}var t,r;return e.getParser=function(e,t){if(void 0===t&&(t=!1),"string"!=typeof e)throw new Error("UserAgent should be a string");return new a.default(e,t)},e.parse=function(e){return new a.default(e).getResult()},t=e,r=[{key:"BROWSER_MAP",get:function(){return n.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return n.ENGINE_MAP}},{key:"OS_MAP",get:function(){return n.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return n.PLATFORMS_MAP}}],null&&s(t.prototype,null),r&&s(t,r),e}();t.default=o,e.exports=t.default},91:function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var i=c(r(92)),a=c(r(93)),n=c(r(94)),s=c(r(95)),o=c(r(17));function c(e){return e&&e.__esModule?e:{default:e}}var d=function(){function e(e,t){if(void 0===t&&(t=!1),null==e||""===e)throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},!0!==t&&this.parse()}var t=e.prototype;return t.getUA=function(){return this._ua},t.test=function(e){return e.test(this._ua)},t.parseBrowser=function(){var e=this;this.parsedResult.browser={};var t=o.default.find(i.default,function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some(function(t){return e.test(t)});throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.browser=t.describe(this.getUA())),this.parsedResult.browser},t.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},t.getBrowserName=function(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},t.getBrowserVersion=function(){return this.getBrowser().version},t.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},t.parseOS=function(){var e=this;this.parsedResult.os={};var t=o.default.find(a.default,function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some(function(t){return e.test(t)});throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.os=t.describe(this.getUA())),this.parsedResult.os},t.getOSName=function(e){var t=this.getOS().name;return e?String(t).toLowerCase()||"":t||""},t.getOSVersion=function(){return this.getOS().version},t.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},t.getPlatformType=function(e){void 0===e&&(e=!1);var t=this.getPlatform().type;return e?String(t).toLowerCase()||"":t||""},t.parsePlatform=function(){var e=this;this.parsedResult.platform={};var t=o.default.find(n.default,function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some(function(t){return e.test(t)});throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.platform=t.describe(this.getUA())),this.parsedResult.platform},t.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},t.getEngineName=function(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},t.parseEngine=function(){var e=this;this.parsedResult.engine={};var t=o.default.find(s.default,function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some(function(t){return e.test(t)});throw new Error("Browser's test function is not valid")});return t&&(this.parsedResult.engine=t.describe(this.getUA())),this.parsedResult.engine},t.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},t.getResult=function(){return o.default.assign({},this.parsedResult)},t.satisfies=function(e){var t=this,r={},i=0,a={},n=0;if(Object.keys(e).forEach(function(t){var s=e[t];"string"==typeof s?(a[t]=s,n+=1):"object"==typeof s&&(r[t]=s,i+=1)}),i>0){var s=Object.keys(r),c=o.default.find(s,function(e){return t.isOS(e)});if(c){var d=this.satisfies(r[c]);if(void 0!==d)return d}var l=o.default.find(s,function(e){return t.isPlatform(e)});if(l){var p=this.satisfies(r[l]);if(void 0!==p)return p}}if(n>0){var u=Object.keys(a),h=o.default.find(u,function(e){return t.isBrowser(e,!0)});if(void 0!==h)return this.compareVersion(a[h])}},t.isBrowser=function(e,t){void 0===t&&(t=!1);var r=this.getBrowserName().toLowerCase(),i=e.toLowerCase(),a=o.default.getBrowserTypeByAlias(i);return t&&a&&(i=a.toLowerCase()),i===r},t.compareVersion=function(e){var t=[0],r=e,i=!1,a=this.getBrowserVersion();if("string"==typeof a)return">"===e[0]||"<"===e[0]?(r=e.substr(1),"="===e[1]?(i=!0,r=e.substr(2)):t=[],">"===e[0]?t.push(1):t.push(-1)):"="===e[0]?r=e.substr(1):"~"===e[0]&&(i=!0,r=e.substr(1)),t.indexOf(o.default.compareVersions(a,r,i))>-1},t.isOS=function(e){return this.getOSName(!0)===String(e).toLowerCase()},t.isPlatform=function(e){return this.getPlatformType(!0)===String(e).toLowerCase()},t.isEngine=function(e){return this.getEngineName(!0)===String(e).toLowerCase()},t.is=function(e){return this.isBrowser(e)||this.isOS(e)||this.isPlatform(e)},t.some=function(e){var t=this;return void 0===e&&(e=[]),e.some(function(e){return t.is(e)})},e}();t.default=d,e.exports=t.default},92:function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var i,a=(i=r(17))&&i.__esModule?i:{default:i},n=/version\/(\d+(\.?_?\d+)+)/i,s=[{test:[/googlebot/i],describe:function(e){var t={name:"Googlebot"},r=a.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/opera/i],describe:function(e){var t={name:"Opera"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:opera)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/opr\/|opios/i],describe:function(e){var t={name:"Opera"},r=a.default.getFirstMatch(/(?:opr|opios)[\s\/](\S+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/SamsungBrowser/i],describe:function(e){var t={name:"Samsung Internet for Android"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:SamsungBrowser)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/Whale/i],describe:function(e){var t={name:"NAVER Whale Browser"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:whale)[\s\/](\d+(?:\.\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/MZBrowser/i],describe:function(e){var t={name:"MZ Browser"},r=a.default.getFirstMatch(/(?:MZBrowser)[\s\/](\d+(?:\.\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/focus/i],describe:function(e){var t={name:"Focus"},r=a.default.getFirstMatch(/(?:focus)[\s\/](\d+(?:\.\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/swing/i],describe:function(e){var t={name:"Swing"},r=a.default.getFirstMatch(/(?:swing)[\s\/](\d+(?:\.\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/coast/i],describe:function(e){var t={name:"Opera Coast"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:coast)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/yabrowser/i],describe:function(e){var t={name:"Yandex Browser"},r=a.default.getFirstMatch(/(?:yabrowser)[\s\/](\d+(\.?_?\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/ucbrowser/i],describe:function(e){var t={name:"UC Browser"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:ucbrowser)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/Maxthon|mxios/i],describe:function(e){var t={name:"Maxthon"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:Maxthon|mxios)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/epiphany/i],describe:function(e){var t={name:"Epiphany"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:epiphany)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/puffin/i],describe:function(e){var t={name:"Puffin"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:puffin)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/sleipnir/i],describe:function(e){var t={name:"Sleipnir"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:sleipnir)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/k-meleon/i],describe:function(e){var t={name:"K-Meleon"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/(?:k-meleon)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/micromessenger/i],describe:function(e){var t={name:"WeChat"},r=a.default.getFirstMatch(/(?:micromessenger)[\s\/](\d+(\.?_?\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/qqbrowser/i],describe:function(e){var t={name:/qqbrowserlite/i.test(e)?"QQ Browser Lite":"QQ Browser"},r=a.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[\/](\d+(\.?_?\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/msie|trident/i],describe:function(e){var t={name:"Internet Explorer"},r=a.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/\sedg\//i],describe:function(e){var t={name:"Microsoft Edge"},r=a.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/edg([ea]|ios)/i],describe:function(e){var t={name:"Microsoft Edge"},r=a.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/vivaldi/i],describe:function(e){var t={name:"Vivaldi"},r=a.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/seamonkey/i],describe:function(e){var t={name:"SeaMonkey"},r=a.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/sailfish/i],describe:function(e){var t={name:"Sailfish"},r=a.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e);return r&&(t.version=r),t}},{test:[/silk/i],describe:function(e){var t={name:"Amazon Silk"},r=a.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/phantom/i],describe:function(e){var t={name:"PhantomJS"},r=a.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/slimerjs/i],describe:function(e){var t={name:"SlimerJS"},r=a.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t={name:"BlackBerry"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t={name:"WebOS Browser"},r=a.default.getFirstMatch(n,e)||a.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/bada/i],describe:function(e){var t={name:"Bada"},r=a.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/tizen/i],describe:function(e){var t={name:"Tizen"},r=a.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/qupzilla/i],describe:function(e){var t={name:"QupZilla"},r=a.default.getFirstMatch(/(?:qupzilla)[\s\/](\d+(\.?_?\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/firefox|iceweasel|fxios/i],describe:function(e){var t={name:"Firefox"},r=a.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s\/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/electron/i],describe:function(e){var t={name:"Electron"},r=a.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/chromium/i],describe:function(e){var t={name:"Chromium"},r=a.default.getFirstMatch(/(?:chromium)[\s\/](\d+(\.?_?\d+)+)/i,e)||a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/chrome|crios|crmo/i],describe:function(e){var t={name:"Chrome"},r=a.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/GSA/i],describe:function(e){var t={name:"Google Search"},r=a.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:function(e){var t=!e.test(/like android/i),r=e.test(/android/i);return t&&r},describe:function(e){var t={name:"Android Browser"},r=a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/playstation 4/i],describe:function(e){var t={name:"PlayStation 4"},r=a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/safari|applewebkit/i],describe:function(e){var t={name:"Safari"},r=a.default.getFirstMatch(n,e);return r&&(t.version=r),t}},{test:[/.*/i],describe:function(e){var t=-1!==e.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:a.default.getFirstMatch(t,e),version:a.default.getSecondMatch(t,e)}}}];t.default=s,e.exports=t.default},93:function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var i,a=(i=r(17))&&i.__esModule?i:{default:i},n=r(18),s=[{test:[/Roku\/DVP/],describe:function(e){var t=a.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e);return{name:n.OS_MAP.Roku,version:t}}},{test:[/windows phone/i],describe:function(e){var t=a.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e);return{name:n.OS_MAP.WindowsPhone,version:t}}},{test:[/windows /i],describe:function(e){var t=a.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e),r=a.default.getWindowsVersionName(t);return{name:n.OS_MAP.Windows,version:t,versionName:r}}},{test:[/Macintosh(.*?) FxiOS(.*?) Version\//],describe:function(e){var t=a.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,e);return{name:n.OS_MAP.iOS,version:t}}},{test:[/macintosh/i],describe:function(e){var t=a.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e).replace(/[_\s]/g,"."),r=a.default.getMacOSVersionName(t),i={name:n.OS_MAP.MacOS,version:t};return r&&(i.versionName=r),i}},{test:[/(ipod|iphone|ipad)/i],describe:function(e){var t=a.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e).replace(/[_\s]/g,".");return{name:n.OS_MAP.iOS,version:t}}},{test:function(e){var t=!e.test(/like android/i),r=e.test(/android/i);return t&&r},describe:function(e){var t=a.default.getFirstMatch(/android[\s\/-](\d+(\.\d+)*)/i,e),r=a.default.getAndroidVersionName(t),i={name:n.OS_MAP.Android,version:t};return r&&(i.versionName=r),i}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t=a.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e),r={name:n.OS_MAP.WebOS};return t&&t.length&&(r.version=t),r}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t=a.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e)||a.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e)||a.default.getFirstMatch(/\bbb(\d+)/i,e);return{name:n.OS_MAP.BlackBerry,version:t}}},{test:[/bada/i],describe:function(e){var t=a.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e);return{name:n.OS_MAP.Bada,version:t}}},{test:[/tizen/i],describe:function(e){var t=a.default.getFirstMatch(/tizen[\/\s](\d+(\.\d+)*)/i,e);return{name:n.OS_MAP.Tizen,version:t}}},{test:[/linux/i],describe:function(){return{name:n.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:n.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(e){var t=a.default.getFirstMatch(/PlayStation 4[\/\s](\d+(\.\d+)*)/i,e);return{name:n.OS_MAP.PlayStation4,version:t}}}];t.default=s,e.exports=t.default},94:function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var i,a=(i=r(17))&&i.__esModule?i:{default:i},n=r(18),s=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(e){var t=a.default.getFirstMatch(/(can-l01)/i,e)&&"Nova",r={type:n.PLATFORMS_MAP.mobile,vendor:"Huawei"};return t&&(r.model=t),r}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:n.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:n.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?) Version\//],describe:function(){return{type:n.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:n.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:n.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:n.PLATFORMS_MAP.tablet}}},{test:function(e){var t=e.test(/ipod|iphone/i),r=e.test(/like (ipod|iphone)/i);return t&&!r},describe:function(e){var t=a.default.getFirstMatch(/(ipod|iphone)/i,e);return{type:n.PLATFORMS_MAP.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:n.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:n.PLATFORMS_MAP.mobile}}},{test:function(e){return"blackberry"===e.getBrowserName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(e){return"bada"===e.getBrowserName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.mobile}}},{test:function(e){return"windows phone"===e.getBrowserName()},describe:function(){return{type:n.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(e){var t=Number(String(e.getOSVersion()).split(".")[0]);return"android"===e.getOSName(!0)&&t>=3},describe:function(){return{type:n.PLATFORMS_MAP.tablet}}},{test:function(e){return"android"===e.getOSName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.mobile}}},{test:function(e){return"macos"===e.getOSName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(e){return"windows"===e.getOSName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.desktop}}},{test:function(e){return"linux"===e.getOSName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.desktop}}},{test:function(e){return"playstation 4"===e.getOSName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.tv}}},{test:function(e){return"roku"===e.getOSName(!0)},describe:function(){return{type:n.PLATFORMS_MAP.tv}}}];t.default=s,e.exports=t.default},95:function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var i,a=(i=r(17))&&i.__esModule?i:{default:i},n=r(18),s=[{test:function(e){return"microsoft edge"===e.getBrowserName(!0)},describe:function(e){if(/\sedg\//i.test(e))return{name:n.ENGINE_MAP.Blink};var t=a.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e);return{name:n.ENGINE_MAP.EdgeHTML,version:t}}},{test:[/trident/i],describe:function(e){var t={name:n.ENGINE_MAP.Trident},r=a.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:function(e){return e.test(/presto/i)},describe:function(e){var t={name:n.ENGINE_MAP.Presto},r=a.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:function(e){var t=e.test(/gecko/i),r=e.test(/like gecko/i);return t&&!r},describe:function(e){var t={name:n.ENGINE_MAP.Gecko},r=a.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:n.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(e){var t={name:n.ENGINE_MAP.WebKit},r=a.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}}];t.default=s,e.exports=t.default}})},"object"==typeof r&&"object"==typeof t?t.exports=a():"function"==typeof define&&define.amd?define([],a):"object"==typeof r?r.bowser=a():i.bowser=a()},{}],11:[function(e,t,r){var i=Object.create||function(e){var t=function(){};return t.prototype=e,new t},a=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return r},n=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function s(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=i(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0;var o,c=10;try{var d={};Object.defineProperty&&Object.defineProperty(d,"x",{value:0}),o=0===d.x}catch(e){o=!1}function l(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function p(e,t,r,a){var n,s,o;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),o=s[t]):(s=e._events=i(null),e._eventsCount=0),o){if("function"==typeof o?o=s[t]=a?[r,o]:[o,r]:a?o.unshift(r):o.push(r),!o.warned&&(n=l(e))&&n>0&&o.length>n){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",c.name,c.message)}}else o=s[t]=r,++e._eventsCount;return e}function u(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function h(e,t,r){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},a=n.call(u,i);return a.listener=r,i.wrapFn=a,a}function m(e,t,r){var i=e._events;if(!i)return[];var a=i[t];return a?"function"==typeof a?r?[a.listener||a]:[a]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(a):g(a,a.length):[]}function f(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function g(e,t){for(var r=new Array(t),i=0;i<t;++i)r[i]=e[i];return r}o?Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');c=e}}):s.defaultMaxListeners=c,s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(e){var t,r,i,a,n,s,o="error"===e;if(s=this._events)o=o&&null==s.error;else if(!o)return!1;if(o){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var c=new Error('Unhandled "error" event. ('+t+")");throw c.context=t,c}if(!(r=s[e]))return!1;var d="function"==typeof r;switch(i=arguments.length){case 1:!function(e,t,r){if(t)e.call(r);else for(var i=e.length,a=g(e,i),n=0;n<i;++n)a[n].call(r)}(r,d,this);break;case 2:!function(e,t,r,i){if(t)e.call(r,i);else for(var a=e.length,n=g(e,a),s=0;s<a;++s)n[s].call(r,i)}(r,d,this,arguments[1]);break;case 3:!function(e,t,r,i,a){if(t)e.call(r,i,a);else for(var n=e.length,s=g(e,n),o=0;o<n;++o)s[o].call(r,i,a)}(r,d,this,arguments[1],arguments[2]);break;case 4:!function(e,t,r,i,a,n){if(t)e.call(r,i,a,n);else for(var s=e.length,o=g(e,s),c=0;c<s;++c)o[c].call(r,i,a,n)}(r,d,this,arguments[1],arguments[2],arguments[3]);break;default:for(a=new Array(i-1),n=1;n<i;n++)a[n-1]=arguments[n];!function(e,t,r,i){if(t)e.apply(r,i);else for(var a=e.length,n=g(e,a),s=0;s<a;++s)n[s].apply(r,i)}(r,d,this,a)}return!0},s.prototype.addListener=function(e,t){return p(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return p(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var r,a,n,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(a=this._events))return this;if(!(r=a[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=i(null):(delete a[e],a.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(n=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){o=r[s].listener,n=s;break}if(n<0)return this;0===n?r.shift():function(e,t){for(var r=t,i=r+1,a=e.length;i<a;r+=1,i+=1)e[r]=e[i];e.pop()}(r,n),1===r.length&&(a[e]=r[0]),a.removeListener&&this.emit("removeListener",e,o||t)}return this},s.prototype.removeAllListeners=function(e){var t,r,n;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=i(null),this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=i(null):delete r[e]),this;if(0===arguments.length){var s,o=a(r);for(n=0;n<o.length;++n)"removeListener"!==(s=o[n])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=i(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},s.prototype.listeners=function(e){return m(this,e,!0)},s.prototype.rawListeners=function(e){return m(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},s.prototype.listenerCount=f,s.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],12:[function(e,t,r){var i=1e3,a=60*i,n=60*a,s=24*n,o=7*s,c=365.25*s;function d(e,t,r,i){var a=t>=1.5*r;return Math.round(e/r)+" "+i+(a?"s":"")}t.exports=function(e,t){t=t||{};var r=typeof e;if("string"===r&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return r*c;case"weeks":case"week":case"w":return r*o;case"days":case"day":case"d":return r*s;case"hours":case"hour":case"hrs":case"hr":case"h":return r*n;case"minutes":case"minute":case"mins":case"min":case"m":return r*a;case"seconds":case"second":case"secs":case"sec":case"s":return r*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}(e);if("number"===r&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=s)return d(e,t,s,"day");if(t>=n)return d(e,t,n,"hour");if(t>=a)return d(e,t,a,"minute");if(t>=i)return d(e,t,i,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=s)return Math.round(e/s)+"d";if(t>=n)return Math.round(e/n)+"h";if(t>=a)return Math.round(e/a)+"m";if(t>=i)return Math.round(e/i)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},{}],13:[function(e,t,r){(function(i){r.log=function(...e){return"object"==typeof console&&console.log&&console.log(...e)},r.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;e.splice(1,0,r,"color: inherit");let i=0,a=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(i++,"%c"===e&&(a=i))}),e.splice(a,0,r)},r.save=function(e){try{e?r.storage.setItem("debug",e):r.storage.removeItem("debug")}catch(e){}},r.load=function(){let e;try{e=r.storage.getItem("debug")}catch(e){}!e&&void 0!==i&&"env"in i&&(e=i.env.DEBUG);return e},r.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},r.storage=function(){try{return localStorage}catch(e){}}(),r.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.exports=e("./common")(r);const{formatters:a}=t.exports;a.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,e("_process"))},{"./common":14,_process:49}],14:[function(e,t,r){t.exports=function(t){function r(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return i.colors[Math.abs(t)%i.colors.length]}function i(e){let t;function s(...e){if(!s.enabled)return;const r=s,a=Number(new Date),n=a-(t||a);r.diff=n,r.prev=t,r.curr=a,t=a,e[0]=i.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(t,a)=>{if("%%"===t)return t;o++;const n=i.formatters[a];if("function"==typeof n){const i=e[o];t=n.call(r,i),e.splice(o,1),o--}return t}),i.formatArgs.call(r,e),(r.log||i.log).apply(r,e)}return s.namespace=e,s.enabled=i.enabled(e),s.useColors=i.useColors(),s.color=r(e),s.destroy=a,s.extend=n,"function"==typeof i.init&&i.init(s),i.instances.push(s),s}function a(){const e=i.instances.indexOf(this);return-1!==e&&(i.instances.splice(e,1),!0)}function n(e,t){const r=i(this.namespace+(void 0===t?":":t)+e);return r.log=this.log,r}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return i.debug=i,i.default=i,i.coerce=function(e){return e instanceof Error?e.stack||e.message:e},i.disable=function(){const e=[...i.names.map(s),...i.skips.map(s).map(e=>"-"+e)].join(",");return i.enable(""),e},i.enable=function(e){let t;i.save(e),i.names=[],i.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),a=r.length;for(t=0;t<a;t++)r[t]&&("-"===(e=r[t].replace(/\*/g,".*?"))[0]?i.skips.push(new RegExp("^"+e.substr(1)+"$")):i.names.push(new RegExp("^"+e+"$")));for(t=0;t<i.instances.length;t++){const e=i.instances[t];e.enabled=i.enabled(e.namespace)}},i.enabled=function(e){if("*"===e[e.length-1])return!0;let t,r;for(t=0,r=i.skips.length;t<r;t++)if(i.skips[t].test(e))return!1;for(t=0,r=i.names.length;t<r;t++)if(i.names[t].test(e))return!0;return!1},i.humanize=e("ms"),Object.keys(t).forEach(e=>{i[e]=t[e]}),i.instances=[],i.names=[],i.skips=[],i.formatters={},i.selectColor=r,i.enable(i.load()),i}},{ms:12}],15:[function(e,t,r){var i=function(){if("object"==typeof self&&self)return self;if("object"==typeof window&&window)return window;throw new Error("Unable to resolve global `this`")};t.exports=function(){if(this)return this;if("object"==typeof globalThis&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch(e){return i()}try{return __global__||i()}finally{delete Object.prototype.__global__}}()},{}],16:[function(e,t,r){const i=e("debug")("h264-profile-level-id");i.log=console.info.bind(console);r.ProfileConstrainedBaseline=1,r.ProfileBaseline=2,r.ProfileMain=3,r.ProfileConstrainedHigh=4,r.ProfileHigh=5;const a=0,n=10;r.Level1_b=a,r.Level1=n,r.Level1_1=11,r.Level1_2=12,r.Level1_3=13,r.Level2=20,r.Level2_1=21,r.Level2_2=22,r.Level3=30,r.Level3_1=31,r.Level3_2=32,r.Level4=40,r.Level4_1=41,r.Level4_2=42,r.Level5=50,r.Level5_1=51,r.Level5_2=52;class s{constructor(e,t){this.profile=e,this.level=t}}r.ProfileLevelId=s;const o=new s(1,31);class c{constructor(e){this._mask=~p("x",e),this._maskedValue=p("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}}class d{constructor(e,t,r){this.profile_idc=e,this.profile_iop=t,this.profile=r}}const l=[new d(66,new c("x1xx0000"),1),new d(77,new c("1xxx0000"),1),new d(88,new c("11xx0000"),1),new d(66,new c("x0xx0000"),2),new d(88,new c("10xx0000"),2),new d(77,new c("0x0x0000"),3),new d(100,new c("00000000"),5),new d(100,new c("00001100"),4)];function p(e,t){return(t[0]===e)<<7|(t[1]===e)<<6|(t[2]===e)<<5|(t[3]===e)<<4|(t[4]===e)<<3|(t[5]===e)<<2|(t[6]===e)<<1|(t[7]===e)<<0}function u(e={}){const t=e["level-asymmetry-allowed"];return 1===t||"1"===t}r.parseProfileLevelId=function(e){if("string"!=typeof e||6!==e.length)return null;const t=parseInt(e,16);if(0===t)return null;const r=255&t,o=t>>8&255,c=t>>16&255;let d;switch(r){case 11:d=0!=(16&o)?a:11;break;case n:case 12:case 13:case 20:case 21:case 22:case 30:case 31:case 32:case 40:case 41:case 42:case 50:case 51:case 52:d=r;break;default:return i("parseProfileLevelId() | unrecognized level_idc:%s",r),null}for(const e of l)if(c===e.profile_idc&&e.profile_iop.isMatch(o))return new s(e.profile,d);return i("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},r.profileLevelIdToString=function(e){if(e.level==a)switch(e.profile){case 1:return"42f00b";case 2:return"42100b";case 3:return"4d100b";default:return i("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",e.profile),null}let t;switch(e.profile){case 1:t="42e0";break;case 2:t="4200";break;case 3:t="4d00";break;case 4:t="640c";break;case 5:t="6400";break;default:return i("profileLevelIdToString() | unrecognized profile:%s",e.profile),null}let r=e.level.toString(16);return 1===r.length&&(r=`0${r}`),`${t}${r}`},r.parseSdpProfileLevelId=function(e={}){const t=e["profile-level-id"];return t?r.parseProfileLevelId(t):o},r.isSameProfile=function(e={},t={}){const i=r.parseSdpProfileLevelId(e),a=r.parseSdpProfileLevelId(t);return Boolean(i&&a&&i.profile===a.profile)},r.generateProfileLevelIdForAnswer=function(e={},t={}){if(!e["profile-level-id"]&&!t["profile-level-id"])return i("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const o=r.parseSdpProfileLevelId(e),c=r.parseSdpProfileLevelId(t);if(!o)throw new TypeError("invalid local_profile_level_id");if(!c)throw new TypeError("invalid remote_profile_level_id");if(o.profile!==c.profile)throw new TypeError("H264 Profile mismatch");const d=u(e)&&u(t),l=o.level,p=c.level,h=function(e,t){return e===a?t!==n&&t!==a:t===a?e!==n:e<t}(m=l,f=p)?m:f;var m,f;const g=d?l:h;return i("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",o.profile,g),r.profileLevelIdToString(new s(o.profile,g))}},{debug:13}],17:[function(e,t,r){var i,a=e("wildemitter");"undefined"!=typeof window&&(i=window.AudioContext||window.webkitAudioContext);var n=null;t.exports=function(e,t){var r=new a;if(!i)return r;var s,o,c,d=(t=t||{}).smoothing||.1,l=t.interval||50,p=t.threshold,u=t.play,h=t.history||10,m=!0;n=t.audioContext||n||new i,(c=n.createAnalyser()).fftSize=512,c.smoothingTimeConstant=d,o=new Float32Array(c.frequencyBinCount),e.jquery&&(e=e[0]),e instanceof HTMLAudioElement||e instanceof HTMLVideoElement?(s=n.createMediaElementSource(e),void 0===u&&(u=!0),p=p||-50):(s=n.createMediaStreamSource(e),p=p||-50),s.connect(c),u&&c.connect(n.destination),r.speaking=!1,r.suspend=function(){return n.suspend()},r.resume=function(){return n.resume()},Object.defineProperty(r,"state",{get:function(){return n.state}}),n.onstatechange=function(){r.emit("state_change",n.state)},r.setThreshold=function(e){p=e},r.setInterval=function(e){l=e},r.stop=function(){m=!1,r.emit("volume_change",-100,p),r.speaking&&(r.speaking=!1,r.emit("stopped_speaking")),c.disconnect(),s.disconnect()},r.speakingHistory=[];for(var f=0;f<h;f++)r.speakingHistory.push(0);var g=function(){setTimeout(function(){if(m){var e=function(e,t){var r=-1/0;e.getFloatFrequencyData(t);for(var i=4,a=t.length;i<a;i++)t[i]>r&&t[i]<0&&(r=t[i]);return r}(c,o);r.emit("volume_change",e,p);var t=0;if(e>p&&!r.speaking){for(var i=r.speakingHistory.length-3;i<r.speakingHistory.length;i++)t+=r.speakingHistory[i];t>=2&&(r.speaking=!0,r.emit("speaking"))}else if(e<p&&r.speaking){for(i=0;i<r.speakingHistory.length;i++)t+=r.speakingHistory[i];0==t&&(r.speaking=!1,r.emit("stopped_speaking"))}r.speakingHistory.shift(),r.speakingHistory.push(0+(e>p)),g()}},l)};return g(),r}},{wildemitter:70}],18:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const i=e("./Logger"),a=e("./EnhancedEventEmitter"),n=e("./errors"),s=new i.Logger("Consumer");r.Consumer=class extends a.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:r,rtpReceiver:i,track:a,rtpParameters:n,appData:o}){super(),this._closed=!1,s.debug("constructor()"),this._id=e,this._localId=t,this._producerId=r,this._rtpReceiver=i,this._track=a,this._rtpParameters=n,this._paused=!a.enabled,this._appData=o,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}close(){this._closed||(s.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"))}transportClosed(){this._closed||(s.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"))}async getStats(){if(this._closed)throw new n.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){s.debug("pause()"),this._closed?s.error("pause() | Consumer closed"):(this._paused=!0,this._track.enabled=!1)}resume(){s.debug("resume()"),this._closed?s.error("resume() | Consumer closed"):(this._paused=!1,this._track.enabled=!0)}_onTrackEnded(){s.debug('track "ended" event'),this.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){try{this._track.removeEventListener("ended",this._onTrackEnded),this._track.stop()}catch(e){}}}},{"./EnhancedEventEmitter":22,"./Logger":23,"./errors":26}],19:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const i=e("./Logger"),a=e("./EnhancedEventEmitter"),n=new i.Logger("DataConsumer");r.DataConsumer=class extends a.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:r,sctpStreamParameters:i,appData:a}){super(),this._closed=!1,n.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=r,this._sctpStreamParameters=i,this._appData=a,this._handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}close(){this._closed||(n.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"))}transportClosed(){this._closed||(n.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"))}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(n.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),"sctp-failure"===t.errorDetail?n.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):n.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(n.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}}},{"./EnhancedEventEmitter":22,"./Logger":23}],20:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const i=e("./Logger"),a=e("./EnhancedEventEmitter"),n=e("./errors"),s=new i.Logger("DataProducer");r.DataProducer=class extends a.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:r,appData:i}){super(),this._closed=!1,s.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=r,this._appData=i,this._handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}close(){this._closed||(s.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"))}transportClosed(){this._closed||(s.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"))}send(e){if(s.debug("send()"),this._closed)throw new n.InvalidStateError("closed");this._dataChannel.send(e)}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(s.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),"sctp-failure"===t.errorDetail?s.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):s.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(s.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||s.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}}},{"./EnhancedEventEmitter":22,"./Logger":23,"./errors":26}],21:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("bowser")),n=e("./Logger"),s=e("./errors"),o=i(e("./ortc")),c=e("./Transport"),d=e("./handlers/Chrome74"),l=e("./handlers/Chrome70"),p=e("./handlers/Chrome67"),u=e("./handlers/Chrome55"),h=e("./handlers/Firefox60"),m=e("./handlers/Safari12"),f=e("./handlers/Safari11"),g=e("./handlers/Edge11"),v=e("./handlers/ReactNative"),b=new n.Logger("Device");function _(){if("object"==typeof navigator&&"ReactNative"===navigator.product)return"undefined"==typeof RTCPeerConnection?void b.warn("this._detectDevice() | unsupported ReactNative without RTCPeerConnection"):(b.debug("this._detectDevice() | ReactNative handler chosen"),"ReactNative");if("object"!=typeof navigator||"string"!=typeof navigator.userAgent)b.warn("this._detectDevice() | unknown device");else{const e=navigator.userAgent,t=a.getParser(e),r=t.getEngine();if(t.satisfies({chrome:">=74",chromium:">=74"}))return"Chrome74";if(t.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(t.satisfies({chrome:">=67",chromium:">=67"}))return"Chrome67";if(t.satisfies({chrome:">=55",chromium:">=55"}))return"Chrome55";if(t.satisfies({firefox:">=60"}))return"Firefox60";if(t.satisfies({safari:">=12.0"})&&"undefined"!=typeof RTCRtpTransceiver&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(t.satisfies({safari:">=11"}))return"Safari11";if(t.satisfies({"microsoft edge":">=11"})&&t.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(r.name&&"blink"===r.name.toLowerCase()){const t=e.match(/(?:(?:Chrome|Chromium))[ \/](\w+)/i);if(t){const e=Number(t[1]);return e>=74?"Chrome74":e>=70?"Chrome70":e>=67?"Chrome67":"Chrome55"}return"Chrome74"}b.warn("this._detectDevice() | browser not supported [name:%s, version:%s]",t.getBrowserName(),t.getBrowserVersion())}}r.detectDevice=_;r.Device=class{constructor({handlerName:e,handlerFactory:t,Handler:r}={}){if(this._loaded=!1,b.debug("constructor()"),r){if(b.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),"string"!=typeof r)throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");e=r}if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)b.debug("constructor() | handler given: %s",e);else{if(!(e=_()))throw new s.UnsupportedError("device not supported");b.debug("constructor() | detected handler: %s",e)}switch(e){case"Chrome74":this._handlerFactory=d.Chrome74.createFactory();break;case"Chrome70":this._handlerFactory=l.Chrome70.createFactory();break;case"Chrome67":this._handlerFactory=p.Chrome67.createFactory();break;case"Chrome55":this._handlerFactory=u.Chrome55.createFactory();break;case"Firefox60":this._handlerFactory=h.Firefox60.createFactory();break;case"Safari12":this._handlerFactory=m.Safari12.createFactory();break;case"Safari11":this._handlerFactory=f.Safari11.createFactory();break;case"Edge11":this._handlerFactory=g.Edge11.createFactory();break;case"ReactNative":this._handlerFactory=v.ReactNative.createFactory();break;default:throw new TypeError(`unknown handlerName "${e}"`)}}const i=this._handlerFactory();this._handlerName=i.name,i.close(),this._extendedRtpCapabilities=null,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=null}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new s.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new s.InvalidStateError("not loaded");return this._sctpCapabilities}async load({routerRtpCapabilities:e}={}){let t;b.debug("load() [routerRtpCapabilities:%o]",e);try{if(this._loaded)throw new s.InvalidStateError("already loaded");o.validateRtpCapabilities(e),t=this._handlerFactory();const r=await t.getNativeRtpCapabilities();b.debug("load() | got native RTP capabilities:%o",r),o.validateRtpCapabilities(r),this._extendedRtpCapabilities=o.getExtendedRtpCapabilities(r,e),b.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=o.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=o.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=o.getRecvRtpCapabilities(this._extendedRtpCapabilities),b.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),b.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),b.debug("load() succeeded"),this._loaded=!0,t.close()}catch(e){throw t&&t.close(),e}}canProduce(e){if(!this._loaded)throw new s.InvalidStateError("not loaded");if("audio"!==e&&"video"!==e)throw new TypeError(`invalid kind "${e}"`);return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:o,proprietaryConstraints:c,appData:d={}}){return b.debug("createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:o,proprietaryConstraints:c,appData:d})}createRecvTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:o,proprietaryConstraints:c,appData:d={}}){return b.debug("createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:o,proprietaryConstraints:c,appData:d})}_createTransport({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:a,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:l,proprietaryConstraints:p,appData:u={}}){if(!this._loaded)throw new s.InvalidStateError("not loaded");if("string"!=typeof t)throw new TypeError("missing id");if("object"!=typeof r)throw new TypeError("missing iceParameters");if(!Array.isArray(i))throw new TypeError("missing iceCandidates");if("object"!=typeof a)throw new TypeError("missing dtlsParameters");if(n&&"object"!=typeof n)throw new TypeError("wrong sctpParameters");if(u&&"object"!=typeof u)throw new TypeError("if given, appData must be an object");return new c.Transport({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:a,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:l,proprietaryConstraints:p,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind})}}},{"./Logger":23,"./Transport":25,"./errors":26,"./handlers/Chrome55":27,"./handlers/Chrome67":28,"./handlers/Chrome70":29,"./handlers/Chrome74":30,"./handlers/Edge11":31,"./handlers/Firefox60":32,"./handlers/ReactNative":34,"./handlers/Safari11":35,"./handlers/Safari12":36,"./ortc":44,bowser:48}],22:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const i=e("events"),a=new(e("./Logger").Logger)("EnhancedEventEmitter");r.EnhancedEventEmitter=class extends i.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(e,...t){const r=this.listenerCount(e);try{return this.emit(e,...t)}catch(t){return a.error("safeEmit() | event listener threw an error [event:%s]:%o",e,t),Boolean(r)}}async safeEmitAsPromise(e,...t){return new Promise((r,i)=>this.safeEmit(e,...t,r,i))}}},{"./Logger":23,events:11}],23:[function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("debug")),n="mediasoup-client";r.Logger=class{constructor(e){e?(this._debug=a.default(`${n}:${e}`),this._warn=a.default(`${n}:WARN:${e}`),this._error=a.default(`${n}:ERROR:${e}`)):(this._debug=a.default(n),this._warn=a.default(`${n}:WARN`),this._error=a.default(`${n}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}},{debug:13}],24:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const i=e("./Logger"),a=e("./EnhancedEventEmitter"),n=e("./errors"),s=new i.Logger("Producer");r.Producer=class extends a.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:r,track:i,rtpParameters:a,stopTracks:n,appData:o}){super(),this._closed=!1,s.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=r,this._track=i,this._rtpParameters=a,this._paused=!i.enabled,this._maxSpatialLayer=void 0,this._stopTracks=n,this._appData=o,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}close(){this._closed||(s.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"))}transportClosed(){this._closed||(s.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"))}async getStats(){if(this._closed)throw new n.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){s.debug("pause()"),this._closed?s.error("pause() | Producer closed"):(this._paused=!0,this._track.enabled=!1)}resume(){s.debug("resume()"),this._closed?s.error("resume() | Producer closed"):(this._paused=!1,this._track.enabled=!0)}async replaceTrack({track:e}){if(s.debug("replaceTrack() [track:%o]",e),this._closed){if(this._stopTracks)try{e.stop()}catch(e){}throw new n.InvalidStateError("closed")}if(!e)throw new TypeError("missing track");if("ended"===e.readyState)throw new n.InvalidStateError("track ended");e!==this._track?(await this.safeEmitAsPromise("@replacetrack",e),this._destroyTrack(),this._track=e,this._paused?this._track.enabled=!1:this._track.enabled=!0,this._handleTrack()):s.debug("replaceTrack() | same track, ignored")}async setMaxSpatialLayer(e){if(this._closed)throw new n.InvalidStateError("closed");if("video"!==this._track.kind)throw new n.UnsupportedError("not a video Producer");if("number"!=typeof e)throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await this.safeEmitAsPromise("@setmaxspatiallayer",e),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new n.InvalidStateError("closed");if("object"!=typeof e)throw new TypeError("invalid params");await this.safeEmitAsPromise("@setrtpencodingparameters",e)}_onTrackEnded(){s.debug('track "ended" event'),this.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){try{this._track.removeEventListener("ended",this._onTrackEnded),this._stopTracks&&this._track.stop()}catch(e){}}}},{"./EnhancedEventEmitter":22,"./Logger":23,"./errors":26}],25:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=e("awaitqueue"),n=e("./Logger"),s=e("./EnhancedEventEmitter"),o=e("./errors"),c=i(e("./utils")),d=i(e("./ortc")),l=e("./Producer"),p=e("./Consumer"),u=e("./DataProducer"),h=e("./DataConsumer"),m=new n.Logger("Transport");r.Transport=class extends s.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:d,iceTransportPolicy:l,additionalSettings:p,proprietaryConstraints:u,appData:h,handlerFactory:f,extendedRtpCapabilities:g,canProduceByKind:v}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new a.AwaitQueue({ClosedErrorClass:o.InvalidStateError}),m.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=g,this._canProduceByKind=v,this._maxSctpMessageSize=s?s.maxMessageSize:null,delete(p=c.clone(p)).iceServers,delete p.iceTransportPolicy,delete p.bundlePolicy,delete p.rtcpMuxPolicy,delete p.sdpSemantics,this._handler=f(),this._handler.run({direction:e,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:d,iceTransportPolicy:l,additionalSettings:p,proprietaryConstraints:u,extendedRtpCapabilities:g}),this._appData=h,this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}close(){if(!this._closed){m.debug("close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear()}}async getStats(){if(this._closed)throw new o.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(m.debug("restartIce()"),this._closed)throw new o.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(e))}async updateIceServers({iceServers:e}={}){if(m.debug("updateIceServers()"),this._closed)throw new o.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e))}async produce({track:e,encodings:t,codecOptions:r,stopTracks:i=!0,appData:a={}}={}){if(m.debug("produce() [track:%o]",e),!e)throw new TypeError("missing track");if("send"!==this._direction)throw new o.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[e.kind])throw new o.UnsupportedError(`cannot produce ${e.kind}`);if("ended"===e.readyState)throw new o.InvalidStateError("track ended");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(0===this.listenerCount("produce"))throw new TypeError('no "produce" listener set into this transport');if(a&&"object"!=typeof a)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{let n;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&0===t.length?n=void 0:t&&(n=t.map(e=>{const t={active:!0};return!1===e.active&&(t.active=!1),"number"==typeof e.maxBitrate&&(t.maxBitrate=e.maxBitrate),"number"==typeof e.maxFramerate&&(t.maxFramerate=e.maxFramerate),"number"==typeof e.scaleResolutionDownBy&&(t.scaleResolutionDownBy=e.scaleResolutionDownBy),"boolean"==typeof e.dtx&&(t.dtx=e.dtx),"string"==typeof e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),"string"==typeof e.priority&&(t.priority=e.priority),"string"==typeof e.networkPriority&&(t.networkPriority=e.networkPriority),t}));const{localId:s,rtpParameters:o,rtpSender:c}=await this._handler.send({track:e,encodings:n,codecOptions:r});try{d.validateRtpParameters(o);const{id:t}=await this.safeEmitAsPromise("produce",{kind:e.kind,rtpParameters:o,appData:a}),r=new l.Producer({id:t,localId:s,rtpSender:c,track:e,rtpParameters:o,stopTracks:i,appData:a});return this._producers.set(r.id,r),this._handleProducer(r),r}catch(e){throw this._handler.stopSending(s).catch(()=>{}),e}}).catch(t=>{if(i)try{e.stop()}catch(e){}throw t})}async consume({id:e,producerId:t,kind:r,rtpParameters:i,appData:a={}}={}){if(m.debug("consume()"),this._closed)throw new o.InvalidStateError("closed");if("recv"!==this._direction)throw new o.UnsupportedError("not a receiving Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing producerId");if("audio"!==r&&"video"!==r)throw new TypeError(`invalid kind '${r}'`);if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(a&&"object"!=typeof a)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{if(!d.canReceive(i,this._extendedRtpCapabilities))throw new o.UnsupportedError("cannot consume this Producer");const{localId:n,rtpReceiver:s,track:c}=await this._handler.receive({trackId:e,kind:r,rtpParameters:i}),l=new p.Consumer({id:e,localId:n,producerId:t,rtpReceiver:s,track:c,rtpParameters:i,appData:a});if(this._consumers.set(l.id,l),this._handleConsumer(l),!this._probatorConsumerCreated&&"video"===r)try{const e=d.generateProbatorRtpParameters(l.rtpParameters);await this._handler.receive({trackId:"probator",kind:"video",rtpParameters:e}),m.debug("consume() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(e){m.error("consume() | failed to create Consumer for RTP probation:%o",e)}return l})}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:r,priority:i="low",label:a="",protocol:n="",appData:s={}}={}){if(m.debug("produceData()"),"send"!==this._direction)throw new o.UnsupportedError("not a sending Transport");if(!this._maxSctpMessageSize)throw new o.UnsupportedError("SCTP not enabled by remote Transport");if(!["very-low","low","medium","high"].includes(i))throw new TypeError("wrong priority");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(0===this.listenerCount("producedata"))throw new TypeError('no "producedata" listener set into this transport');if(s&&"object"!=typeof s)throw new TypeError("if given, appData must be an object");return(t||r)&&(e=!1),this._awaitQueue.push(async()=>{const{dataChannel:o,sctpStreamParameters:c}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,priority:i,label:a,protocol:n});d.validateSctpStreamParameters(c);const{id:l}=await this.safeEmitAsPromise("producedata",{sctpStreamParameters:c,label:a,protocol:n,appData:s}),p=new u.DataProducer({id:l,dataChannel:o,sctpStreamParameters:c,appData:s});return this._dataProducers.set(p.id,p),this._handleDataProducer(p),p})}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:r,label:i="",protocol:a="",appData:n={}}){if(m.debug("consumeData()"),this._closed)throw new o.InvalidStateError("closed");if("recv"!==this._direction)throw new o.UnsupportedError("not a receiving Transport");if(!this._maxSctpMessageSize)throw new o.UnsupportedError("SCTP not enabled by remote Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing dataProducerId");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(n&&"object"!=typeof n)throw new TypeError("if given, appData must be an object");return d.validateSctpStreamParameters(r),this._awaitQueue.push(async()=>{const{dataChannel:s}=await this._handler.receiveDataChannel({sctpStreamParameters:r,label:i,protocol:a}),o=new h.DataConsumer({id:e,dataProducerId:t,dataChannel:s,sctpStreamParameters:r,appData:n});return this._dataConsumers.set(o.id,o),this._handleDataConsumer(o),o})}_handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:e},t,r)=>{this._closed?r(new o.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:e},t,r)}),e.on("@connectionstatechange",e=>{e!==this._connectionState&&(m.debug("connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e))})}_handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),this._closed||this._awaitQueue.push(async()=>this._handler.stopSending(e.localId)).catch(e=>m.warn("producer.close() failed:%o",e))}),e.on("@replacetrack",(t,r,i)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(e.localId,t)).then(r).catch(i)}),e.on("@setmaxspatiallayer",(t,r,i)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(e.localId,t)).then(r).catch(i)}),e.on("@setrtpencodingparameters",(t,r,i)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(e.localId,t)).then(r).catch(i)}),e.on("@getstats",(t,r)=>{if(this._closed)return r(new o.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(r)})}_handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._closed||this._awaitQueue.push(async()=>this._handler.stopReceiving(e.localId)).catch(()=>{})}),e.on("@getstats",(t,r)=>{if(this._closed)return r(new o.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(r)})}_handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}_handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}}},{"./Consumer":18,"./DataConsumer":19,"./DataProducer":20,"./EnhancedEventEmitter":22,"./Logger":23,"./Producer":24,"./errors":26,"./ortc":44,"./utils":47,awaitqueue:9}],26:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});class i extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,i):this.stack=new Error(e).stack}}r.UnsupportedError=i;class a extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,a):this.stack=new Error(e).stack}}r.InvalidStateError=a},{}],27:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=e("../errors"),o=i(e("../utils")),c=i(e("../ortc")),d=i(e("./sdp/commonUtils")),l=i(e("./sdp/planBUtils")),p=e("./HandlerInterface"),u=e("./sdp/RemoteSdp"),h=new n.Logger("Chrome55"),m={OS:1024,MIS:1024};class f extends p.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new f}get name(){return"Chrome55"}close(){if(h.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){h.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=a.parse(t.sdp);return d.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.debug("getNativeSctpCapabilities()"),{numStreams:m}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){h.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",l),video:c.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",l),video:c.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...o},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async updateIceServers(e){h.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});h.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){this._assertSendDirection(),h.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let i,n=await this._pc.createOffer(),s=a.parse(n.sdp);const c=o.clone(this._sendingRtpParametersByKind[e.kind]);if(this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:s}),"video"===e.kind&&t&&t.length>1&&(h.debug("send() | enabling simulcast"),i=(s=a.parse(n.sdp)).media.find(e=>"video"===e.type),l.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:a.write(s)}),h.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),i=(s=a.parse(this._pc.localDescription.sdp)).media.find(t=>t.type===e.kind),c.rtcp.cname=d.getCname({offerMediaObject:i}),c.encodings=l.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<c.encodings.length;++e)t[e]&&Object.assign(c.encodings[e],t[e]);if(c.encodings.length>1&&"video/vp8"===c.codecs[0].mimeType.toLowerCase())for(const e of c.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:c,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r});const p={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setRemoteDescription(p);const u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:c}}async stopSending(e){this._assertSendDirection(),h.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();h.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(e){if(0===this._sendStream.getTracks().length)return void h.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){throw new s.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new s.UnsupportedError(" not implemented")}async setRtpEncodingParameters(e,t){throw new s.UnsupportedError("not supported")}async getSenderStats(e){throw new s.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n,priority:s};h.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),h.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),h.debug("receive() [trackId:%s, kind:%s]",e,t);const i=e,n=t,s=r.rtcp.cname;this._remoteSdp.receive({mid:n,kind:t,offerRtpParameters:r,streamId:s,trackId:e});const o={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),await this._pc.setRemoteDescription(o);let c=await this._pc.createAnswer();const l=a.parse(c.sdp),p=l.media.find(e=>String(e.mid)===n);d.applyCodecParameters({offerRtpParameters:r,answerMediaObject:p}),c={type:"answer",sdp:a.write(l)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:l}),h.debug("receive() | calling pc.setLocalDescription() [answer:%o]",c),await this._pc.setLocalDescription(c);const u=this._pc.getRemoteStreams().find(e=>e.id===s).getTrackById(i);if(!u)throw new Error("remote track not found");return this._mapRecvLocalIdInfo.set(i,{mid:n,rtpParameters:r}),{localId:i,track:u}}async stopReceiving(e){this._assertRecvDirection(),h.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e);this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const i={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);const a=await this._pc.createAnswer();h.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a)}async getReceiverStats(e){throw new s.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmitTime:s,maxRetransmits:o,protocol:r};h.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=d.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.Chrome55=f},{"../Logger":23,"../errors":26,"../ortc":44,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/planBUtils":41,"sdp-transform":64}],28:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=i(e("../utils")),o=i(e("../ortc")),c=i(e("./sdp/commonUtils")),d=i(e("./sdp/planBUtils")),l=e("./HandlerInterface"),p=e("./sdp/RemoteSdp"),u=new n.Logger("Chrome67"),h={OS:1024,MIS:1024};class m extends l.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new m}get name(){return"Chrome67"}close(){if(u.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){u.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=a.parse(t.sdp);return c.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return u.debug("getNativeSctpCapabilities()"),{numStreams:h}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){u.debug("run()"),this._direction=e,this._remoteSdp=new p.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:o.getSendingRtpParameters("audio",l),video:o.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:o.getSendingRemoteRtpParameters("audio",l),video:o.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...c},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async updateIceServers(e){u.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(u.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});u.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();u.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){this._assertSendDirection(),u.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let i,n=await this._pc.createOffer(),o=a.parse(n.sdp);const l=s.clone(this._sendingRtpParametersByKind[e.kind]);if(this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:o}),"video"===e.kind&&t&&t.length>1&&(u.debug("send() | enabling simulcast"),i=(o=a.parse(n.sdp)).media.find(e=>"video"===e.type),d.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:a.write(o)}),u.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),i=(o=a.parse(this._pc.localDescription.sdp)).media.find(t=>t.type===e.kind),l.rtcp.cname=c.getCname({offerMediaObject:i}),l.encodings=d.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<l.encodings.length;++e)t[e]&&Object.assign(l.encodings[e],t[e]);if(l.encodings.length>1&&"video/vp8"===l.codecs[0].mimeType.toLowerCase())for(const e of l.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:l,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r});const p={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setRemoteDescription(p);const h=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(h,e),{localId:h,rtpParameters:l,rtpSender:this._pc.getSenders().find(t=>t.track===e)}}async stopSending(e){this._assertSendDirection(),u.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e),r=this._pc.getSenders().find(e=>e.track===t);if(!r)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(r),this._sendStream.removeTrack(t),this._mapSendLocalIdTrack.delete(e);const i=await this._pc.createOffer();u.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{await this._pc.setLocalDescription(i)}catch(e){if(0===this._sendStream.getTracks().length)return void u.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const a={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async replaceTrack(e,t){this._assertSendDirection(),u.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id);const r=this._mapSendLocalIdTrack.get(e),i=this._pc.getSenders().find(e=>e.track===r);if(!i)throw new Error("associated RTCRtpSender not found");await i.replaceTrack(t),this._sendStream.removeTrack(r),this._sendStream.addTrack(t),this._mapSendLocalIdTrack.set(e,t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),u.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdTrack.get(e),i=this._pc.getSenders().find(e=>e.track===r);if(!i)throw new Error("associated RTCRtpSender not found");const a=i.getParameters();a.encodings.forEach((e,r)=>{e.active=r<=t}),await i.setParameters(a)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),u.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdTrack.get(e),i=this._pc.getSenders().find(e=>e.track===r);if(!i)throw new Error("associated RTCRtpSender not found");const a=i.getParameters();a.encodings.forEach((e,r)=>{a.encodings[r]={...e,...t}}),await i.setParameters(a)}async getSenderStats(e){this._assertSendDirection();const t=this._mapSendLocalIdTrack.get(e),r=this._pc.getSenders().find(e=>e.track===t);if(!r)throw new Error("associated RTCRtpSender not found");return r.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n,priority:s};u.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%h.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),u.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),u.debug("receive() [trackId:%s, kind:%s]",e,t);const i=e,n=t;this._remoteSdp.receive({mid:n,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const s={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);let o=await this._pc.createAnswer();const d=a.parse(o.sdp),l=d.media.find(e=>String(e.mid)===n);c.applyCodecParameters({offerRtpParameters:r,answerMediaObject:l}),o={type:"answer",sdp:a.write(d)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:d}),u.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);const p=this._pc.getReceivers().find(e=>e.track&&e.track.id===i);if(!p)throw new Error("new RTCRtpReceiver not");return this._mapRecvLocalIdInfo.set(i,{mid:n,rtpParameters:r,rtpReceiver:p}),{localId:i,track:p.track,rtpReceiver:p}}async stopReceiving(e){this._assertRecvDirection(),u.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e);this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const i={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);const a=await this._pc.createAnswer();u.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a)}async getReceiverStats(e){this._assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e);if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmitTime:s,maxRetransmits:o,protocol:r};u.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=c.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.Chrome67=m},{"../Logger":23,"../ortc":44,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/planBUtils":41,"sdp-transform":64}],29:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=i(e("../utils")),o=i(e("../ortc")),c=i(e("./sdp/commonUtils")),d=i(e("./sdp/unifiedPlanUtils")),l=e("./HandlerInterface"),p=e("./sdp/RemoteSdp"),u=e("../scalabilityModes"),h=new n.Logger("Chrome70"),m={OS:1024,MIS:1024};class f extends l.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new f}get name(){return"Chrome70"}close(){if(h.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){h.debug("run()"),this._direction=e,this._remoteSdp=new p.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a}),this._sendingRtpParametersByKind={audio:o.getSendingRtpParameters("audio",l),video:o.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:o.getSendingRemoteRtpParameters("audio",l),video:o.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...c},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async getNativeRtpCapabilities(){h.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(e){}const r=a.parse(t.sdp);return c.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.debug("getNativeSctpCapabilities()"),{numStreams:m}}async updateIceServers(e){h.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});h.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){this._assertSendDirection(),h.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const i=this._remoteSdp.getNextMediaSectionIdx(),n=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let o,l=await this._pc.createOffer(),p=a.parse(l.sdp);const m=s.clone(this._sendingRtpParametersByKind[e.kind]);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:p}),t&&t.length>1&&(h.debug("send() | enabling legacy simulcast"),o=(p=a.parse(l.sdp)).media[i.idx],d.addLegacySimulcast({offerMediaObject:o,numStreams:t.length}),l={type:"offer",sdp:a.write(p)});let f=!1;const g=u.parse((t||[{}])[0].scalabilityMode);t&&1===t.length&&g.spatialLayers>1&&"video/vp9"===m.codecs[0].mimeType.toLowerCase()&&(h.debug("send() | enabling legacy simulcast for VP9 SVC"),f=!0,o=(p=a.parse(l.sdp)).media[i.idx],d.addLegacySimulcast({offerMediaObject:o,numStreams:g.spatialLayers}),l={type:"offer",sdp:a.write(p)}),h.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const v=n.mid;if(m.mid=v,o=(p=a.parse(this._pc.localDescription.sdp)).media[i.idx],m.rtcp.cname=c.getCname({offerMediaObject:o}),m.encodings=d.getRtpEncodings({offerMediaObject:o}),t)for(let e=0;e<m.encodings.length;++e)t[e]&&Object.assign(m.encodings[e],t[e]);if(f&&(m.encodings=[m.encodings[0]]),m.encodings.length>1&&("video/vp8"===m.codecs[0].mimeType.toLowerCase()||"video/h264"===m.codecs[0].mimeType.toLowerCase()))for(const e of m.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:o,reuseMid:i.reuseMid,offerRtpParameters:m,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r});const b={type:"answer",sdp:this._remoteSdp.getSdp()};return h.debug("send() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.set(v,n),{localId:v,rtpParameters:m,rtpSender:n.sender}}async stopSending(e){this._assertSendDirection(),h.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);const r=await this._pc.createOffer();h.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this._assertSendDirection(),h.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((e,r)=>{e.active=r<=t}),await r.sender.setParameters(i)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((e,r)=>{i.encodings[r]={...e,...t}}),await r.sender.setParameters(i)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n,priority:s};h.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),h.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),h.debug("receive() [trackId:%s, kind:%s]",e,t);const i=String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const n={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let s=await this._pc.createAnswer();const o=a.parse(s.sdp),d=o.media.find(e=>String(e.mid)===i);c.applyCodecParameters({offerRtpParameters:r,answerMediaObject:d}),s={type:"answer",sdp:a.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:o}),h.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);const l=this._pc.getTransceivers().find(e=>e.mid===i);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(i,l),{localId:i,track:l.receiver.track,rtpReceiver:l.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const i=await this._pc.createAnswer();h.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmitTime:s,maxRetransmits:o,protocol:r};h.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=c.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.Chrome70=f},{"../Logger":23,"../ortc":44,"../scalabilityModes":45,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/unifiedPlanUtils":42,"sdp-transform":64}],30:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=i(e("../utils")),o=i(e("../ortc")),c=i(e("./sdp/commonUtils")),d=i(e("./sdp/unifiedPlanUtils")),l=e("./HandlerInterface"),p=e("./sdp/RemoteSdp"),u=e("../scalabilityModes"),h=new n.Logger("Chrome74"),m={OS:1024,MIS:1024};class f extends l.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new f}get name(){return"Chrome74"}close(){if(h.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){h.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(e){}const r=a.parse(t.sdp);return c.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.debug("getNativeSctpCapabilities()"),{numStreams:m}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){h.debug("run()"),this._direction=e,this._remoteSdp=new p.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a}),this._sendingRtpParametersByKind={audio:o.getSendingRtpParameters("audio",l),video:o.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:o.getSendingRemoteRtpParameters("audio",l),video:o.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...c},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async updateIceServers(e){h.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});h.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){this._assertSendDirection(),h.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((e,t)=>{e.rid=`r${t}`});const i=this._remoteSdp.getNextMediaSectionIdx(),n=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let o,l=await this._pc.createOffer(),p=a.parse(l.sdp);const m=s.clone(this._sendingRtpParametersByKind[e.kind]);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:p});let f=!1;const g=u.parse((t||[{}])[0].scalabilityMode);t&&1===t.length&&g.spatialLayers>1&&"video/vp9"===m.codecs[0].mimeType.toLowerCase()&&(h.debug("send() | enabling legacy simulcast for VP9 SVC"),f=!0,o=(p=a.parse(l.sdp)).media[i.idx],d.addLegacySimulcast({offerMediaObject:o,numStreams:g.spatialLayers}),l={type:"offer",sdp:a.write(p)}),h.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const v=n.mid;if(m.mid=v,o=(p=a.parse(this._pc.localDescription.sdp)).media[i.idx],m.rtcp.cname=c.getCname({offerMediaObject:o}),t)if(1===t.length){let e=d.getRtpEncodings({offerMediaObject:o});Object.assign(e[0],t[0]),f&&(e=[e[0]]),m.encodings=e}else m.encodings=t;else m.encodings=d.getRtpEncodings({offerMediaObject:o});if(m.encodings.length>1&&("video/vp8"===m.codecs[0].mimeType.toLowerCase()||"video/h264"===m.codecs[0].mimeType.toLowerCase()))for(const e of m.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:o,reuseMid:i.reuseMid,offerRtpParameters:m,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r,extmapAllowMixed:!0});const b={type:"answer",sdp:this._remoteSdp.getSdp()};return h.debug("send() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.set(v,n),{localId:v,rtpParameters:m,rtpSender:n.sender}}async stopSending(e){this._assertSendDirection(),h.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);const r=await this._pc.createOffer();h.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this._assertSendDirection(),h.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((e,r)=>{e.active=r<=t}),await r.sender.setParameters(i)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((e,r)=>{i.encodings[r]={...e,...t}}),await r.sender.setParameters(i)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n,priority:s};h.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),h.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),h.debug("receive() [trackId:%s, kind:%s]",e,t);const i=String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const n={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let s=await this._pc.createAnswer();const o=a.parse(s.sdp),d=o.media.find(e=>String(e.mid)===i);c.applyCodecParameters({offerRtpParameters:r,answerMediaObject:d}),s={type:"answer",sdp:a.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:o}),h.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);const l=this._pc.getTransceivers().find(e=>e.mid===i);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(i,l),{localId:i,track:l.receiver.track,rtpReceiver:l.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const i=await this._pc.createAnswer();h.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o,protocol:r};h.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=c.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.Chrome74=f},{"../Logger":23,"../ortc":44,"../scalabilityModes":45,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/unifiedPlanUtils":42,"sdp-transform":64}],31:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=e("../Logger"),n=e("../errors"),s=i(e("../utils")),o=i(e("../ortc")),c=i(e("./ortc/edgeUtils")),d=e("./HandlerInterface"),l=new a.Logger("Edge11");class p extends d.HandlerInterface{constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}static createFactory(){return()=>new p}get name(){return"Edge11"}close(){l.debug("close()");try{this._iceGatherer.close()}catch(e){}try{this._iceTransport.stop()}catch(e){}try{this._dtlsTransport.stop()}catch(e){}for(const e of this._rtpSenders.values())try{e.stop()}catch(e){}for(const e of this._rtpReceivers.values())try{e.stop()}catch(e){}}async getNativeRtpCapabilities(){return l.debug("getNativeRtpCapabilities()"),c.getCapabilities()}async getNativeSctpCapabilities(){return l.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:c,additionalSettings:d,proprietaryConstraints:p,extendedRtpCapabilities:u}){l.debug("run()"),this._sendingRtpParametersByKind={audio:o.getSendingRtpParameters("audio",u),video:o.getSendingRtpParameters("video",u)},this._remoteIceParameters=t,this._remoteIceCandidates=r,this._remoteDtlsParameters=i,this._cname=`CNAME-${s.generateRandomNumber()}`,this._setIceGatherer({iceServers:n,iceTransportPolicy:c}),this._setIceTransport(),this._setDtlsTransport()}async updateIceServers(e){throw new n.UnsupportedError("not supported")}async restartIce(e){if(l.debug("restartIce()"),this._remoteIceParameters=e,this._transportReady){l.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const e of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(e);this._iceTransport.addRemoteCandidate({})}}async getTransportStats(){return this._iceTransport.getStats()}async send({track:e,encodings:t,codecOptions:r}){l.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this._setupTransport({localDtlsRole:"server"}),l.debug("send() | calling new RTCRtpSender()");const i=new RTCRtpSender(e,this._dtlsTransport),a=s.clone(this._sendingRtpParametersByKind[e.kind]),n=a.codecs.some(e=>/.+\/rtx$/i.test(e.mimeType));t||(t=[{}]);for(const e of t)e.ssrc=s.generateRandomNumber(),n&&(e.rtx={ssrc:s.generateRandomNumber()});a.encodings=t,a.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const o=c.mangleRtpParameters(a);l.debug("send() | calling rtpSender.send() [params:%o]",o),await i.send(o);const d=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(d,i),{localId:d,rtpParameters:a,rtpSender:i}}async stopSending(e){l.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{l.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(e){throw l.warn("stopSending() | rtpSender.stop() failed:%o",e),e}}async replaceTrack(e,t){l.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const i=r.track;r.setTrack(t),this._rtpSenders.delete(i.id),this._rtpSenders.set(t.id,r)}async setMaxSpatialLayer(e,t){l.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((e,r)=>{e.active=r<=t}),await r.setParameters(i)}async setRtpEncodingParameters(e,t){l.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((e,r)=>{i.encodings[r]={...e,...t}}),await r.setParameters(i)}async getSenderStats(e){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}async sendDataChannel(e){throw new n.UnsupportedError("not implemented")}async receive({trackId:e,kind:t,rtpParameters:r}){l.debug("receive() [trackId:%s, kind:%s]",e,t),this._transportReady||await this._setupTransport({localDtlsRole:"server"}),l.debug("receive() | calling new RTCRtpReceiver()");const i=new RTCRtpReceiver(this._dtlsTransport,t);i.addEventListener("error",e=>{l.error('rtpReceiver "error" event [event:%o]',e)});const a=c.mangleRtpParameters(r);l.debug("receive() | calling rtpReceiver.receive() [params:%o]",a),await i.receive(a);const n=e;return this._rtpReceivers.set(n,i),{localId:n,track:i.track,rtpReceiver:i}}async stopReceiving(e){l.debug("stopReceiving() [localId:%s]",e);const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(e);try{l.debug("stopReceiving() | calling rtpReceiver.stop()"),t.stop()}catch(e){l.warn("stopReceiving() | rtpReceiver.stop() failed:%o",e)}}async getReceiverStats(e){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel(e){throw new n.UnsupportedError("not implemented")}_setIceGatherer({iceServers:e,iceTransportPolicy:t}){const r=new RTCIceGatherer({iceServers:e||[],gatherPolicy:t||"all"});r.addEventListener("error",e=>{l.error('iceGatherer "error" event [event:%o]',e)});try{r.gather()}catch(e){l.debug("_setIceGatherer() | iceGatherer.gather() failed: %s",e.toString())}this._iceGatherer=r}_setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}),e.addEventListener("icestatechange",()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}),e.addEventListener("candidatepairchange",e=>{l.debug('iceTransport "candidatepairchange" event [pair:%o]',e.pair)}),this._iceTransport=e}_setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",()=>{l.debug('dtlsTransport "statechange" event [state:%s]',e.state)}),e.addEventListener("dtlsstatechange",()=>{l.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),"closed"===e.state&&this.emit("@connectionstatechange","closed")}),e.addEventListener("error",e=>{l.error('dtlsTransport "error" event [event:%o]',e)}),this._dtlsTransport=e}async _setupTransport({localDtlsRole:e}){l.debug("_setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,await this.safeEmitAsPromise("@connect",{dtlsParameters:t}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const e of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(e);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(e=>"sha-256"===e.algorithm||"sha-384"===e.algorithm||"sha-512"===e.algorithm),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}}r.Edge11=p},{"../Logger":23,"../errors":26,"../ortc":44,"../utils":47,"./HandlerInterface":33,"./ortc/edgeUtils":37}],32:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=e("../errors"),o=i(e("../utils")),c=i(e("../ortc")),d=i(e("./sdp/commonUtils")),l=i(e("./sdp/unifiedPlanUtils")),p=e("./HandlerInterface"),u=e("./sdp/RemoteSdp"),h=new n.Logger("Firefox60"),m={OS:16,MIS:2048};class f extends p.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new f}get name(){return"Firefox60"}close(){if(h.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){h.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const r=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const i=e.addTransceiver(r,{direction:"sendrecv"}),n=i.sender.getParameters(),s=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];n.encodings=s,await i.sender.setParameters(n);const o=await e.createOffer();try{t.remove()}catch(e){}try{r.stop()}catch(e){}try{e.close()}catch(e){}const c=a.parse(o.sdp);return d.extractRtpCapabilities({sdpObject:c})}catch(i){try{t.remove()}catch(e){}try{r.stop()}catch(e){}try{e.close()}catch(e){}throw i}}async getNativeSctpCapabilities(){return h.debug("getNativeSctpCapabilities()"),{numStreams:m}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){h.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",l),video:c.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",l),video:c.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...o},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async updateIceServers(e){throw new s.UnsupportedError("not supported")}async restartIce(e){if(h.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});h.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){let i;this._assertSendDirection(),h.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&(t.forEach((e,t)=>{e.rid=`r${t}`}),i=o.clone(t).reverse());const n=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(i){const e=n.sender.getParameters();e.encodings=i,await n.sender.setParameters(e)}const s=await this._pc.createOffer();let c=a.parse(s.sdp);const p=o.clone(this._sendingRtpParametersByKind[e.kind]);this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:c}),h.debug("send() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const u=n.mid;p.mid=u;const m=(c=a.parse(this._pc.localDescription.sdp)).media[c.media.length-1];if(p.rtcp.cname=d.getCname({offerMediaObject:m}),t)if(1===t.length){const e=l.getRtpEncodings({offerMediaObject:m});Object.assign(e[0],t[0]),p.encodings=e}else p.encodings=t;else p.encodings=l.getRtpEncodings({offerMediaObject:m});if(p.encodings.length>1&&("video/vp8"===p.codecs[0].mimeType.toLowerCase()||"video/h264"===p.codecs[0].mimeType.toLowerCase()))for(const e of p.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:m,offerRtpParameters:p,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r,extmapAllowMixed:!0});const f={type:"answer",sdp:this._remoteSdp.getSdp()};return h.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(u,n),{localId:u,rtpParameters:p,rtpSender:n.sender}}async stopSending(e){h.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const r=await this._pc.createOffer();h.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this._assertSendDirection(),h.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated transceiver not found");const i=r.sender.getParameters();t=i.encodings.length-1-t,i.encodings.forEach((e,r)=>{e.active=r>=t}),await r.sender.setParameters(i)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((e,r)=>{i.encodings[r]={...e,...t}}),await r.sender.setParameters(i)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n,priority:s};h.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),h.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),h.debug("receive() [trackId:%s, kind:%s]",e,t);const i=String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const n={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let s=await this._pc.createAnswer();const o=a.parse(s.sdp),c=o.media.find(e=>String(e.mid)===i);d.applyCodecParameters({offerRtpParameters:r,answerMediaObject:c}),s={type:"answer",sdp:a.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:o}),h.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);const l=this._pc.getTransceivers().find(e=>e.mid===i);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(i,l),{localId:i,track:l.receiver.track,rtpReceiver:l.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const i=await this._pc.createAnswer();h.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o,protocol:r};h.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=d.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.Firefox60=f},{"../Logger":23,"../errors":26,"../ortc":44,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/unifiedPlanUtils":42,"sdp-transform":64}],33:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const i=e("../EnhancedEventEmitter");r.HandlerInterface=class extends i.EnhancedEventEmitter{constructor(){super()}}},{"../EnhancedEventEmitter":22}],34:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=e("../errors"),o=i(e("../utils")),c=i(e("../ortc")),d=i(e("./sdp/commonUtils")),l=i(e("./sdp/planBUtils")),p=e("./HandlerInterface"),u=e("./sdp/RemoteSdp"),h=new n.Logger("ReactNative"),m={OS:1024,MIS:1024};class f extends p.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new f}get name(){return"ReactNative"}close(){if(h.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){h.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=a.parse(t.sdp);return d.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.debug("getNativeSctpCapabilities()"),{numStreams:m}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){h.debug("run()"),this._direction=e,this._remoteSdp=new u.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",l),video:c.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",l),video:c.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...o},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async updateIceServers(e){h.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});h.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){this._assertSendDirection(),h.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let i,n=await this._pc.createOffer(),s=a.parse(n.sdp);const c=o.clone(this._sendingRtpParametersByKind[e.kind]);if(this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:s}),"video"===e.kind&&t&&t.length>1&&(h.debug("send() | enabling simulcast"),i=(s=a.parse(n.sdp)).media.find(e=>"video"===e.type),l.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:a.write(s)}),h.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),i=(s=a.parse(this._pc.localDescription.sdp)).media.find(t=>t.type===e.kind),c.rtcp.cname=d.getCname({offerMediaObject:i}),c.encodings=l.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<c.encodings.length;++e)t[e]&&Object.assign(c.encodings[e],t[e]);if(c.encodings.length>1&&("video/vp8"===c.codecs[0].mimeType.toLowerCase()||"video/h264"===c.codecs[0].mimeType.toLowerCase()))for(const e of c.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:c,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r});const p={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setRemoteDescription(p);const u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:c}}async stopSending(e){this._assertSendDirection(),h.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();h.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(e){if(0===this._sendStream.getTracks().length)return void h.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){throw new s.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new s.UnsupportedError("not implemented")}async setRtpEncodingParameters(e,t){throw new s.UnsupportedError("not implemented")}async getSenderStats(e){throw new s.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n,priority:s};h.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%m.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),h.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),h.debug("receive() [trackId:%s, kind:%s]",e,t);const i=e,n=t;let s=r.rtcp.cname;h.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),s+=`-hack-${o.generateRandomNumber()}`,this._remoteSdp.receive({mid:n,kind:t,offerRtpParameters:r,streamId:s,trackId:e});const c={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);let l=await this._pc.createAnswer();const p=a.parse(l.sdp),u=p.media.find(e=>String(e.mid)===n);d.applyCodecParameters({offerRtpParameters:r,answerMediaObject:u}),l={type:"answer",sdp:a.write(p)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:p}),h.debug("receive() | calling pc.setLocalDescription() [answer:%o]",l),await this._pc.setLocalDescription(l);const m=this._pc.getRemoteStreams().find(e=>e.id===s).getTrackById(i);if(!m)throw new Error("remote track not found");return this._mapRecvLocalIdInfo.set(i,{mid:n,rtpParameters:r}),{localId:i,track:m}}async stopReceiving(e){this._assertRecvDirection(),h.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e);this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const i={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);const a=await this._pc.createAnswer();h.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a)}async getReceiverStats(e){throw new s.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmitTime:s,maxRetransmits:o,protocol:r};h.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}h.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=d.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.ReactNative=f},{"../Logger":23,"../errors":26,"../ortc":44,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/planBUtils":41,"sdp-transform":64}],35:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=i(e("../utils")),o=i(e("../ortc")),c=i(e("./sdp/commonUtils")),d=i(e("./sdp/planBUtils")),l=e("./HandlerInterface"),p=e("./sdp/RemoteSdp"),u=new n.Logger("Safari11"),h={OS:1024,MIS:1024};class m extends l.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new m}get name(){return"Safari11"}close(){if(u.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){u.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=a.parse(t.sdp);return c.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return u.debug("getNativeSctpCapabilities()"),{numStreams:h}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){u.debug("run()"),this._direction=e,this._remoteSdp=new p.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:o.getSendingRtpParameters("audio",l),video:o.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:o.getSendingRemoteRtpParameters("audio",l),video:o.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...c},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async updateIceServers(e){u.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(u.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});u.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();u.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){this._assertSendDirection(),u.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let i,n=await this._pc.createOffer(),o=a.parse(n.sdp);const l=s.clone(this._sendingRtpParametersByKind[e.kind]);if(this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:o}),"video"===e.kind&&t&&t.length>1&&(u.debug("send() | enabling simulcast"),i=(o=a.parse(n.sdp)).media.find(e=>"video"===e.type),d.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:a.write(o)}),u.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),i=(o=a.parse(this._pc.localDescription.sdp)).media.find(t=>t.type===e.kind),l.rtcp.cname=c.getCname({offerMediaObject:i}),l.encodings=d.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<l.encodings.length;++e)t[e]&&Object.assign(l.encodings[e],t[e]);if(l.encodings.length>1&&"video/vp8"===l.codecs[0].mimeType.toLowerCase())for(const e of l.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:l,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r});const p={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setRemoteDescription(p);const h=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(h,e),{localId:h,rtpParameters:l,rtpSender:this._pc.getSenders().find(t=>t.track===e)}}async stopSending(e){this._assertSendDirection();const t=this._mapSendLocalIdTrack.get(e),r=this._pc.getSenders().find(e=>e.track===t);if(!r)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(r),this._sendStream.removeTrack(t),this._mapSendLocalIdTrack.delete(e);const i=await this._pc.createOffer();u.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{await this._pc.setLocalDescription(i)}catch(e){if(0===this._sendStream.getTracks().length)return void u.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const a={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async replaceTrack(e,t){this._assertSendDirection(),u.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id);const r=this._mapSendLocalIdTrack.get(e),i=this._pc.getSenders().find(e=>e.track===r);if(!i)throw new Error("associated RTCRtpSender not found");await i.replaceTrack(t),this._sendStream.removeTrack(r),this._sendStream.addTrack(t),this._mapSendLocalIdTrack.set(e,t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),u.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdTrack.get(e),i=this._pc.getSenders().find(e=>e.track===r);if(!i)throw new Error("associated RTCRtpSender not found");const a=i.getParameters();a.encodings.forEach((e,r)=>{e.active=r<=t}),await i.setParameters(a)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),u.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdTrack.get(e),i=this._pc.getSenders().find(e=>e.track===r);if(!i)throw new Error("associated RTCRtpSender not found");const a=i.getParameters();a.encodings.forEach((e,r)=>{a.encodings[r]={...e,...t}}),await i.setParameters(a)}async getSenderStats(e){this._assertSendDirection();const t=this._mapSendLocalIdTrack.get(e),r=this._pc.getSenders().find(e=>e.track===t);if(!r)throw new Error("associated RTCRtpSender not found");return r.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n,priority:s};u.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%h.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),u.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),u.debug("receive() [trackId:%s, kind:%s]",e,t);const i=e,n=t;this._remoteSdp.receive({mid:n,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const s={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);let o=await this._pc.createAnswer();const d=a.parse(o.sdp),l=d.media.find(e=>String(e.mid)===n);c.applyCodecParameters({offerRtpParameters:r,answerMediaObject:l}),o={type:"answer",sdp:a.write(d)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:d}),u.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);const p=this._pc.getReceivers().find(e=>e.track&&e.track.id===i);if(!p)throw new Error("new RTCRtpReceiver not");return this._mapRecvLocalIdInfo.set(i,{mid:n,rtpParameters:r,rtpReceiver:p}),{localId:i,track:p.track,rtpReceiver:p}}async stopReceiving(e){this._assertRecvDirection(),u.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e);this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const i={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);const a=await this._pc.createAnswer();u.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a)}async getReceiverStats(e){this._assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e);if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o,protocol:r};u.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=c.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.Safari11=m},{"../Logger":23,"../ortc":44,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/planBUtils":41,"sdp-transform":64}],36:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../Logger"),s=i(e("../utils")),o=i(e("../ortc")),c=i(e("./sdp/commonUtils")),d=i(e("./sdp/unifiedPlanUtils")),l=e("./HandlerInterface"),p=e("./sdp/RemoteSdp"),u=new n.Logger("Safari12"),h={OS:1024,MIS:1024};class m extends l.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new m}get name(){return"Safari12"}close(){if(u.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){u.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(e){}const r=a.parse(t.sdp);return c.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return u.debug("getNativeSctpCapabilities()"),{numStreams:h}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a,iceServers:n,iceTransportPolicy:s,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:l}){u.debug("run()"),this._direction=e,this._remoteSdp=new p.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:a}),this._sendingRtpParametersByKind={audio:o.getSendingRtpParameters("audio",l),video:o.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:o.getSendingRemoteRtpParameters("audio",l),video:o.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection({iceServers:n||[],iceTransportPolicy:s||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...c},d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})}async updateIceServers(e){u.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(u.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});u.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();u.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r}){this._assertSendDirection(),u.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const i=this._remoteSdp.getNextMediaSectionIdx(),n=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let o,l=await this._pc.createOffer(),p=a.parse(l.sdp);const h=s.clone(this._sendingRtpParametersByKind[e.kind]);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:p}),t&&t.length>1&&(u.debug("send() | enabling legacy simulcast"),o=(p=a.parse(l.sdp)).media[i.idx],d.addLegacySimulcast({offerMediaObject:o,numStreams:t.length}),l={type:"offer",sdp:a.write(p)}),u.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const m=n.mid;if(h.mid=m,o=(p=a.parse(this._pc.localDescription.sdp)).media[i.idx],h.rtcp.cname=c.getCname({offerMediaObject:o}),h.encodings=d.getRtpEncodings({offerMediaObject:o}),t)for(let e=0;e<h.encodings.length;++e)t[e]&&Object.assign(h.encodings[e],t[e]);if(h.encodings.length>1&&("video/vp8"===h.codecs[0].mimeType.toLowerCase()||"video/h264"===h.codecs[0].mimeType.toLowerCase()))for(const e of h.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:o,reuseMid:i.reuseMid,offerRtpParameters:h,answerRtpParameters:this._sendingRemoteRtpParametersByKind[e.kind],codecOptions:r});const f={type:"answer",sdp:this._remoteSdp.getSdp()};return u.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(m,n),{localId:m,rtpParameters:h,rtpSender:n.sender}}async stopSending(e){this._assertSendDirection(),u.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);const r=await this._pc.createOffer();u.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this._assertSendDirection(),u.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),u.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((e,r)=>{e.active=r<=t}),await r.sender.setParameters(i)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),u.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((e,r)=>{i.encodings[r]={...e,...t}}),await r.sender.setParameters(i)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n,priority:s}){this._assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n,priority:s};u.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%h.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=a.parse(e.sdp),r=t.media.find(e=>"application"===e.type);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),u.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const i={type:"answer",sdp:this._remoteSdp.getSdp()};u.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._hasDataChannelMediaSection=!0}return{dataChannel:c,sctpStreamParameters:{streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),u.debug("receive() [trackId:%s, kind:%s]",e,t);const i=String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const n={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let s=await this._pc.createAnswer();const o=a.parse(s.sdp),d=o.media.find(e=>String(e.mid)===i);c.applyCodecParameters({offerRtpParameters:r,answerMediaObject:d}),s={type:"answer",sdp:a.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:o}),u.debug("receive() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);const l=this._pc.getTransceivers().find(e=>e.mid===i);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(i,l),{localId:i,track:l.receiver.track,rtpReceiver:l.receiver}}async stopReceiving(e){this._assertRecvDirection(),u.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const i=await this._pc.createAnswer();u.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:s,maxRetransmits:o,protocol:r};u.debug("receiveDataChannel() [options:%o]",c);const d=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=a.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}u.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=a.parse(this._pc.localDescription.sdp));const r=c.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}r.Safari12=m},{"../Logger":23,"../ortc":44,"../utils":47,"./HandlerInterface":33,"./sdp/RemoteSdp":39,"./sdp/commonUtils":40,"./sdp/unifiedPlanUtils":42,"sdp-transform":64}],37:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("../../utils"));r.getCapabilities=function(){const e=RTCRtpReceiver.getCapabilities(),t=a.clone(e);for(const e of t.codecs){if(e.channels=e.numChannels,delete e.numChannels,e.mimeType=e.mimeType||`${e.kind}/${e.name}`,e.parameters){const t=e.parameters;t.apt&&(t.apt=Number(t.apt)),t["packetization-mode"]&&(t["packetization-mode"]=Number(t["packetization-mode"]))}for(const t of e.rtcpFeedback||[])t.parameter||(t.parameter="")}return t},r.mangleRtpParameters=function(e){const t=a.clone(e);t.mid&&(t.muxId=t.mid,delete t.mid);for(const e of t.codecs)e.channels&&(e.numChannels=e.channels,delete e.channels),e.mimeType&&!e.name&&(e.name=e.mimeType.split("/")[1]),delete e.mimeType;return t}},{"../../utils":47}],38:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("../../utils"));class n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:i=!1}){if(this._mediaObject={},this._planB=i,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const e of t){const t={component:1};t.foundation=e.foundation,t.ip=e.ip,t.port=e.port,t.priority=e.priority,t.transport=e.protocol,t.type=e.type,e.tcpType&&(t.tcptype=e.tcpType),this._mediaObject.candidates.push(t)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}r&&this.setDtlsRole(r.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return 0===this._mediaObject.port}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}disable(){this._mediaObject.direction="inactive",delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}}r.MediaSection=n;r.AnswerMediaSection=class extends n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:n,planB:o=!1,offerMediaObject:c,offerRtpParameters:d,answerRtpParameters:l,codecOptions:p,extmapAllowMixed:u=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:o}),this._mediaObject.mid=String(c.mid),this._mediaObject.type=c.type,this._mediaObject.protocol=c.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),c.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const e of l.codecs){const t={payload:e.payloadType,codec:s(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const r=a.clone(e.parameters||{});if(p){const{opusStereo:t,opusFec:i,opusDtx:a,opusMaxPlaybackRate:n,opusPtime:s,videoGoogleStartBitrate:o,videoGoogleMaxBitrate:c,videoGoogleMinBitrate:l}=p,u=d.codecs.find(t=>t.payloadType===e.payloadType);switch(e.mimeType.toLowerCase()){case"audio/opus":void 0!==t&&(u.parameters["sprop-stereo"]=t?1:0,r.stereo=t?1:0),void 0!==i&&(u.parameters.useinbandfec=i?1:0,r.useinbandfec=i?1:0),void 0!==a&&(u.parameters.usedtx=a?1:0,r.usedtx=a?1:0),void 0!==n&&(r.maxplaybackrate=n),void 0!==s&&(u.parameters.ptime=s,r.ptime=s);break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":void 0!==o&&(r["x-google-start-bitrate"]=o),void 0!==c&&(r["x-google-max-bitrate"]=c),void 0!==l&&(r["x-google-min-bitrate"]=l)}}const i={payload:e.payloadType,config:""};for(const e of Object.keys(r))i.config&&(i.config+=";"),i.config+=`${e}=${r[e]}`;i.config&&this._mediaObject.fmtp.push(i);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=l.codecs.map(e=>e.payloadType).join(" "),this._mediaObject.ext=[];for(const e of l.headerExtensions)(c.ext||[]).some(t=>t.uri===e.uri)&&this._mediaObject.ext.push({uri:e.uri,value:e.id});if(u&&"extmap-allow-mixed"===c.extmapAllowMixed&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),c.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:c.simulcast.list1},this._mediaObject.rids=[];for(const e of c.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}else if(c.simulcast_03){this._mediaObject.simulcast_03={value:c.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const e of c.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&"video"===this._mediaObject.type&&(this._mediaObject.xGoogleFlag="conference");break;case"application":"number"==typeof c.sctpPort?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):c.sctpmap&&(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize})}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}};function s(e){const t=new RegExp("^(audio|video)/(.+)","i").exec(e.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}r.OfferMediaSection=class extends n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:a,planB:n=!1,mid:o,kind:c,offerRtpParameters:d,streamId:l,trackId:p,oldDataChannelSpec:u=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:n}),this._mediaObject.mid=String(o),this._mediaObject.type=c,a?(this._mediaObject.connection={ip:a.ip,version:a.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=a.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=i?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),c){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${p}`);for(const e of d.codecs){const t={payload:e.payloadType,codec:s(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const r={payload:e.payloadType,config:""};for(const t of Object.keys(e.parameters))r.config&&(r.config+=";"),r.config+=`${t}=${e.parameters[t]}`;r.config&&this._mediaObject.fmtp.push(r);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=d.codecs.map(e=>e.payloadType).join(" "),this._mediaObject.ext=[];for(const e of d.headerExtensions)this._mediaObject.ext.push({uri:e.uri,value:e.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const e=d.encodings[0],t=e.ssrc,r=e.rtx&&e.rtx.ssrc?e.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],d.rtcp.cname&&this._mediaObject.ssrcs.push({id:t,attribute:"cname",value:d.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:t,attribute:"msid",value:`${l||"-"} ${p}`}),r&&(d.rtcp.cname&&this._mediaObject.ssrcs.push({id:r,attribute:"cname",value:d.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:r,attribute:"msid",value:`${l||"-"} ${p}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${r}`}));break}case"application":u?(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize)}}setDtlsRole(e){this._mediaObject.setup="actpass"}planBReceive({offerRtpParameters:e,streamId:t,trackId:r}){const i=e.encodings[0],a=i.ssrc,n=i.rtx&&i.rtx.ssrc?i.rtx.ssrc:void 0;e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${r}`}),n&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${t||"-"} ${r}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${a} ${n}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],r=t.ssrc,i=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(e=>e.id!==r&&e.id!==i),i&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(e=>e.ssrcs!==`${r} ${i}`))}}},{"../../utils":47}],39:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform")),n=e("../../Logger"),s=e("./MediaSection"),o=new n.Logger("RemoteSdp");r.RemoteSdp=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:a,planB:n=!1}){if(this._mediaSections=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=r,this._sctpParameters=i,this._plainRtpParameters=a,this._planB=n,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),r){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const e=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:r.fingerprints[e-1].algorithm,hash:r.fingerprints[e-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}a&&(this._sdpObject.origin.address=a.ip,this._sdpObject.origin.ipVer=a.ipVersion)}updateIceParameters(e){o.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections.values())t.setIceParameters(e)}updateDtlsRole(e){o.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections.values())t.setDtlsRole(e)}getNextMediaSectionIdx(){let e=-1;for(const t of this._mediaSections.values())if(e++,t.closed)return{idx:e,reuseMid:t.mid};return{idx:this._mediaSections.size}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:r,answerRtpParameters:i,codecOptions:a,extmapAllowMixed:n=!1}){const o=new s.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:r,answerRtpParameters:i,codecOptions:a,extmapAllowMixed:n});t?this._replaceMediaSection(o,t):this._mediaSections.has(o.mid)?this._replaceMediaSection(o):this._addMediaSection(o)}receive({mid:e,kind:t,offerRtpParameters:r,streamId:i,trackId:a}){if(this._mediaSections.has(e)){const t=this._mediaSections.get(e);t.planBReceive({offerRtpParameters:r,streamId:i,trackId:a}),this._replaceMediaSection(t)}else{const n=new s.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:r,streamId:i,trackId:a});this._addMediaSection(n)}}disableMediaSection(e){this._mediaSections.get(e).disable()}closeMediaSection(e){const t=this._mediaSections.get(e);if(String(e)===this._firstMid)return o.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),void this.disableMediaSection(e);t.close(),this._regenerateBundleMids()}planBStopReceiving({mid:e,offerRtpParameters:t}){const r=this._mediaSections.get(e);r.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(r)}sendSctpAssociation({offerMediaObject:e}){const t=new s.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new s.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,a.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.set(e.mid,e),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(t){const r=new Map;for(const i of this._mediaSections.values())i.mid===t?r.set(e.mid,e):r.set(i.mid,i);this._mediaSections=r,this._regenerateBundleMids()}else this._mediaSections.set(e.mid,e);this._sdpObject.media=Array.from(this._mediaSections.values()).map(e=>e.getObject())}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=Array.from(this._mediaSections.values()).filter(e=>!e.closed).map(e=>e.mid).join(" "))}}},{"../../Logger":23,"./MediaSection":38,"sdp-transform":64}],40:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("sdp-transform"));r.extractRtpCapabilities=function({sdpObject:e}){const t=new Map,r=[];let i=!1,n=!1;for(const s of e.media){const e=s.type;switch(e){case"audio":if(i)continue;i=!0;break;case"video":if(n)continue;n=!0;break;default:continue}for(const r of s.rtp){const i={kind:e,mimeType:`${e}/${r.codec}`,preferredPayloadType:r.payload,clockRate:r.rate,channels:r.encoding,parameters:{},rtcpFeedback:[]};t.set(i.preferredPayloadType,i)}for(const e of s.fmtp||[]){const r=a.parseParams(e.config),i=t.get(e.payload);i&&(r&&r["profile-level-id"]&&(r["profile-level-id"]=String(r["profile-level-id"])),i.parameters=r)}for(const e of s.rtcpFb||[]){const r=t.get(e.payload);if(!r)continue;const i={type:e.type,parameter:e.subtype};i.parameter||delete i.parameter,r.rtcpFeedback.push(i)}for(const t of s.ext||[]){const i={kind:e,uri:t.uri,preferredId:t.value};r.push(i)}}return{codecs:Array.from(t.values()),headerExtensions:r}},r.extractDtlsParameters=function({sdpObject:e}){const t=(e.media||[]).find(e=>e.iceUfrag&&0!==e.port);if(!t)throw new Error("no active media section found");const r=t.fingerprint||e.fingerprint;let i;switch(t.setup){case"active":i="client";break;case"passive":i="server";break;case"actpass":i="auto"}return{role:i,fingerprints:[{algorithm:r.type,value:r.hash}]}},r.getCname=function({offerMediaObject:e}){const t=(e.ssrcs||[]).find(e=>"cname"===e.attribute);return t?t.value:""},r.applyCodecParameters=function({offerRtpParameters:e,answerMediaObject:t}){for(const r of e.codecs){const e=r.mimeType.toLowerCase();if("audio/opus"!==e)continue;if(!(t.rtp||[]).find(e=>e.payload===r.payloadType))continue;t.fmtp=t.fmtp||[];let i=t.fmtp.find(e=>e.payload===r.payloadType);i||(i={payload:r.payloadType,config:""},t.fmtp.push(i));const n=a.parseParams(i.config);switch(e){case"audio/opus":{const e=r.parameters["sprop-stereo"];void 0!==e&&(n.stereo=e?1:0);break}}i.config="";for(const e of Object.keys(n))i.config&&(i.config+=";"),i.config+=`${e}=${n[e]}`}}},{"sdp-transform":64}],41:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getRtpEncodings=function({offerMediaObject:e,track:t}){let r;const i=new Set;for(const a of e.ssrcs||[])if("msid"===a.attribute&&a.value.split(" ")[1]===t.id){const e=a.id;i.add(e),r||(r=e)}if(0===i.size)throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);const a=new Map;for(const t of e.ssrcGroups||[]){if("FID"!==t.semantics)continue;let[e,r]=t.ssrcs.split(/\s+/);e=Number(e),r=Number(r),i.has(e)&&(i.delete(e),i.delete(r),a.set(e,r))}for(const e of i)a.set(e,null);const n=[];for(const[e,t]of a){const r={ssrc:e};t&&(r.rtx={ssrc:t}),n.push(r)}return n},r.addLegacySimulcast=function({offerMediaObject:e,track:t,numStreams:r}){if(r<=1)throw new TypeError("numStreams must be greater than 1");let i,a,n;if(!(e.ssrcs||[]).find(e=>"msid"===e.attribute&&(e.value.split(" ")[1]===t.id&&(i=e.id,n=e.value.split(" ")[0],!0))))throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);(e.ssrcGroups||[]).some(e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===i&&(a=Number(t[1]),!0)});const s=e.ssrcs.find(e=>"cname"===e.attribute&&e.id===i);if(!s)throw new Error(`a=ssrc line with cname information not found [track.id:${t.id}]`);const o=s.value,c=[],d=[];for(let e=0;e<r;++e)c.push(i+e),a&&d.push(a+e);e.ssrcGroups=e.ssrcGroups||[],e.ssrcs=e.ssrcs||[],e.ssrcGroups.push({semantics:"SIM",ssrcs:c.join(" ")});for(let r=0;r<c.length;++r){const i=c[r];e.ssrcs.push({id:i,attribute:"cname",value:o}),e.ssrcs.push({id:i,attribute:"msid",value:`${n} ${t.id}`})}for(let r=0;r<d.length;++r){const i=c[r],a=d[r];e.ssrcs.push({id:a,attribute:"cname",value:o}),e.ssrcs.push({id:a,attribute:"msid",value:`${n} ${t.id}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${a}`})}}},{}],42:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getRtpEncodings=function({offerMediaObject:e}){const t=new Set;for(const r of e.ssrcs||[]){const e=r.id;t.add(e)}if(0===t.size)throw new Error("no a=ssrc lines found");const r=new Map;for(const i of e.ssrcGroups||[]){if("FID"!==i.semantics)continue;let[e,a]=i.ssrcs.split(/\s+/);e=Number(e),a=Number(a),t.has(e)&&(t.delete(e),t.delete(a),r.set(e,a))}for(const e of t)r.set(e,null);const i=[];for(const[e,t]of r){const r={ssrc:e};t&&(r.rtx={ssrc:t}),i.push(r)}return i},r.addLegacySimulcast=function({offerMediaObject:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");const r=(e.ssrcs||[]).find(e=>"msid"===e.attribute);if(!r)throw new Error("a=ssrc line with msid information not found");const[i,a]=r.value.split(" ")[0],n=r.id;let s;(e.ssrcGroups||[]).some(e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===n&&(s=Number(t[1]),!0)});const o=e.ssrcs.find(e=>"cname"===e.attribute);if(!o)throw new Error("a=ssrc line with cname information not found");const c=o.value,d=[],l=[];for(let e=0;e<t;++e)d.push(n+e),s&&l.push(s+e);e.ssrcGroups=[],e.ssrcs=[],e.ssrcGroups.push({semantics:"SIM",ssrcs:d.join(" ")});for(let t=0;t<d.length;++t){const r=d[t];e.ssrcs.push({id:r,attribute:"cname",value:c}),e.ssrcs.push({id:r,attribute:"msid",value:`${i} ${a}`})}for(let t=0;t<l.length;++t){const r=d[t],n=l[t];e.ssrcs.push({id:n,attribute:"cname",value:c}),e.ssrcs.push({id:n,attribute:"msid",value:`${i} ${a}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${r} ${n}`})}}},{}],43:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=e("./Device");r.Device=a.Device,r.detectDevice=a.detectDevice;const n=i(e("./types"));r.types=n,r.version="3.3.18";var s=e("./scalabilityModes");r.parseScalabilityMode=s.parse},{"./Device":21,"./scalabilityModes":45,"./types":46}],44:[function(e,t,r){"use strict";var i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const a=i(e("h264-profile-level-id")),n=1234;function s(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const r=t.exec(e.mimeType);if(!r)throw new TypeError("invalid codec.mimeType");if(e.kind=r[1].toLowerCase(),e.preferredPayloadType&&"number"!=typeof e.preferredPayloadType)throw new TypeError("invalid codec.preferredPayloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"number"!=typeof e.channels&&(e.channels=1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let r=e.parameters[t];if(void 0===r&&(e.parameters[t]="",r=""),"string"!=typeof r&&"number"!=typeof r)throw new TypeError(`invalid codec parameter [key:${t}s, value:${r}]`);if("apt"===t&&"number"!=typeof r)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)o(t)}function o(e){if("object"!=typeof e)throw new TypeError("fb is not an object");if(!e.type||"string"!=typeof e.type)throw new TypeError("missing fb.type");e.parameter&&"string"==typeof e.parameter||(e.parameter="")}function c(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(e.kind&&"string"==typeof e.kind||(e.kind=""),""!==e.kind&&"audio"!==e.kind&&"video"!==e.kind)throw new TypeError("invalid ext.kind");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.preferredId)throw new TypeError("missing ext.preferredId");if(e.preferredEncrypt&&"boolean"!=typeof e.preferredEncrypt)throw new TypeError("invalid ext.preferredEncrypt");if(e.preferredEncrypt||(e.preferredEncrypt=!1),e.direction&&"string"!=typeof e.direction)throw new TypeError("invalid ext.direction");e.direction||(e.direction="sendrecv")}function d(e){if("object"!=typeof e)throw new TypeError("params is not an object");if(e.mid&&"string"!=typeof e.mid)throw new TypeError("params.mid is not a string");if(!Array.isArray(e.codecs))throw new TypeError("missing params.codecs");for(const t of e.codecs)l(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("params.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)p(t);if(e.encodings&&!Array.isArray(e.encodings))throw new TypeError("params.encodings is not an array");e.encodings||(e.encodings=[]);for(const t of e.encodings)u(t);if(e.rtcp&&"object"!=typeof e.rtcp)throw new TypeError("params.rtcp is not an object");e.rtcp||(e.rtcp={}),h(e.rtcp)}function l(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");if(!t.exec(e.mimeType))throw new TypeError("invalid codec.mimeType");if("number"!=typeof e.payloadType)throw new TypeError("missing codec.payloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"number"!=typeof e.channels&&(e.channels=1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let r=e.parameters[t];if(void 0===r&&(e.parameters[t]="",r=""),"string"!=typeof r&&"number"!=typeof r)throw new TypeError(`invalid codec parameter [key:${t}s, value:${r}]`);if("apt"===t&&"number"!=typeof r)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)o(t)}function p(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.id)throw new TypeError("missing ext.id");if(e.encrypt&&"boolean"!=typeof e.encrypt)throw new TypeError("invalid ext.encrypt");e.encrypt||(e.encrypt=!1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let r=e.parameters[t];if(void 0===r&&(e.parameters[t]="",r=""),"string"!=typeof r&&"number"!=typeof r)throw new TypeError("invalid header extension parameter")}}function u(e){if("object"!=typeof e)throw new TypeError("encoding is not an object");if(e.ssrc&&"number"!=typeof e.ssrc)throw new TypeError("invalid encoding.ssrc");if(e.rid&&"string"!=typeof e.rid)throw new TypeError("invalid encoding.rid");if(e.rtx&&"object"!=typeof e.rtx)throw new TypeError("invalid encoding.rtx");if(e.rtx&&"number"!=typeof e.rtx.ssrc)throw new TypeError("missing encoding.rtx.ssrc");if(e.dtx&&"boolean"==typeof e.dtx||(e.dtx=!1),e.scalabilityMode&&"string"!=typeof e.scalabilityMode)throw new TypeError("invalid encoding.scalabilityMode")}function h(e){if("object"!=typeof e)throw new TypeError("rtcp is not an object");if(e.cname&&"string"!=typeof e.cname)throw new TypeError("invalid rtcp.cname");e.reducedSize&&"boolean"==typeof e.reducedSize||(e.reducedSize=!0)}function m(e){if("object"!=typeof e)throw new TypeError("numStreams is not an object");if("number"!=typeof e.OS)throw new TypeError("missing numStreams.OS");if("number"!=typeof e.MIS)throw new TypeError("missing numStreams.MIS")}function f(e){return/.+\/rtx$/i.test(e.mimeType)}function g(e,t,{strict:r=!1,modify:i=!1}={}){const n=e.mimeType.toLowerCase();if(n!==t.mimeType.toLowerCase())return!1;if(e.clockRate!==t.clockRate)return!1;if(e.channels!==t.channels)return!1;switch(n){case"video/h264":if((e.parameters["packetization-mode"]||0)!==(t.parameters["packetization-mode"]||0))return!1;if(r){if(!a.isSameProfile(e.parameters,t.parameters))return!1;let r;try{r=a.generateProfileLevelIdForAnswer(e.parameters,t.parameters)}catch(e){return!1}i&&(r?e.parameters["profile-level-id"]=r:delete e.parameters["profile-level-id"])}break;case"video/vp9":if(r){if((e.parameters["profile-id"]||0)!==(t.parameters["profile-id"]||0))return!1}}return!0}function v(e,t){return(!e.kind||!t.kind||e.kind===t.kind)&&e.uri===t.uri}function b(e,t){const r=[];for(const i of e.rtcpFeedback||[]){const e=(t.rtcpFeedback||[]).find(e=>e.type===i.type&&(e.parameter===i.parameter||!e.parameter&&!i.parameter));e&&r.push(e)}return r}r.validateRtpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(e.codecs&&!Array.isArray(e.codecs))throw new TypeError("caps.codecs is not an array");e.codecs||(e.codecs=[]);for(const t of e.codecs)s(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)c(t)},r.validateRtpCodecCapability=s,r.validateRtcpFeedback=o,r.validateRtpHeaderExtension=c,r.validateRtpParameters=d,r.validateRtpCodecParameters=l,r.validateRtpHeaderExtensionParameters=p,r.validateRtpEncodingParameters=u,r.validateRtcpParameters=h,r.validateSctpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(!e.numStreams||"object"!=typeof e.numStreams)throw new TypeError("missing caps.numStreams");m(e.numStreams)},r.validateNumSctpStreams=m,r.validateSctpParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.port)throw new TypeError("missing params.port");if("number"!=typeof e.OS)throw new TypeError("missing params.OS");if("number"!=typeof e.MIS)throw new TypeError("missing params.MIS");if("number"!=typeof e.maxMessageSize)throw new TypeError("missing params.maxMessageSize")},r.validateSctpStreamParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.streamId)throw new TypeError("missing params.streamId");let t=!1;if("boolean"==typeof e.ordered?t=!0:e.ordered=!0,e.maxPacketLifeTime&&"number"!=typeof e.maxPacketLifeTime)throw new TypeError("invalid params.maxPacketLifeTime");if(e.maxRetransmits&&"number"!=typeof e.maxRetransmits)throw new TypeError("invalid params.maxRetransmits");if(e.maxPacketLifeTime&&e.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(t&&e.ordered&&(e.maxPacketLifeTime||e.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(t||!e.maxPacketLifeTime&&!e.maxRetransmits||(e.ordered=!1),e.priority&&"string"!=typeof e.priority)throw new TypeError("invalid params.priority");if(e.label&&"string"!=typeof e.label)throw new TypeError("invalid params.label");if(e.protocol&&"string"!=typeof e.protocol)throw new TypeError("invalid params.protocol")},r.getExtendedRtpCapabilities=function(e,t){const r={codecs:[],headerExtensions:[]};for(const i of t.codecs||[]){if(f(i))continue;const t=(e.codecs||[]).find(e=>g(e,i,{strict:!0,modify:!0}));if(!t)continue;const a={mimeType:t.mimeType,kind:t.kind,clockRate:t.clockRate,channels:t.channels,localPayloadType:t.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:i.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:t.parameters,remoteParameters:i.parameters,rtcpFeedback:b(t,i)};r.codecs.push(a)}for(const i of r.codecs){const r=e.codecs.find(e=>f(e)&&e.parameters.apt===i.localPayloadType),a=t.codecs.find(e=>f(e)&&e.parameters.apt===i.remotePayloadType);r&&a&&(i.localRtxPayloadType=r.preferredPayloadType,i.remoteRtxPayloadType=a.preferredPayloadType)}for(const i of t.headerExtensions){const t=e.headerExtensions.find(e=>v(e,i));if(!t)continue;const a={kind:i.kind,uri:i.uri,sendId:t.preferredId,recvId:i.preferredId,encrypt:t.preferredEncrypt,direction:"sendrecv"};switch(i.direction){case"sendrecv":a.direction="sendrecv";break;case"recvonly":a.direction="sendonly";break;case"sendonly":a.direction="recvonly";break;case"inactive":a.direction="inactive"}r.headerExtensions.push(a)}return r},r.getRecvRtpCapabilities=function(e){const t={codecs:[],headerExtensions:[]};for(const r of e.codecs){const e={mimeType:r.mimeType,kind:r.kind,preferredPayloadType:r.remotePayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(t.codecs.push(e),!r.remoteRtxPayloadType)continue;const i={mimeType:`${r.kind}/rtx`,kind:r.kind,preferredPayloadType:r.remoteRtxPayloadType,clockRate:r.clockRate,channels:1,parameters:{apt:r.remotePayloadType},rtcpFeedback:[]};t.codecs.push(i)}for(const r of e.headerExtensions){if("sendrecv"!==r.direction&&"recvonly"!==r.direction)continue;const e={kind:r.kind,uri:r.uri,preferredId:r.recvId,preferredEncrypt:r.encrypt,direction:r.direction};t.headerExtensions.push(e)}return t},r.getSendingRtpParameters=function(e,t){const r={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const i of t.codecs){if(i.kind!==e)continue;const t={mimeType:i.mimeType,payloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.localParameters,rtcpFeedback:i.rtcpFeedback};if(r.codecs.push(t),i.localRtxPayloadType){const e={mimeType:`${i.kind}/rtx`,payloadType:i.localRtxPayloadType,clockRate:i.clockRate,channels:1,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};r.codecs.push(e)}break}for(const i of t.headerExtensions){if(i.kind&&i.kind!==e||"sendrecv"!==i.direction&&"sendonly"!==i.direction)continue;const t={uri:i.uri,id:i.sendId,encrypt:i.encrypt,parameters:{}};r.headerExtensions.push(t)}return r},r.getSendingRemoteRtpParameters=function(e,t){const r={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const i of t.codecs){if(i.kind!==e)continue;const t={mimeType:i.mimeType,payloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.remoteParameters,rtcpFeedback:i.rtcpFeedback};if(r.codecs.push(t),i.localRtxPayloadType){const e={mimeType:`${i.kind}/rtx`,payloadType:i.localRtxPayloadType,clockRate:i.clockRate,channels:1,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};r.codecs.push(e)}break}for(const i of t.headerExtensions){if(i.kind&&i.kind!==e||"sendrecv"!==i.direction&&"sendonly"!==i.direction)continue;const t={uri:i.uri,id:i.sendId,encrypt:i.encrypt,parameters:{}};r.headerExtensions.push(t)}if(r.headerExtensions.some(e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri))for(const e of r.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"goog-remb"!==e.type);else if(r.headerExtensions.some(e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri))for(const e of r.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type);else for(const e of r.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type&&"goog-remb"!==e.type);return r},r.generateProbatorRtpParameters=function(e){d(e);const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{cname:"probator"}};return t.codecs.push(e.codecs[0]),t.headerExtensions=e.headerExtensions.filter(e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri||"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri),t.encodings.push({ssrc:n}),t},r.canSend=function(e,t){return t.codecs.some(t=>t.kind===e)},r.canReceive=function(e,t){if(d(e),0===e.codecs.length)return!1;const r=e.codecs[0];return t.codecs.some(e=>e.remotePayloadType===r.payloadType)}},{"h264-profile-level-id":16}],45:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});const i=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");r.parse=function(e){const t=i.exec(e);return t?{spatialLayers:Number(t[1]),temporalLayers:Number(t[2])}:{spatialLayers:1,temporalLayers:1}}},{}],46:[function(e,t,r){"use strict";function i(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}Object.defineProperty(r,"__esModule",{value:!0}),i(e("./Device")),i(e("./Transport")),i(e("./Producer")),i(e("./Consumer")),i(e("./DataProducer")),i(e("./DataConsumer")),i(e("./handlers/HandlerInterface")),i(e("./errors"))},{"./Consumer":18,"./DataConsumer":19,"./DataProducer":20,"./Device":21,"./Producer":24,"./Transport":25,"./errors":26,"./handlers/HandlerInterface":33}],47:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.clone=function(e){return"object"!=typeof e?{}:JSON.parse(JSON.stringify(e))},r.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},{}],48:[function(e,t,r){arguments[4][10][0].apply(r,arguments)},{dup:10}],49:[function(e,t,r){var i,a,n=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function c(e){if(i===setTimeout)return setTimeout(e,0);if((i===s||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:s}catch(e){i=s}try{a="function"==typeof clearTimeout?clearTimeout:o}catch(e){a=o}}();var d,l=[],p=!1,u=-1;function h(){p&&d&&(p=!1,d.length?l=d.concat(l):u=-1,l.length&&m())}function m(){if(!p){var e=c(h);p=!0;for(var t=l.length;t;){for(d=l,l=[];++u<t;)d&&d[u].run();u=-1,t=l.length}d=null,p=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===o||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function g(){}n.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];l.push(new f(e,t)),1!==l.length||p||c(m)},f.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=g,n.addListener=g,n.once=g,n.off=g,n.removeListener=g,n.removeAllListeners=g,n.emit=g,n.prependListener=g,n.prependOnceListener=g,n.listeners=function(e){return[]},n.binding=function(e){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(e){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},{}],50:[function(e,t,r){const{EventEmitter:i}=e("events"),a=e("./Logger");t.exports=class extends i{constructor(e){super(),this.setMaxListeners(1/0),this._logger=e||new a("EnhancedEventEmitter")}safeEmit(e,...t){try{this.emit(e,...t)}catch(t){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",e,t)}}async safeEmitAsPromise(e,...t){return new Promise((r,i)=>{this.safeEmit(e,...t,r,i)})}}},{"./Logger":51,events:11}],51:[function(e,t,r){const i=e("debug"),a="protoo-client";t.exports=class{constructor(e){e?(this._debug=i(`${a}:${e}`),this._warn=i(`${a}:WARN:${e}`),this._error=i(`${a}:ERROR:${e}`)):(this._debug=i(a),this._warn=i(`${a}:WARN`),this._error=i(`${a}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}},{debug:13}],52:[function(e,t,r){const i=e("./Logger"),{generateRandomNumber:a}=e("./utils"),n=new i("Message");t.exports=class{static parse(e){let t;const r={};try{t=JSON.parse(e)}catch(e){return void n.error("parse() | invalid JSON: %s",e)}if("object"==typeof t&&!Array.isArray(t)){if(t.request){if(r.request=!0,"string"!=typeof t.method)return void n.error("parse() | missing/invalid method field");if("number"!=typeof t.id)return void n.error("parse() | missing/invalid id field");r.id=t.id,r.method=t.method,r.data=t.data||{}}else if(t.response){if(r.response=!0,"number"!=typeof t.id)return void n.error("parse() | missing/invalid id field");r.id=t.id,t.ok?(r.ok=!0,r.data=t.data||{}):(r.ok=!1,r.errorCode=t.errorCode,r.errorReason=t.errorReason)}else{if(!t.notification)return void n.error("parse() | missing request/response field");if(r.notification=!0,"string"!=typeof t.method)return void n.error("parse() | missing/invalid method field");r.method=t.method,r.data=t.data||{}}return r}n.error("parse() | not an object")}static createRequest(e,t){return{request:!0,id:a(),method:e,data:t||{}}}static createSuccessResponse(e,t){return{response:!0,id:e.id,ok:!0,data:t||{}}}static createErrorResponse(e,t,r){return{response:!0,id:e.id,ok:!1,errorCode:t,errorReason:r}}static createNotification(e,t){return{notification:!0,method:e,data:t||{}}}}},{"./Logger":51,"./utils":56}],53:[function(e,t,r){const i=e("./Logger"),a=e("./EnhancedEventEmitter"),n=e("./Message"),s=new i("Peer");t.exports=class extends a{constructor(e){super(s),s.debug("constructor()"),this._closed=!1,this._transport=e,this._connected=!1,this._data={},this._sents=new Map,this._handleTransport()}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(e){throw new Error("cannot override data object")}close(){if(!this._closed){s.debug("close()"),this._closed=!0,this._connected=!1,this._transport.close();for(const e of this._sents.values())e.close();this.safeEmit("close")}}async request(e,t){const r=n.createRequest(e,t);return this._logger.debug("request() [method:%s, id:%s]",e,r.id),await this._transport.send(r),new Promise((e,t)=>{const i=1500*(15+.1*this._sents.size),a={id:r.id,method:r.method,resolve:t=>{this._sents.delete(r.id)&&(clearTimeout(a.timer),e(t))},reject:e=>{this._sents.delete(r.id)&&(clearTimeout(a.timer),t(e))},timer:setTimeout(()=>{this._sents.delete(r.id)&&t(new Error("request timeout"))},i),close:()=>{clearTimeout(a.timer),t(new Error("peer closed"))}};this._sents.set(r.id,a)})}async notify(e,t){const r=n.createNotification(e,t);this._logger.debug("notify() [method:%s]",e),await this._transport.send(r)}_handleTransport(){if(this._transport.closed)return this._closed=!0,void setTimeout(()=>{this._closed||(this._connected=!1,this.safeEmit("close"))});this._transport.on("open",()=>{this._closed||(s.debug('emit "open"'),this._connected=!0,this.safeEmit("open"))}),this._transport.on("disconnected",()=>{this._closed||(s.debug('emit "disconnected"'),this._connected=!1,this.safeEmit("disconnected"))}),this._transport.on("failed",e=>{this._closed||(s.debug('emit "failed" [currentAttempt:%s]',e),this._connected=!1,this.safeEmit("failed",e))}),this._transport.on("close",()=>{this._closed||(this._closed=!0,s.debug('emit "close"'),this._connected=!1,this.safeEmit("close"))}),this._transport.on("message",e=>{e.request?this._handleRequest(e):e.response?this._handleResponse(e):e.notification&&this._handleNotification(e)})}_handleRequest(e){try{this.emit("request",e,t=>{const r=n.createSuccessResponse(e,t);this._transport.send(r).catch(()=>{})},(t,r)=>{t instanceof Error?(t=500,r=String(t)):"number"==typeof t&&r instanceof Error&&(r=String(r));const i=n.createErrorResponse(e,t,r);this._transport.send(i).catch(()=>{})})}catch(t){const r=n.createErrorResponse(e,500,String(t));this._transport.send(r).catch(()=>{})}}_handleResponse(e){const t=this._sents.get(e.id);if(t)if(e.ok)t.resolve(e.data);else{const r=new Error(e.errorReason);r.code=e.errorCode,t.reject(r)}else s.error("received response does not match any sent request [id:%s]",e.id)}_handleNotification(e){this.safeEmit("notification",e)}}},{"./EnhancedEventEmitter":50,"./Logger":51,"./Message":52}],54:[function(e,t,r){const{version:i}=e("../package.json"),a=e("./Peer"),n=e("./transports/WebSocketTransport");r.version=i,r.Peer=a,r.WebSocketTransport=n},{"../package.json":57,"./Peer":53,"./transports/WebSocketTransport":55}],55:[function(e,t,r){const i=e("websocket").w3cwebsocket,a=e("retry"),n=e("../Logger"),s=e("../EnhancedEventEmitter"),o=e("../Message"),c="protoo",d={retries:10,factor:2,minTimeout:1e3,maxTimeout:8e3},l=new n("WebSocketTransport");t.exports=class extends s{constructor(e,t){super(l),l.debug("constructor() [url:%s, options:%o]",e,t),this._closed=!1,this._url=e,this._options=t||{},this._ws=null,this._runWebSocket()}get closed(){return this._closed}close(){if(!this._closed){l.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close()}catch(e){l.error("close() | error closing the WebSocket: %o",e)}}}async send(e){if(this._closed)throw new Error("transport closed");try{this._ws.send(JSON.stringify(e))}catch(e){throw l.warn("send() failed:%o",e),e}}_runWebSocket(){const e=a.operation(this._options.retry||d);let t=!1;e.attempt(r=>{this._closed?e.stop():(l.debug("_runWebSocket() [currentAttempt:%s]",r),this._ws=new i(this._url,c,this._options.origin,this._options.headers,this._options.requestOptions,this._options.clientConfig),this._ws.onopen=(()=>{this._closed||(t=!0,this.safeEmit("open"))}),this._ws.onclose=(i=>{if(!this._closed){if(l.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',i.wasClean,i.code,i.reason),4e3!==i.code){if(t){if(e.stop(),this.safeEmit("disconnected"),this._closed)return;return void this._runWebSocket()}if(this.safeEmit("failed",r),this._closed)return;if(e.retry(!0))return}this._closed=!0,this.safeEmit("close")}}),this._ws.onerror=(()=>{this._closed||l.error('WebSocket "error" event')}),this._ws.onmessage=(e=>{if(this._closed)return;const t=o.parse(e.data);t&&(0!==this.listenerCount("message")?this.safeEmit("message",t):l.error('no listeners for WebSocket "message" event, ignoring received message'))}))})}}},{"../EnhancedEventEmitter":50,"../Logger":51,"../Message":52,retry:60,websocket:67}],56:[function(e,t,r){r.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},{}],57:[function(e,t,r){t.exports={_args:[["protoo-client@4.0.3","/Users/Liuzq/project/node/SDK3/jssdk-v3"]],_from:"protoo-client@4.0.3",_id:"protoo-client@4.0.3",_inBundle:!1,_integrity:"sha512-+HnxpBOOZ8WovllUUvfcbJa3gLuzhyYdR4A+ytldLmwq6vl5AzFGsenyLJMX6pVuNEJUZ5D7M92zvPesUG+wyQ==",_location:"/protoo-client",_phantomChildren:{},_requested:{type:"version",registry:!0,raw:"protoo-client@4.0.3",name:"protoo-client",escapedName:"protoo-client",rawSpec:"4.0.3",saveSpec:null,fetchSpec:"4.0.3"},_requiredBy:["/"],_resolved:"https://registry.npmjs.org/protoo-client/-/protoo-client-4.0.3.tgz",_spec:"4.0.3",_where:"/Users/Liuzq/project/node/SDK3/jssdk-v3",author:{name:"Iñaki Baz Castillo",email:"ibc@aliax.net"},bugs:{url:"https://github.com/ibc/protoo/issues"},dependencies:{debug:"^4.1.1",events:"^3.0.0",retry:"^0.12.0",websocket:"^1.0.28"},description:"protoo JavaScript client module",devDependencies:{eslint:"^5.16.0"},engines:{node:">=8.0.0"},homepage:"https://protoojs.org",keywords:["nodejs","browser","websocket"],license:"MIT",main:"lib/index.js",name:"protoo-client",optionalDependencies:{websocket:"^1.0.28"},repository:{type:"git",url:"git+https://github.com/ibc/protoo.git"},scripts:{lint:"eslint -c .eslintrc.js lib"},version:"4.0.3"}},{}],58:[function(e,t,r){(function(e,r){"use strict";function i(e,t){if(!e)throw"First parameter is required.";t=new a(e,t=t||{type:"video"});var r=this;function s(r){r&&(t.initCallback=function(){r(),r=t.initCallback=null});var i=new n(e,t);(h=new i(e,t)).record(),p("recording"),t.disableLogs||console.log("Initialized recorderType:",h.constructor.name,"for output-type:",t.type)}function o(e){if(e=e||function(){},h){if("paused"===r.state)return r.resumeRecording(),void setTimeout(function(){o(e)},1);"recording"===r.state||t.disableLogs||console.warn('Recording state should be: "recording", however current state is: ',r.state),t.disableLogs||console.log("Stopped recording "+t.type+" stream."),"gif"!==t.type?h.stop(i):(h.stop(),i()),p("stopped")}else f();function i(i){if(h){Object.keys(h).forEach(function(e){"function"!=typeof h[e]&&(r[e]=h[e])});var a=h.blob;if(!a){if(!i)throw"Recording failed.";h.blob=a=i}if(a&&!t.disableLogs&&console.log(a.type,"->",_(a.size)),e){var n;try{n=u.createObjectURL(a)}catch(e){}"function"==typeof e.call?e.call(r,n):e(n)}t.autoWriteToDisk&&d(function(e){var r={};r[t.type+"Blob"]=e,L.Store(r)})}else"function"==typeof e.call?e.call(r,""):e("")}}function c(e){postMessage((new FileReaderSync).readAsDataURL(e))}function d(e,r){if(!e)throw"Pass a callback function over getDataURL.";var i=r?r.blob:(h||{}).blob;if(!i)return t.disableLogs||console.warn("Blob encoder did not finish its job yet."),void setTimeout(function(){d(e,r)},1e3);if("undefined"==typeof Worker||navigator.mozGetUserMedia){var a=new FileReader;a.readAsDataURL(i),a.onload=function(t){e(t.target.result)}}else{var n=function(e){try{var t=u.createObjectURL(new Blob([e.toString(),"this.onmessage =  function (eee) {"+e.name+"(eee.data);}"],{type:"application/javascript"})),r=new Worker(t);return u.revokeObjectURL(t),r}catch(e){}}(c);n.onmessage=function(t){e(t.data)},n.postMessage(i)}}function l(e){e=e||0,"paused"!==r.state?"stopped"!==r.state&&(e>=r.recordingDuration?o(r.onRecordingStopped):(e+=1e3,setTimeout(function(){l(e)},1e3))):setTimeout(function(){l(e)},1e3)}function p(e){r&&(r.state=e,"function"==typeof r.onStateChanged.call?r.onStateChanged.call(r,e):r.onStateChanged(e))}var h,m='It seems that recorder is destroyed or "startRecording" is not invoked for '+t.type+" recorder.";function f(){!0!==t.disableLogs&&console.warn(m)}var g={startRecording:function(i){return t.disableLogs||console.log("RecordRTC version: ",r.version),i&&(t=new a(e,i)),t.disableLogs||console.log("started recording "+t.type+" stream."),h?(h.clearRecordedData(),h.record(),p("recording"),r.recordingDuration&&l(),r):(s(function(){r.recordingDuration&&l()}),r)},stopRecording:o,pauseRecording:function(){h?"recording"===r.state?(p("paused"),h.pause(),t.disableLogs||console.log("Paused recording.")):t.disableLogs||console.warn("Unable to pause the recording. Recording state: ",r.state):f()},resumeRecording:function(){h?"paused"===r.state?(p("recording"),h.resume(),t.disableLogs||console.log("Resumed recording.")):t.disableLogs||console.warn("Unable to resume the recording. Recording state: ",r.state):f()},initRecorder:s,setRecordingDuration:function(e,t){if(void 0===e)throw"recordingDuration is required.";if("number"!=typeof e)throw"recordingDuration must be a number.";return r.recordingDuration=e,r.onRecordingStopped=t||function(){},{onRecordingStopped:function(e){r.onRecordingStopped=e}}},clearRecordedData:function(){h?(h.clearRecordedData(),t.disableLogs||console.log("Cleared old recorded data.")):f()},getBlob:function(){if(h)return h.blob;f()},getDataURL:d,toURL:function(){if(h)return u.createObjectURL(h.blob);f()},getInternalRecorder:function(){return h},save:function(e){h?y(h.blob,e):f()},getFromDisk:function(e){h?i.getFromDisk(t.type,e):f()},setAdvertisementArray:function(e){t.advertisement=[];for(var r=e.length,i=0;i<r;i++)t.advertisement.push({duration:i,image:e[i]})},blob:null,bufferSize:0,sampleRate:0,buffer:null,reset:function(){"recording"!==r.state||t.disableLogs||console.warn("Stop an active recorder."),h&&"function"==typeof h.clearRecordedData&&h.clearRecordedData(),h=null,p("inactive"),r.blob=null},onStateChanged:function(e){t.disableLogs||console.log("Recorder state changed:",e)},state:"inactive",getState:function(){return r.state},destroy:function(){var e=t.disableLogs;t={disableLogs:!0},r.reset(),p("destroyed"),g=r=null,k.AudioContextConstructor&&(k.AudioContextConstructor.close(),k.AudioContextConstructor=null),t.disableLogs=e,t.disableLogs||console.log("RecordRTC is destroyed.")},version:"5.5.8"};if(!this)return r=g,g;for(var v in g)this[v]=g[v];return r=this,g}function a(e,t){return t.recorderType||t.type||(t.audio&&t.video?t.type="video":t.audio&&!t.video&&(t.type="audio")),t.recorderType&&!t.type&&(t.recorderType===x||t.recorderType===D||t.recorderType===j?t.type="video":t.recorderType===E?t.type="gif":t.recorderType===C?t.type="audio":t.recorderType===T&&(S(e,"audio").length&&S(e,"video").length?t.type="video":!S(e,"audio").length&&S(e,"video").length?t.type="video":S(e,"audio").length&&!S(e,"video").length&&(t.type="audio"))),"undefined"!=typeof MediaRecorder&&"requestData"in MediaRecorder.prototype&&(t.mimeType||(t.mimeType="video/webm"),t.type||(t.type=t.mimeType.split("/")[0]),t.bitsPerSecond),t.type||(t.mimeType&&(t.type=t.mimeType.split("/")[0]),t.type||(t.type="audio")),t}function n(e,t){var r;return(g||h||m)&&(r=C),"undefined"!=typeof MediaRecorder&&"requestData"in MediaRecorder.prototype&&!g&&(r=T),"video"===t.type&&(g||m)&&(r=x,"undefined"!=typeof ReadableStream&&(r=j)),"gif"===t.type&&(r=E),"canvas"===t.type&&(r=D),P()&&r!==D&&r!==E&&"undefined"!=typeof MediaRecorder&&"requestData"in MediaRecorder.prototype&&(S(e,"video").length||S(e,"audio").length)&&("audio"===t.type?"function"==typeof MediaRecorder.isTypeSupported&&MediaRecorder.isTypeSupported("audio/webm")&&(r=T):"function"==typeof MediaRecorder.isTypeSupported&&MediaRecorder.isTypeSupported("video/webm")&&(r=T)),e instanceof Array&&e.length&&(r=O),t.recorderType&&(r=t.recorderType),!t.disableLogs&&r&&r.name&&console.log("Using recorderType:",r.name||r.constructor.name),!r&&v&&(r=T),r}function s(e){this.addStream=function(t){t&&(e=t)},this.mediaType={audio:!0,video:!0},this.startRecording=function(){var t,r=this.mediaType,a=this.mimeType||{audio:null,video:null,gif:null};if("function"!=typeof r.audio&&P()&&!S(e,"audio").length&&(r.audio=!1),"function"!=typeof r.video&&P()&&!S(e,"video").length&&(r.video=!1),"function"!=typeof r.gif&&P()&&!S(e,"video").length&&(r.gif=!1),!r.audio&&!r.video&&!r.gif)throw"MediaStream must have either audio or video tracks.";if(r.audio&&(t=null,"function"==typeof r.audio&&(t=r.audio),this.audioRecorder=new i(e,{type:"audio",bufferSize:this.bufferSize,sampleRate:this.sampleRate,numberOfAudioChannels:this.numberOfAudioChannels||2,disableLogs:this.disableLogs,recorderType:t,mimeType:a.audio,timeSlice:this.timeSlice,onTimeStamp:this.onTimeStamp}),r.video||this.audioRecorder.startRecording()),r.video){t=null,"function"==typeof r.video&&(t=r.video);var n=e;if(P()&&r.audio&&"function"==typeof r.audio){var s=S(e,"video")[0];f?((n=new b).addTrack(s),t&&t===x&&(t=T)):(n=new b).addTrack(s)}this.videoRecorder=new i(n,{type:"video",video:this.video,canvas:this.canvas,frameInterval:this.frameInterval||10,disableLogs:this.disableLogs,recorderType:t,mimeType:a.video,timeSlice:this.timeSlice,onTimeStamp:this.onTimeStamp,workerPath:this.workerPath,webAssemblyPath:this.webAssemblyPath,frameRate:this.frameRate,bitrate:this.bitrate}),r.audio||this.videoRecorder.startRecording()}if(r.audio&&r.video){var o=this,c=!0===P();r.audio instanceof C&&r.video?c=!1:!0!==r.audio&&!0!==r.video&&r.audio!==r.video&&(c=!1),!0===c?(o.audioRecorder=null,o.videoRecorder.startRecording()):o.videoRecorder.initRecorder(function(){o.audioRecorder.initRecorder(function(){o.videoRecorder.startRecording(),o.audioRecorder.startRecording()})})}r.gif&&(t=null,"function"==typeof r.gif&&(t=r.gif),this.gifRecorder=new i(e,{type:"gif",frameRate:this.frameRate||200,quality:this.quality||10,disableLogs:this.disableLogs,recorderType:t,mimeType:a.gif}),this.gifRecorder.startRecording())},this.stopRecording=function(e){e=e||function(){},this.audioRecorder&&this.audioRecorder.stopRecording(function(t){e(t,"audio")}),this.videoRecorder&&this.videoRecorder.stopRecording(function(t){e(t,"video")}),this.gifRecorder&&this.gifRecorder.stopRecording(function(t){e(t,"gif")})},this.pauseRecording=function(){this.audioRecorder&&this.audioRecorder.pauseRecording(),this.videoRecorder&&this.videoRecorder.pauseRecording(),this.gifRecorder&&this.gifRecorder.pauseRecording()},this.resumeRecording=function(){this.audioRecorder&&this.audioRecorder.resumeRecording(),this.videoRecorder&&this.videoRecorder.resumeRecording(),this.gifRecorder&&this.gifRecorder.resumeRecording()},this.getBlob=function(e){var t={};return this.audioRecorder&&(t.audio=this.audioRecorder.getBlob()),this.videoRecorder&&(t.video=this.videoRecorder.getBlob()),this.gifRecorder&&(t.gif=this.gifRecorder.getBlob()),e&&e(t),t},this.destroy=function(){this.audioRecorder&&(this.audioRecorder.destroy(),this.audioRecorder=null),this.videoRecorder&&(this.videoRecorder.destroy(),this.videoRecorder=null),this.gifRecorder&&(this.gifRecorder.destroy(),this.gifRecorder=null)},this.getDataURL=function(e){function t(e,t){if("undefined"!=typeof Worker){var r=function(e){var t,r=u.createObjectURL(new Blob([e.toString(),"this.onmessage =  function (eee) {"+e.name+"(eee.data);}"],{type:"application/javascript"})),i=new Worker(r);if(void 0!==u)t=u;else{if("undefined"==typeof webkitURL)throw"Neither URL nor webkitURL detected.";t=webkitURL}return t.revokeObjectURL(r),i}(function(e){postMessage((new FileReaderSync).readAsDataURL(e))});r.onmessage=function(e){t(e.data)},r.postMessage(e)}else{var i=new FileReader;i.readAsDataURL(e),i.onload=function(e){t(e.target.result)}}}this.getBlob(function(r){r.audio&&r.video?t(r.audio,function(i){t(r.video,function(t){e({audio:i,video:t})})}):r.audio?t(r.audio,function(t){e({audio:t})}):r.video&&t(r.video,function(t){e({video:t})})})},this.writeToDisk=function(){i.writeToDisk({audio:this.audioRecorder,video:this.videoRecorder,gif:this.gifRecorder})},this.save=function(e){(e=e||{audio:!0,video:!0,gif:!0}).audio&&this.audioRecorder&&this.audioRecorder.save("string"==typeof e.audio?e.audio:""),e.video&&this.videoRecorder&&this.videoRecorder.save("string"==typeof e.video?e.video:""),e.gif&&this.gifRecorder&&this.gifRecorder.save("string"==typeof e.gif?e.gif:"")}}i.version="5.5.8",void 0!==t&&(t.exports=i),"function"==typeof define&&define.amd&&define("RecordRTC",[],function(){return i}),i.getFromDisk=function(e,t){if(!t)throw"callback is mandatory.";console.log("Getting recorded "+("all"===e?"blobs":e+" blob ")+" from disk!"),L.Fetch(function(r,i){"all"!==e&&i===e+"Blob"&&t&&t(r),"all"===e&&t&&t(r,i.replace("Blob",""))})},i.writeToDisk=function(e){console.log("Writing recorded blob(s) to disk!"),(e=e||{}).audio&&e.video&&e.gif?e.audio.getDataURL(function(t){e.video.getDataURL(function(r){e.gif.getDataURL(function(e){L.Store({audioBlob:t,videoBlob:r,gifBlob:e})})})}):e.audio&&e.video?e.audio.getDataURL(function(t){e.video.getDataURL(function(e){L.Store({audioBlob:t,videoBlob:e})})}):e.audio&&e.gif?e.audio.getDataURL(function(t){e.gif.getDataURL(function(e){L.Store({audioBlob:t,gifBlob:e})})}):e.video&&e.gif?e.video.getDataURL(function(t){e.gif.getDataURL(function(e){L.Store({videoBlob:t,gifBlob:e})})}):e.audio?e.audio.getDataURL(function(e){L.Store({audioBlob:e})}):e.video?e.video.getDataURL(function(e){L.Store({videoBlob:e})}):e.gif&&e.gif.getDataURL(function(e){L.Store({gifBlob:e})})},s.getFromDisk=i.getFromDisk,s.writeToDisk=i.writeToDisk,i.MRecordRTC=s;var o;(o=void 0!==r?r:null)&&"undefined"==typeof window&&void 0!==r&&(r.navigator={userAgent:"Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45",getUserMedia:function(){}},r.console||(r.console={}),void 0!==r.console.log&&void 0!==r.console.error||(r.console.error=r.console.log=r.console.log||function(){console.log(arguments)}),"undefined"==typeof document&&(o.document={documentElement:{appendChild:function(){return""}}},document.createElement=document.captureStream=document.mozCaptureStream=function(){var e={getContext:function(){return e},play:function(){},pause:function(){},drawImage:function(){},toDataURL:function(){return""},style:{}};return e},o.HTMLVideoElement=function(){}),"undefined"==typeof location&&(o.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(o.screen={width:0,height:0}),void 0===u&&(o.URL={createObjectURL:function(){return""},revokeObjectURL:function(){return""}}),o.window=r);var c=window.requestAnimationFrame;if(void 0===c)if("undefined"!=typeof webkitRequestAnimationFrame)c=webkitRequestAnimationFrame;else if("undefined"!=typeof mozRequestAnimationFrame)c=mozRequestAnimationFrame;else if("undefined"!=typeof msRequestAnimationFrame)c=msRequestAnimationFrame;else if(void 0===c){var d=0;c=function(e,t){var r=(new Date).getTime(),i=Math.max(0,16-(r-d)),a=setTimeout(function(){e(r+i)},i);return d=r+i,a}}var l=window.cancelAnimationFrame;void 0===l&&("undefined"!=typeof webkitCancelAnimationFrame?l=webkitCancelAnimationFrame:"undefined"!=typeof mozCancelAnimationFrame?l=mozCancelAnimationFrame:"undefined"!=typeof msCancelAnimationFrame?l=msCancelAnimationFrame:void 0===l&&(l=function(e){clearTimeout(e)}));var p=window.AudioContext;void 0===p&&("undefined"!=typeof webkitAudioContext&&(p=webkitAudioContext),"undefined"!=typeof mozAudioContext&&(p=mozAudioContext));var u=window.URL;void 0===u&&"undefined"!=typeof webkitURL&&(u=webkitURL),"undefined"!=typeof navigator&&void 0===navigator.getUserMedia&&(void 0!==navigator.webkitGetUserMedia&&(navigator.getUserMedia=navigator.webkitGetUserMedia),void 0!==navigator.mozGetUserMedia&&(navigator.getUserMedia=navigator.mozGetUserMedia));var h=!(-1===navigator.userAgent.indexOf("Edge")||!navigator.msSaveBlob&&!navigator.msSaveOrOpenBlob),m=!!window.opera||-1!==navigator.userAgent.indexOf("OPR/"),f=navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&"netscape"in window&&/ rv:/.test(navigator.userAgent),g=!m&&!h&&!!navigator.webkitGetUserMedia||w()||-1!==navigator.userAgent.toLowerCase().indexOf("chrome/"),v=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);v&&!g&&-1!==navigator.userAgent.indexOf("CriOS")&&(v=!1,g=!0);var b=window.MediaStream;function _(e){if(0===e)return"0 Bytes";var t=parseInt(Math.floor(Math.log(e)/Math.log(1e3)),10);return(e/Math.pow(1e3,t)).toPrecision(3)+" "+["Bytes","KB","MB","GB","TB"][t]}function y(e,t){if(!e)throw"Blob object is required.";if(!e.type)try{e.type="video/webm"}catch(e){}var r=(e.type||"video/webm").split("/")[1];if(t&&-1!==t.indexOf(".")){var i=t.split(".");t=i[0],r=i[1]}var a=(t||Math.round(9999999999*Math.random())+888888888)+"."+r;if(void 0!==navigator.msSaveOrOpenBlob)return navigator.msSaveOrOpenBlob(e,a);if(void 0!==navigator.msSaveBlob)return navigator.msSaveBlob(e,a);var n=document.createElement("a");n.href=u.createObjectURL(e),n.download=a,n.style="display:none;opacity:0;color:transparent;",(document.body||document.documentElement).appendChild(n),"function"==typeof n.click?n.click():(n.target="_blank",n.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))),u.revokeObjectURL(n.href)}function w(){return"undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type||(!(void 0===e||"object"!=typeof e.versions||!e.versions.electron)||"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0)}function S(e,t){return e&&e.getTracks?e.getTracks().filter(function(e){return e.kind===(t||"audio")}):[]}function R(e,t){"srcObject"in t?t.srcObject=e:"mozSrcObject"in t?t.mozSrcObject=e:t.srcObject=e}void 0===b&&"undefined"!=typeof webkitMediaStream&&(b=webkitMediaStream),void 0!==b&&void 0===b.prototype.stop&&(b.prototype.stop=function(){this.getTracks().forEach(function(e){e.stop()})}),i.invokeSaveAsDialog=y,i.getTracks=S,i.getSeekableBlob=function(e,t){if("undefined"==typeof EBML)throw new Error("Please link: https://cdn.webrtc-experiment.com/EBML.js");var r=new EBML.Reader,i=new EBML.Decoder,a=EBML.tools,n=new FileReader;n.onload=function(e){i.decode(this.result).forEach(function(e){r.read(e)}),r.stop();var n=a.makeMetadataSeekable(r.metadatas,r.duration,r.cues),s=this.result.slice(r.metadataSize),o=new Blob([n,s],{type:"video/webm"});t(o)},n.readAsArrayBuffer(e)},i.bytesToSize=_,i.isElectron=w;var k={};function P(){if(f||v||h)return!0;navigator.appVersion;var e,t,r=navigator.userAgent,i=""+parseFloat(navigator.appVersion),a=parseInt(navigator.appVersion,10);return(g||m)&&(e=r.indexOf("Chrome"),i=r.substring(e+7)),-1!==(t=i.indexOf(";"))&&(i=i.substring(0,t)),-1!==(t=i.indexOf(" "))&&(i=i.substring(0,t)),a=parseInt(""+i,10),isNaN(a)&&(i=""+parseFloat(navigator.appVersion),a=parseInt(navigator.appVersion,10)),a>=49}function T(e,t){var r=this;if(void 0===e)throw'First argument "MediaStream" is required.';if("undefined"==typeof MediaRecorder)throw"Your browser does not support the Media Recorder API. Please try other modules e.g. WhammyRecorder or StereoAudioRecorder.";if("audio"===(t=t||{mimeType:"video/webm"}).type){var i;if(S(e,"video").length&&S(e,"audio").length)navigator.mozGetUserMedia?(i=new b).addTrack(S(e,"audio")[0]):i=new b(S(e,"audio")),e=i;t.mimeType&&-1!==t.mimeType.toString().toLowerCase().indexOf("audio")||(t.mimeType=g?"audio/webm":"audio/ogg"),t.mimeType&&"audio/ogg"!==t.mimeType.toString().toLowerCase()&&navigator.mozGetUserMedia&&(t.mimeType="audio/ogg")}var a,n=[];function s(){r.timestamps.push((new Date).getTime()),"function"==typeof t.onTimeStamp&&t.onTimeStamp(r.timestamps[r.timestamps.length-1],r.timestamps)}function o(e){return a&&a.mimeType?a.mimeType:e.mimeType||"video/webm"}function c(){n=[],a=null,r.timestamps=[]}this.getArrayOfBlobs=function(){return n},this.record=function(){r.blob=null,r.clearRecordedData(),r.timestamps=[],d=[],n=[];var i=t;t.disableLogs||console.log("Passing following config over MediaRecorder API.",i),a&&(a=null),g&&!P()&&(i="video/vp8"),"function"==typeof MediaRecorder.isTypeSupported&&i.mimeType&&(MediaRecorder.isTypeSupported(i.mimeType)||(t.disableLogs||console.warn("MediaRecorder API seems unable to record mimeType:",i.mimeType),i.mimeType="audio"===t.type?"audio/webm":"video/webm"));try{a=new MediaRecorder(e,i),t.mimeType=i.mimeType}catch(t){a=new MediaRecorder(e)}i.mimeType&&!MediaRecorder.isTypeSupported&&"canRecordMimeType"in a&&!1===a.canRecordMimeType(i.mimeType)&&(t.disableLogs||console.warn("MediaRecorder API seems unable to record mimeType:",i.mimeType)),a.ondataavailable=function(e){if(e.data&&d.push("ondataavailable: "+_(e.data.size)),"number"!=typeof t.timeSlice)!e.data||!e.data.size||e.data.size<100||r.blob?r.recordingCallback&&(r.recordingCallback(new Blob([],{type:o(i)})),r.recordingCallback=null):(r.blob=t.getNativeBlob?e.data:new Blob([e.data],{type:o(i)}),r.recordingCallback&&(r.recordingCallback(r.blob),r.recordingCallback=null));else if(e.data&&e.data.size&&e.data.size>100&&(n.push(e.data),s(),"function"==typeof t.ondataavailable)){var a=t.getNativeBlob?e.data:new Blob([e.data],{type:o(i)});t.ondataavailable(a)}},a.onstart=function(){d.push("started")},a.onpause=function(){d.push("paused")},a.onresume=function(){d.push("resumed")},a.onstop=function(){d.push("stopped")},a.onerror=function(e){e&&(e.name||(e.name="UnknownError"),d.push("error: "+e),t.disableLogs||(-1!==e.name.toString().toLowerCase().indexOf("invalidstate")?console.error("The MediaRecorder is not in a state in which the proposed operation is allowed to be executed.",e):-1!==e.name.toString().toLowerCase().indexOf("notsupported")?console.error("MIME type (",i.mimeType,") is not supported.",e):-1!==e.name.toString().toLowerCase().indexOf("security")?console.error("MediaRecorder security error",e):"OutOfMemory"===e.name?console.error("The UA has exhaused the available memory. User agents SHOULD provide as much additional information as possible in the message attribute.",e):"IllegalStreamModification"===e.name?console.error("A modification to the stream has occurred that makes it impossible to continue recording. An example would be the addition of a Track while recording is occurring. User agents SHOULD provide as much additional information as possible in the message attribute.",e):"OtherRecordingError"===e.name?console.error("Used for an fatal error other than those listed above. User agents SHOULD provide as much additional information as possible in the message attribute.",e):"GenericError"===e.name?console.error("The UA cannot provide the codec or recording option that has been requested.",e):console.error("MediaRecorder Error",e)),function(e){if(!r.manuallyStopped&&a&&"inactive"===a.state)return delete t.timeslice,void a.start(6e5);setTimeout(void 0,1e3)}(),"inactive"!==a.state&&"stopped"!==a.state&&a.stop())},"number"==typeof t.timeSlice?(s(),a.start(t.timeSlice)):a.start(36e5),t.initCallback&&t.initCallback()},this.timestamps=[],this.stop=function(e){e=e||function(){},r.manuallyStopped=!0,a&&(this.recordingCallback=e,"recording"===a.state&&a.stop(),"number"==typeof t.timeSlice&&setTimeout(function(){r.blob=new Blob(n,{type:o(t)}),r.recordingCallback(r.blob)},100))},this.pause=function(){a&&"recording"===a.state&&a.pause()},this.resume=function(){a&&"paused"===a.state&&a.resume()},this.clearRecordedData=function(){a&&"recording"===a.state&&r.stop(c),c()},this.getInternalRecorder=function(){return a},this.blob=null,this.getState=function(){return a&&a.state||"inactive"};var d=[];this.getAllStates=function(){return d},void 0===t.checkForInactiveTracks&&(t.checkForInactiveTracks=!1);r=this;!function i(){if(a&&!1!==t.checkForInactiveTracks)return!1===function(){if("active"in e){if(!e.active)return!1}else if("ended"in e&&e.ended)return!1;return!0}()?(t.disableLogs||console.log("MediaStream seems stopped."),void r.stop()):void setTimeout(i,1e3)}(),this.name="MediaStreamRecorder",this.toString=function(){return this.name}}function C(e,t){if(!S(e,"audio").length)throw"Your stream has no audio tracks.";var r,i=this,a=[],n=[],s=!1,o=0,c=2,d=(t=t||{}).desiredSampRate;function l(){if(!1===t.checkForInactiveTracks)return!0;if("active"in e){if(!e.active)return!1}else if("ended"in e&&e.ended)return!1;return!0}function p(e,t){function r(e,t){var r,i=e.numberOfAudioChannels,a=e.leftBuffers.slice(0),n=e.rightBuffers.slice(0),s=e.sampleRate,o=e.internalInterleavedLength,c=e.desiredSampRate;function d(e,t,r){var i=Math.round(e.length*(t/r)),a=[],n=Number((e.length-1)/(i-1));a[0]=e[0];for(var s=1;s<i-1;s++){var o=s*n,c=Number(Math.floor(o)).toFixed(),d=Number(Math.ceil(o)).toFixed(),p=o-c;a[s]=l(e[c],e[d],p)}return a[i-1]=e[e.length-1],a}function l(e,t,r){return e+(t-e)*r}function p(e,t){for(var r=new Float64Array(t),i=0,a=e.length,n=0;n<a;n++){var s=e[n];r.set(s,i),i+=s.length}return r}function u(e,t,r){for(var i=r.length,a=0;a<i;a++)e.setUint8(t+a,r.charCodeAt(a))}2===i&&(a=p(a,o),n=p(n,o),c&&(a=d(a,c,s),n=d(n,c,s))),1===i&&(a=p(a,o),c&&(a=d(a,c,s))),c&&(s=c),2===i&&(r=function(e,t){for(var r=e.length+t.length,i=new Float64Array(r),a=0,n=0;n<r;)i[n++]=e[a],i[n++]=t[a],a++;return i}(a,n)),1===i&&(r=a);var h=r.length,m=new ArrayBuffer(44+2*h),f=new DataView(m);u(f,0,"RIFF"),f.setUint32(4,36+2*h,!0),u(f,8,"WAVE"),u(f,12,"fmt "),f.setUint32(16,16,!0),f.setUint16(20,1,!0),f.setUint16(22,i,!0),f.setUint32(24,s,!0),f.setUint32(28,2*s,!0),f.setUint16(32,2*i,!0),f.setUint16(34,16,!0),u(f,36,"data"),f.setUint32(40,2*h,!0);for(var g=h,v=44,b=0;b<g;b++)f.setInt16(v,32767*r[b],!0),v+=2;if(t)return t({buffer:m,view:f});postMessage({buffer:m,view:f})}if(e.noWorker)r(e,function(e){t(e.buffer,e.view)});else{var i,a,n,s=(i=r,a=u.createObjectURL(new Blob([i.toString(),";this.onmessage =  function (eee) {"+i.name+"(eee.data);}"],{type:"application/javascript"})),(n=new Worker(a)).workerURL=a,n);s.onmessage=function(e){t(e.data.buffer,e.data.view),u.revokeObjectURL(s.workerURL),s.terminate()},s.postMessage(e)}}if(!0===t.leftChannel&&(c=1),1===t.numberOfAudioChannels&&(c=1),(!c||c<1)&&(c=2),t.disableLogs||console.log("StereoAudioRecorder is set to record number of channels: "+c),void 0===t.checkForInactiveTracks&&(t.checkForInactiveTracks=!0),this.record=function(){if(!1===l())throw"Please make sure MediaStream is active.";y(),R=_=!1,s=!0,void 0!==t.timeSlice&&P()},this.stop=function(e){e=e||function(){},s=!1,p({desiredSampRate:d,sampleRate:b,numberOfAudioChannels:c,internalInterleavedLength:o,leftBuffers:a,rightBuffers:1===c?[]:n,noWorker:t.noWorker},function(t,r){i.blob=new Blob([r],{type:"audio/wav"}),i.buffer=new ArrayBuffer(r.buffer.byteLength),i.view=r,i.sampleRate=d||b,i.bufferSize=v,i.length=o,R=!1,e&&e(i.blob)})},void 0===h)var h={AudioContextConstructor:null,AudioContext:window.AudioContext||window.webkitAudioContext};h.AudioContextConstructor||(h.AudioContextConstructor=new h.AudioContext);var m=h.AudioContextConstructor,f=m.createMediaStreamSource(e),g=[0,256,512,1024,2048,4096,8192,16384],v=void 0===t.bufferSize?4096:t.bufferSize;if(-1===g.indexOf(v)&&(t.disableLogs||console.log("Legal values for buffer-size are "+JSON.stringify(g,null,"\t"))),m.createJavaScriptNode)r=m.createJavaScriptNode(v,c,c);else{if(!m.createScriptProcessor)throw"WebAudio API has no support on this browser.";r=m.createScriptProcessor(v,c,c)}f.connect(r),t.bufferSize||(v=r.bufferSize);var b=void 0!==t.sampleRate?t.sampleRate:m.sampleRate||44100;(b<22050||b>96e3)&&(t.disableLogs||console.log("sample-rate must be under range 22050 and 96000.")),t.disableLogs||t.desiredSampRate&&console.log("Desired sample-rate: "+t.desiredSampRate);var _=!1;function y(){a=[],n=[],o=0,R=!1,s=!1,_=!1,m=null,i.leftchannel=a,i.rightchannel=n,i.numberOfAudioChannels=c,i.desiredSampRate=d,i.sampleRate=b,i.recordingLength=o,k={left:[],right:[],recordingLength:0}}function w(){r&&(r.onaudioprocess=null,r.disconnect(),r=null),f&&(f.disconnect(),f=null),y()}this.pause=function(){_=!0},this.resume=function(){if(!1===l())throw"Please make sure MediaStream is active.";if(!s)return t.disableLogs||console.log("Seems recording has been restarted."),void this.record();_=!1},this.clearRecordedData=function(){t.checkForInactiveTracks=!1,s&&this.stop(w),w()},this.name="StereoAudioRecorder",this.toString=function(){return this.name};var R=!1;r.onaudioprocess=function(e){if(!_)if(!1===l()&&(t.disableLogs||console.log("MediaStream seems stopped."),r.disconnect(),s=!1),s){R||(R=!0,t.onAudioProcessStarted&&t.onAudioProcessStarted(),t.initCallback&&t.initCallback());var d=e.inputBuffer.getChannelData(0),p=new Float32Array(d);if(a.push(p),2===c){var u=e.inputBuffer.getChannelData(1),h=new Float32Array(u);n.push(h)}o+=v,i.recordingLength=o,void 0!==t.timeSlice&&(k.recordingLength+=v,k.left.push(p),2===c&&k.right.push(h))}else f&&(f.disconnect(),f=null)},m.createMediaStreamDestination?r.connect(m.createMediaStreamDestination()):r.connect(m.destination),this.leftchannel=a,this.rightchannel=n,this.numberOfAudioChannels=c,this.desiredSampRate=d,this.sampleRate=b,i.recordingLength=o;var k={left:[],right:[],recordingLength:0};function P(){s&&"function"==typeof t.ondataavailable&&void 0!==t.timeSlice&&(k.left.length?(p({desiredSampRate:d,sampleRate:b,numberOfAudioChannels:c,internalInterleavedLength:k.recordingLength,leftBuffers:k.left,rightBuffers:1===c?[]:k.right},function(e,r){var i=new Blob([r],{type:"audio/wav"});t.ondataavailable(i),setTimeout(P,t.timeSlice)}),k={left:[],right:[],recordingLength:0}):setTimeout(P,t.timeSlice))}}function D(e,t){if("undefined"==typeof html2canvas)throw"Please link: https://cdn.webrtc-experiment.com/screenshot.js";(t=t||{}).frameInterval||(t.frameInterval=10);var r=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach(function(e){e in document.createElement("canvas")&&(r=!0)});var i,a,n,s=!(!window.webkitRTCPeerConnection&&!window.webkitGetUserMedia||!window.chrome),o=50,c=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(s&&c&&c[2]&&(o=parseInt(c[2],10)),s&&o<52&&(r=!1),t.useWhammyRecorder&&(r=!1),r)if(t.disableLogs||console.log("Your browser supports both MediRecorder API and canvas.captureStream!"),e instanceof HTMLCanvasElement)i=e;else{if(!(e instanceof CanvasRenderingContext2D))throw"Please pass either HTMLCanvasElement or CanvasRenderingContext2D.";i=e.canvas}else navigator.mozGetUserMedia&&(t.disableLogs||console.error("Canvas recording is NOT supported in Firefox."));this.record=function(){if(n=!0,r&&!t.useWhammyRecorder){var e;"captureStream"in i?e=i.captureStream(25):"mozCaptureStream"in i?e=i.mozCaptureStream(25):"webkitCaptureStream"in i&&(e=i.webkitCaptureStream(25));try{var s=new b;s.addTrack(S(e,"video")[0]),e=s}catch(e){}if(!e)throw"captureStream API are NOT available.";(a=new T(e,{mimeType:t.mimeType||"video/webm"})).record()}else h.frames=[],u=(new Date).getTime(),p();t.initCallback&&t.initCallback()},this.getWebPImages=function(r){if("canvas"===e.nodeName.toLowerCase()){var i=h.frames.length;h.frames.forEach(function(e,r){var a=i-r;t.disableLogs||console.log(a+"/"+i+" frames remaining"),t.onEncodingCallback&&t.onEncodingCallback(a,i);var n=e.image.toDataURL("image/webp",1);h.frames[r].image=n}),t.disableLogs||console.log("Generating WebM"),r()}else r()},this.stop=function(e){n=!1;var i=this;r&&a?a.stop(e):this.getWebPImages(function(){h.compile(function(r){t.disableLogs||console.log("Recording finished!"),i.blob=r,i.blob.forEach&&(i.blob=new Blob([],{type:"video/webm"})),e&&e(i.blob),h.frames=[]})})};var d=!1;function l(){h.frames=[],n=!1,d=!1}function p(){if(d)return u=(new Date).getTime(),setTimeout(p,500);if("canvas"===e.nodeName.toLowerCase()){var r=(new Date).getTime()-u;return u=(new Date).getTime(),h.frames.push({image:(i=document.createElement("canvas"),a=i.getContext("2d"),i.width=e.width,i.height=e.height,a.drawImage(e,0,0),i),duration:r}),void(n&&setTimeout(p,t.frameInterval))}var i,a;html2canvas(e,{grabMouse:void 0===t.showMousePointer||t.showMousePointer,onrendered:function(e){var r=(new Date).getTime()-u;if(!r)return setTimeout(p,t.frameInterval);u=(new Date).getTime(),h.frames.push({image:e.toDataURL("image/webp",1),duration:r}),n&&setTimeout(p,t.frameInterval)}})}this.pause=function(){d=!0,a instanceof T&&a.pause()},this.resume=function(){d=!1,a instanceof T?a.resume():n||this.record()},this.clearRecordedData=function(){n&&this.stop(l),l()},this.name="CanvasRecorder",this.toString=function(){return this.name};var u=(new Date).getTime(),h=new M.Video(100)}function x(e,t){function r(e){e=void 0!==e?e:10;var t=(new Date).getTime()-c;return t?n?(c=(new Date).getTime(),setTimeout(r,100)):(c=(new Date).getTime(),o.paused&&o.play(),p.drawImage(o,0,0,l.width,l.height),d.frames.push({duration:t,image:l.toDataURL("image/webp")}),void(a||setTimeout(r,e,e))):setTimeout(r,e,e)}function i(e,t,r,i,a){var n=document.createElement("canvas");n.width=l.width,n.height=l.height;var s,o,c,d=n.getContext("2d"),p=[],u=-1===t,h=t&&t>0&&t<=e.length?t:e.length,m=0,f=0,g=0,v=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),b=r&&r>=0&&r<=1?r:0,_=i&&i>=0&&i<=1?i:0,y=!1;o=-1,c=(s={length:h,functionToLoop:function(t,r){var i,a,n,s=function(){!y&&n-i<=n*_||(u&&(y=!0),p.push(e[r])),t()};if(y)s();else{var o=new Image;o.onload=function(){d.drawImage(o,0,0,l.width,l.height);var e=d.getImageData(0,0,l.width,l.height);i=0,a=e.data.length,n=e.data.length/4;for(var t=0;t<a;t+=4){var r={r:e.data[t],g:e.data[t+1],b:e.data[t+2]};Math.sqrt(Math.pow(r.r-m,2)+Math.pow(r.g-f,2)+Math.pow(r.b-g,2))<=v*b&&i++}s()},o.src=e[r].image}},callback:function(){(p=p.concat(e.slice(h))).length<=0&&p.push(e[e.length-1]),a(p)}}).length,function e(){++o!==c?setTimeout(function(){s.functionToLoop(e,o)},1):s.callback()}()}(t=t||{}).frameInterval||(t.frameInterval=10),t.disableLogs||console.log("Using frames-interval:",t.frameInterval),this.record=function(){t.width||(t.width=320),t.height||(t.height=240),t.video||(t.video={width:t.width,height:t.height}),t.canvas||(t.canvas={width:t.width,height:t.height}),l.width=t.canvas.width||320,l.height=t.canvas.height||240,p=l.getContext("2d"),t.video&&t.video instanceof HTMLVideoElement?(o=t.video.cloneNode(),t.initCallback&&t.initCallback()):(o=document.createElement("video"),R(e,o),o.onloadedmetadata=function(){t.initCallback&&t.initCallback()},o.width=t.video.width,o.height=t.video.height),o.muted=!0,o.play(),c=(new Date).getTime(),d=new M.Video,t.disableLogs||(console.log("canvas resolutions",l.width,"*",l.height),console.log("video width/height",o.width||l.width,"*",o.height||l.height)),r(t.frameInterval)};var a=!1;this.stop=function(e){e=e||function(){},a=!0;var r=this;setTimeout(function(){i(d.frames,-1,null,null,function(i){d.frames=i,t.advertisement&&t.advertisement.length&&(d.frames=t.advertisement.concat(d.frames)),d.compile(function(t){r.blob=t,r.blob.forEach&&(r.blob=new Blob([],{type:"video/webm"})),e&&e(r.blob)})})},10)};var n=!1;function s(){d.frames=[],a=!0,n=!1}this.pause=function(){n=!0},this.resume=function(){n=!1,a&&this.record()},this.clearRecordedData=function(){a||this.stop(s),s()},this.name="WhammyRecorder",this.toString=function(){return this.name};var o,c,d,l=document.createElement("canvas"),p=l.getContext("2d")}void 0!==p?k.AudioContext=p:"undefined"!=typeof webkitAudioContext&&(k.AudioContext=webkitAudioContext),i.Storage=k,i.MediaStreamRecorder=T,i.StereoAudioRecorder=C,i.CanvasRecorder=D,i.WhammyRecorder=x;var M=function(){function e(e){this.frames=[],this.duration=e||1,this.quality=.8}function t(e){function t(e,t,r){return[{data:e,id:231}].concat(r.map(function(e){var r=function(e){var t=0;e.keyframe&&(t|=128);e.invisible&&(t|=8);e.lacing&&(t|=e.lacing<<1);e.discardable&&(t|=1);if(e.trackNum>127)throw"TrackNumber > 127 not supported";return[128|e.trackNum,e.timecode>>8,255&e.timecode,t].map(function(e){return String.fromCharCode(e)}).join("")+e.frame}({discardable:0,frame:e.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(t)});return t+=e.duration,{data:r,id:163}}))}function r(e){for(var t=[];e>0;)t.push(255&e),e>>=8;return new Uint8Array(t.reverse())}function i(e){var t=[];e=(e.length%8?new Array(9-e.length%8).join("0"):"")+e;for(var r=0;r<e.length;r+=8)t.push(parseInt(e.substr(r,8),2));return new Uint8Array(t)}function a(e,t){return parseInt(e.substr(t+4,4).split("").map(function(e){var t=e.charCodeAt(0).toString(2);return new Array(8-t.length+1).join("0")+t}).join(""),2)}var n=new function(e){var a=function(e){if(e[0]){for(var t=e[0].width,r=e[0].height,i=e[0].duration,a=1;a<e.length;a++)i+=e[a].duration;return{duration:i,width:t,height:r}}postMessage({error:"Something went wrong. Maybe WebP format is not supported in the current browser."})}(e);if(!a)return[];for(var n,s=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:(n=a.duration,[].slice.call(new Uint8Array(new Float64Array([n]).buffer),0).map(function(e){return String.fromCharCode(e)}).reverse().join("")),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:29637},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:a.width,id:176},{data:a.height,id:186}]}]}]}]}],o=0,c=0;o<e.length;){var d=[],l=0;do{d.push(e[o]),l+=e[o].duration,o++}while(o<e.length&&l<3e4);var p={id:524531317,data:t(c,0,d)};s[1].data.push(p),c+=l}return function e(t){for(var a=[],n=0;n<t.length;n++){var s=t[n].data;"object"==typeof s&&(s=e(s)),"number"==typeof s&&(s=i(s.toString(2))),"string"==typeof s&&(s=new Uint8Array(s.split("").map(function(e){return e.charCodeAt(0)})));var o=s.size||s.byteLength||s.length,c=Math.ceil(Math.ceil(Math.log(o)/Math.log(2))/8),d=o.toString(2),l=new Array(7*c+7+1-d.length).join("0")+d,p=new Array(c).join("0")+"1"+l;a.push(r(t[n].id)),a.push(i(p)),a.push(s)}return new Blob(a,{type:"video/webm"})}(s)}(e.map(function(e){var t=function(e){for(var t=e.RIFF[0].WEBP[0],r=t.indexOf("*"),i=0,a=[];i<4;i++)a[i]=t.charCodeAt(r+3+i);return{width:16383&(a[1]<<8|a[0]),height:16383&(a[3]<<8|a[2]),data:t,riff:e}}(function e(t){for(var r=0,i={};r<t.length;){var n=t.substr(r,4),s=a(t,r),o=t.substr(r+4+4,s);r+=8+s,i[n]=i[n]||[],"RIFF"===n||"LIST"===n?i[n].push(e(o)):i[n].push(o)}return i}(atob(e.image.slice(23))));return t.duration=e.duration,t}));postMessage(n)}return e.prototype.add=function(e,t){if("canvas"in e&&(e=e.canvas),"toDataURL"in e&&(e=e.toDataURL("image/webp",this.quality)),!/^data:image\/webp;base64,/gi.test(e))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:e,duration:t||this.duration})},e.prototype.compile=function(e){var r,i,a,n=(r=t,i=u.createObjectURL(new Blob([r.toString(),"this.onmessage =  function (eee) {"+r.name+"(eee.data);}"],{type:"application/javascript"})),a=new Worker(i),u.revokeObjectURL(i),a);n.onmessage=function(t){t.data.error?console.error(t.data.error):e(t.data)},n.postMessage(this.frames)},{Video:e}}();i.Whammy=M;var L={init:function(){var e=this;if("undefined"!=typeof indexedDB&&void 0!==indexedDB.open){var t,r=this.dbName||location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),i=indexedDB.open(r,1);i.onerror=e.onError,i.onsuccess=function(){((t=i.result).onerror=e.onError,t.setVersion)?1!==t.version?t.setVersion(1).onsuccess=function(){a(t),n()}:n():n()},i.onupgradeneeded=function(e){a(e.target.result)}}else console.error("IndexedDB API are not available in this browser.");function a(t){t.createObjectStore(e.dataStoreName)}function n(){var r=t.transaction([e.dataStoreName],"readwrite");function i(t){r.objectStore(e.dataStoreName).get(t).onsuccess=function(r){e.callback&&e.callback(r.target.result,t)}}e.videoBlob&&r.objectStore(e.dataStoreName).put(e.videoBlob,"videoBlob"),e.gifBlob&&r.objectStore(e.dataStoreName).put(e.gifBlob,"gifBlob"),e.audioBlob&&r.objectStore(e.dataStoreName).put(e.audioBlob,"audioBlob"),i("audioBlob"),i("videoBlob"),i("gifBlob")}},Fetch:function(e){return this.callback=e,this.init(),this},Store:function(e){return this.audioBlob=e.audioBlob,this.videoBlob=e.videoBlob,this.gifBlob=e.gifBlob,this.init(),this},onError:function(e){console.error(JSON.stringify(e,null,"\t"))},dataStoreName:"recordRTC",dbName:null};function E(e,t){if("undefined"==typeof GIFEncoder){var r=document.createElement("script");r.src="https://cdn.webrtc-experiment.com/gif-recorder.js",(document.body||document.documentElement).appendChild(r)}t=t||{};var i=e instanceof CanvasRenderingContext2D||e instanceof HTMLCanvasElement;this.record=function(){"undefined"!=typeof GIFEncoder&&o?(i||(t.width||(t.width=d.offsetWidth||320),t.height||(t.height=d.offsetHeight||240),t.video||(t.video={width:t.width,height:t.height}),t.canvas||(t.canvas={width:t.width,height:t.height}),n.width=t.canvas.width||320,n.height=t.canvas.height||240,d.width=t.video.width||320,d.height=t.video.height||240),(u=new GIFEncoder).setRepeat(0),u.setDelay(t.frameRate||200),u.setQuality(t.quality||10),u.start(),"function"==typeof t.onGifRecordingStarted&&t.onGifRecordingStarted(),Date.now(),h=c(function e(r){if(!0!==m.clearedRecordedData){if(a)return setTimeout(function(){e(r)},100);h=c(e),void 0===typeof p&&(p=r),r-p<90||(!i&&d.paused&&d.play(),i||s.drawImage(d,0,0,n.width,n.height),t.onGifPreview&&t.onGifPreview(n.toDataURL("image/png")),u.addFrame(s),p=r)}}),t.initCallback&&t.initCallback()):setTimeout(m.record,1e3)},this.stop=function(e){e=e||function(){},h&&l(h),Date.now(),this.blob=new Blob([new Uint8Array(u.stream().bin)],{type:"image/gif"}),e(this.blob),u.stream().bin=[]};var a=!1;this.pause=function(){a=!0},this.resume=function(){a=!1},this.clearRecordedData=function(){m.clearedRecordedData=!0,u&&(u.stream().bin=[])},this.name="GifRecorder",this.toString=function(){return this.name};var n=document.createElement("canvas"),s=n.getContext("2d");i&&(e instanceof CanvasRenderingContext2D?n=(s=e).canvas:e instanceof HTMLCanvasElement&&(s=e.getContext("2d"),n=e));var o=!0;if(!i){var d=document.createElement("video");d.muted=!0,d.autoplay=!0,o=!1,d.onloadedmetadata=function(){o=!0},R(e,d),d.play()}var p,u,h=null,m=this}function I(e,t){t=t||"multi-streams-mixer";var r=[],i=!1,a=document.createElement("canvas"),n=a.getContext("2d");a.style.opacity=0,a.style.position="absolute",a.style.zIndex=-1,a.style.top="-1000em",a.style.left="-1000em",a.className=t,(document.body||document.documentElement).appendChild(a),this.disableLogs=!1,this.frameInterval=10,this.width=360,this.height=240,this.useGainNode=!0;var s=this,o=window.AudioContext;void 0===o&&("undefined"!=typeof webkitAudioContext&&(o=webkitAudioContext),"undefined"!=typeof mozAudioContext&&(o=mozAudioContext));var c=window.URL;void 0===c&&"undefined"!=typeof webkitURL&&(c=webkitURL),"undefined"!=typeof navigator&&void 0===navigator.getUserMedia&&(void 0!==navigator.webkitGetUserMedia&&(navigator.getUserMedia=navigator.webkitGetUserMedia),void 0!==navigator.mozGetUserMedia&&(navigator.getUserMedia=navigator.mozGetUserMedia));var d=window.MediaStream;void 0===d&&"undefined"!=typeof webkitMediaStream&&(d=webkitMediaStream),void 0!==d&&void 0===d.prototype.stop&&(d.prototype.stop=function(){this.getTracks().forEach(function(e){e.stop()})});var l={};function p(){if(!i){var e=r.length,t=!1,n=[];if(r.forEach(function(e){e.stream||(e.stream={}),e.stream.fullcanvas?t=e:n.push(e)}),t)a.width=t.stream.width,a.height=t.stream.height;else if(n.length){a.width=e>1?2*n[0].width:n[0].width;var o=1;3!==e&&4!==e||(o=2),5!==e&&6!==e||(o=3),7!==e&&8!==e||(o=4),9!==e&&10!==e||(o=5),a.height=n[0].height*o}else a.width=s.width||360,a.height=s.height||240;t&&t instanceof HTMLVideoElement&&u(t),n.forEach(function(e,t){u(e,t)}),setTimeout(p,s.frameInterval)}}function u(e,t){if(!i){var r=0,a=0,s=e.width,o=e.height;1===t&&(r=e.width),2===t&&(a=e.height),3===t&&(r=e.width,a=e.height),4===t&&(a=2*e.height),5===t&&(r=e.width,a=2*e.height),6===t&&(a=3*e.height),7===t&&(r=e.width,a=3*e.height),void 0!==e.stream.left&&(r=e.stream.left),void 0!==e.stream.top&&(a=e.stream.top),void 0!==e.stream.width&&(s=e.stream.width),void 0!==e.stream.height&&(o=e.stream.height),n.drawImage(e,r,a,s,o),"function"==typeof e.stream.onRender&&e.stream.onRender(n,r,a,s,o,t)}}function h(e){var r=document.createElement("video");return function(e,t){"srcObject"in t?t.srcObject=e:"mozSrcObject"in t?t.mozSrcObject=e:t.srcObject=e}(e,r),r.className=t,r.muted=!0,r.volume=0,r.width=e.width||s.width||360,r.height=e.height||s.height||240,r.play(),r}function m(t){r=[],(t=t||e).forEach(function(e){if(e.getTracks().filter(function(e){return"video"===e.kind}).length){var t=h(e);t.stream=e,r.push(t)}})}void 0!==o?l.AudioContext=o:"undefined"!=typeof webkitAudioContext&&(l.AudioContext=webkitAudioContext),this.startDrawingFrames=function(){p()},this.appendStreams=function(t){if(!t)throw"First parameter is required.";t instanceof Array||(t=[t]),t.forEach(function(t){var i=new d;if(t.getTracks().filter(function(e){return"video"===e.kind}).length){var a=h(t);a.stream=t,r.push(a),i.addTrack(t.getTracks().filter(function(e){return"video"===e.kind})[0])}if(t.getTracks().filter(function(e){return"audio"===e.kind}).length){var n=s.audioContext.createMediaStreamSource(t);s.audioDestination=s.audioContext.createMediaStreamDestination(),n.connect(s.audioDestination),i.addTrack(s.audioDestination.stream.getTracks().filter(function(e){return"audio"===e.kind})[0])}e.push(i)})},this.releaseStreams=function(){r=[],i=!0,s.gainNode&&(s.gainNode.disconnect(),s.gainNode=null),s.audioSources.length&&(s.audioSources.forEach(function(e){e.disconnect()}),s.audioSources=[]),s.audioDestination&&(s.audioDestination.disconnect(),s.audioDestination=null),s.audioContext&&s.audioContext.close(),s.audioContext=null,n.clearRect(0,0,a.width,a.height),a.stream&&(a.stream.stop(),a.stream=null)},this.resetVideoStreams=function(e){!e||e instanceof Array||(e=[e]),m(e)},this.name="MultiStreamsMixer",this.toString=function(){return this.name},this.getMixedStream=function(){i=!1;var t=function(){var e;m(),"captureStream"in a?e=a.captureStream():"mozCaptureStream"in a?e=a.mozCaptureStream():s.disableLogs||console.error("Upgrade to latest Chrome or otherwise enable this flag: chrome://flags/#enable-experimental-web-platform-features");var t=new d;return e.getTracks().filter(function(e){return"video"===e.kind}).forEach(function(e){t.addTrack(e)}),a.stream=t,t}(),r=function(){l.AudioContextConstructor||(l.AudioContextConstructor=new l.AudioContext),s.audioContext=l.AudioContextConstructor,s.audioSources=[],!0===s.useGainNode&&(s.gainNode=s.audioContext.createGain(),s.gainNode.connect(s.audioContext.destination),s.gainNode.gain.value=0);var t=0;if(e.forEach(function(e){if(e.getTracks().filter(function(e){return"audio"===e.kind}).length){t++;var r=s.audioContext.createMediaStreamSource(e);!0===s.useGainNode&&r.connect(s.gainNode),s.audioSources.push(r)}}),t)return s.audioDestination=s.audioContext.createMediaStreamDestination(),s.audioSources.forEach(function(e){e.connect(s.audioDestination)}),s.audioDestination.stream}();return r&&r.getTracks().filter(function(e){return"audio"===e.kind}).forEach(function(e){t.addTrack(e)}),e.forEach(function(e){e.fullcanvas}),t}}function O(e,t){e=e||[];var r,i,a=this;(t=t||{elementClass:"multi-streams-mixer",mimeType:"video/webm",video:{width:360,height:240}}).frameInterval||(t.frameInterval=10),t.video||(t.video={}),t.video.width||(t.video.width=360),t.video.height||(t.video.height=240),this.record=function(){var a;r=new I(e,t.elementClass||"multi-streams-mixer"),(a=[],e.forEach(function(e){S(e,"video").forEach(function(e){a.push(e)})}),a).length&&(r.frameInterval=t.frameInterval||10,r.width=t.video.width||360,r.height=t.video.height||240,r.startDrawingFrames()),t.previewStream&&"function"==typeof t.previewStream&&t.previewStream(r.getMixedStream()),(i=new T(r.getMixedStream(),t)).record()},this.stop=function(e){i&&i.stop(function(t){a.blob=t,e(t),a.clearRecordedData()})},this.pause=function(){i&&i.pause()},this.resume=function(){i&&i.resume()},this.clearRecordedData=function(){i&&(i.clearRecordedData(),i=null),r&&(r.releaseStreams(),r=null)},this.addStreams=function(a){if(!a)throw"First parameter is required.";a instanceof Array||(a=[a]),e.concat(a),i&&r&&(r.appendStreams(a),t.previewStream&&"function"==typeof t.previewStream&&t.previewStream(r.getMixedStream()))},this.resetVideoStreams=function(e){r&&(!e||e instanceof Array||(e=[e]),r.resetVideoStreams(e))},this.getMixer=function(e){return r},this.name="MultiStreamRecorder",this.toString=function(){return this.name}}function j(e,t){function r(){return new ReadableStream({start:function(r){var i=document.createElement("canvas"),a=document.createElement("video");a.srcObject=e,a.onplaying=function(){i.width=t.width,i.height=t.height;var e=i.getContext("2d"),n=1e3/t.frameRate;setTimeout(function i(){e.drawImage(a,0,0),r.enqueue(e.getImageData(0,0,t.width,t.height)),setTimeout(i,n)},n)},a.play()}})}var i,a;"undefined"!=typeof ReadableStream&&"undefined"!=typeof WritableStream||console.error("Following polyfill is strongly recommended: https://unpkg.com/@mattiasbuelens/web-streams-polyfill/dist/polyfill.min.js"),(t=t||{}).width=t.width||640,t.height=t.height||480,t.frameRate=t.frameRate||30,t.bitrate=t.bitrate||1200,this.record=function(){n=[],a=!1,this.blob=null,function e(s,o){if(t.workerPath||o){if(!t.workerPath&&o instanceof ArrayBuffer){var c=new Blob([o],{type:"text/javascript"});t.workerPath=u.createObjectURL(c)}t.workerPath||console.error("workerPath parameter is missing."),(i=new Worker(t.workerPath)).postMessage(t.webAssemblyPath||"https://unpkg.com/webm-wasm@latest/dist/webm-wasm.wasm"),i.addEventListener("message",function(e){"READY"===e.data?(i.postMessage({width:t.width,height:t.height,bitrate:t.bitrate||1200,timebaseDen:t.frameRate||30,realtime:!0}),r().pipeTo(new WritableStream({write:function(e){i&&i.postMessage(e.data.buffer,[e.data.buffer])}}))):e.data&&(a||n.push(e.data))})}else fetch("https://unpkg.com/webm-wasm@latest/dist/webm-worker.js").then(function(t){t.arrayBuffer().then(function(t){e(s,t)})})}(e),"function"==typeof t.initCallback&&t.initCallback()},this.pause=function(){a=!0},this.resume=function(){a=!1};var n=[];this.stop=function(e){i&&(i.postMessage(null),i.terminate(),i=null),this.blob=new Blob(n,{type:"video/webm"}),e(this.blob)},this.name="WebAssemblyRecorder",this.toString=function(){return this.name},this.clearRecordedData=function(){n=[],a=!1,this.blob=null},this.blob=null}i.DiskStorage=L,i.GifRecorder=E,i.MultiStreamRecorder=O,i.RecordRTCPromisesHandler=function(e,t){if(!this)throw'Use "new RecordRTCPromisesHandler()"';if(void 0===e)throw'First argument "MediaStream" is required.';var r=this;r.recordRTC=new i(e,t),this.startRecording=function(){return new Promise(function(e,t){try{r.recordRTC.startRecording(),e()}catch(e){t(e)}})},this.stopRecording=function(){return new Promise(function(e,t){try{r.recordRTC.stopRecording(function(i){r.blob=r.recordRTC.getBlob(),r.blob&&r.blob.size?e(i):t("Empty blob.",r.blob)})}catch(e){t(e)}})},this.pauseRecording=function(){return new Promise(function(e,t){try{r.recordRTC.pauseRecording(),e()}catch(e){t(e)}})},this.resumeRecording=function(){return new Promise(function(e,t){try{r.recordRTC.resumeRecording(),e()}catch(e){t(e)}})},this.getDataURL=function(e){return new Promise(function(e,t){try{r.recordRTC.getDataURL(function(t){e(t)})}catch(e){t(e)}})},this.getBlob=function(){return new Promise(function(e,t){try{e(r.recordRTC.getBlob())}catch(e){t(e)}})},this.getInternalRecorder=function(){return new Promise(function(e,t){try{e(r.recordRTC.getInternalRecorder())}catch(e){t(e)}})},this.reset=function(){return new Promise(function(e,t){try{e(r.recordRTC.reset())}catch(e){t(e)}})},this.destroy=function(){return new Promise(function(e,t){try{e(r.recordRTC.destroy())}catch(e){t(e)}})},this.getState=function(){return new Promise(function(e,t){try{e(r.recordRTC.getState())}catch(e){t(e)}})},this.blob=null,this.version="5.5.8"},i.WebAssemblyRecorder=j}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:49}],59:[function(e,t,r){var i=function(e){"use strict";var t,r=Object.prototype,i=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},n=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function c(e,t,r,i){var a=t&&t.prototype instanceof f?t:f,n=Object.create(a.prototype),s=new C(i||[]);return n._invoke=function(e,t,r){var i=l;return function(a,n){if(i===u)throw new Error("Generator is already running");if(i===h){if("throw"===a)throw n;return x()}for(r.method=a,r.arg=n;;){var s=r.delegate;if(s){var o=k(s,r);if(o){if(o===m)continue;return o}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===l)throw i=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=u;var c=d(e,t,r);if("normal"===c.type){if(i=r.done?h:p,c.arg===m)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(i=h,r.method="throw",r.arg=c.arg)}}}(e,r,s),n}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l="suspendedStart",p="suspendedYield",u="executing",h="completed",m={};function f(){}function g(){}function v(){}var b={};b[n]=function(){return this};var _=Object.getPrototypeOf,y=_&&_(_(D([])));y&&y!==r&&i.call(y,n)&&(b=y);var w=v.prototype=f.prototype=Object.create(b);function S(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function R(e){var t;this._invoke=function(r,a){function n(){return new Promise(function(t,n){!function t(r,a,n,s){var o=d(e[r],e,a);if("throw"!==o.type){var c=o.arg,l=c.value;return l&&"object"==typeof l&&i.call(l,"__await")?Promise.resolve(l.__await).then(function(e){t("next",e,n,s)},function(e){t("throw",e,n,s)}):Promise.resolve(l).then(function(e){c.value=e,n(c)},function(e){return t("throw",e,n,s)})}s(o.arg)}(r,a,t,n)})}return t=t?t.then(n,n):n()}}function k(e,r){var i=e.iterator[r.method];if(i===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,k(e,r),"throw"===r.method))return m;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var a=d(i,e.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,m;var n=a.arg;return n?n.done?(r[e.resultName]=n.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,m):n:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,m)}function P(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function C(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function D(e){if(e){var r=e[n];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,s=function r(){for(;++a<e.length;)if(i.call(e,a))return r.value=e[a],r.done=!1,r;return r.value=t,r.done=!0,r};return s.next=s}}return{next:x}}function x(){return{value:t,done:!0}}return g.prototype=w.constructor=v,v.constructor=g,v[o]=g.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,o in e||(e[o]="GeneratorFunction")),e.prototype=Object.create(w),e},e.awrap=function(e){return{__await:e}},S(R.prototype),R.prototype[s]=function(){return this},e.AsyncIterator=R,e.async=function(t,r,i,a){var n=new R(c(t,r,i,a));return e.isGeneratorFunction(r)?n:n.next().then(function(e){return e.done?e.value:n.next()})},S(w),w[o]="Generator",w[n]=function(){return this},w.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var i=t.pop();if(i in e)return r.value=i,r.done=!1,r}return r.done=!0,r}},e.values=D,C.prototype={constructor:C,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(T),!e)for(var r in this)"t"===r.charAt(0)&&i.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function a(i,a){return o.type="throw",o.arg=e,r.next=i,a&&(r.method="next",r.arg=t),!!a}for(var n=this.tryEntries.length-1;n>=0;--n){var s=this.tryEntries[n],o=s.completion;if("root"===s.tryLoc)return a("end");if(s.tryLoc<=this.prev){var c=i.call(s,"catchLoc"),d=i.call(s,"finallyLoc");if(c&&d){if(this.prev<s.catchLoc)return a(s.catchLoc,!0);if(this.prev<s.finallyLoc)return a(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return a(s.catchLoc,!0)}else{if(!d)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return a(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&i.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var n=a;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var s=n?n.completion:{};return s.type=e,s.arg=t,n?(this.method="next",this.next=n.finallyLoc,m):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var i=r.completion;if("throw"===i.type){var a=i.arg;T(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,i){return this.delegate={iterator:D(e),resultName:r,nextLoc:i},"next"===this.method&&(this.arg=t),m}},e}("object"==typeof t?t.exports:{});try{regeneratorRuntime=i}catch(e){Function("r","regeneratorRuntime = r")(i)}},{}],60:[function(e,t,r){t.exports=e("./lib/retry")},{"./lib/retry":61}],61:[function(e,t,r){var i=e("./retry_operation");r.operation=function(e){var t=r.timeouts(e);return new i(t,{forever:e&&e.forever,unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},r.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<t.retries;a++)i.push(this.createTimeout(a,t));return e&&e.forever&&!i.length&&i.push(this.createTimeout(a,t)),i.sort(function(e,t){return e-t}),i},r.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,i=Math.round(r*t.minTimeout*Math.pow(t.factor,e));return i=Math.min(i,t.maxTimeout)},r.wrap=function(e,t,i){if(t instanceof Array&&(i=t,t=null),!i)for(var a in i=[],e)"function"==typeof e[a]&&i.push(a);for(var n=0;n<i.length;n++){var s=i[n],o=e[s];e[s]=function(i){var a=r.operation(t),n=Array.prototype.slice.call(arguments,1),s=n.pop();n.push(function(e){a.retry(e)||(e&&(arguments[0]=a.mainError()),s.apply(this,arguments))}),a.attempt(function(){i.apply(e,n)})}.bind(e,o),e[s].options=t}}},{"./retry_operation":62}],62:[function(e,t,r){function i(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}t.exports=i,i.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts},i.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null},i.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),r=this._timeouts.shift()}var i=this,a=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},r);return this._options.unref&&a.unref(),!0},i.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},i.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},i.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},i.prototype.start=i.prototype.try,i.prototype.errors=function(){return this._errors},i.prototype.attempts=function(){return this._attempts},i.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,i=0;i<this._errors.length;i++){var a=this._errors[i],n=a.message,s=(e[n]||0)+1;e[n]=s,s>=r&&(t=a,r=s)}return t}},{}],63:[function(e,t,r){var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w\/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_\/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach(function(e){i[e].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})})},{}],64:[function(e,t,r){var i=e("./parser"),a=e("./writer");r.write=a,r.parse=i.parse,r.parseParams=i.parseParams,r.parseFmtpConfig=i.parseFmtpConfig,r.parsePayloads=i.parsePayloads,r.parseRemoteCandidates=i.parseRemoteCandidates,r.parseImageAttributes=i.parseImageAttributes,r.parseSimulcastStreamList=i.parseSimulcastStreamList},{"./parser":65,"./writer":66}],65:[function(e,t,r){var i=function(e){return String(Number(e))===e?Number(e):e},a=function(e,t,r){var a=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:a&&!t[e.name]&&(t[e.name]={});var n=e.push?{}:a?t[e.name]:t;!function(e,t,r,a){if(a&&!r)t[a]=i(e[1]);else for(var n=0;n<r.length;n+=1)null!=e[n+1]&&(t[r[n]]=i(e[n+1]))}(r.match(e.reg),n,e.names,e.name),e.push&&t[e.push].push(n)},n=e("./grammar"),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(e){var t={},r=[],i=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach(function(e){var t=e[0],s=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),i=r[r.length-1]);for(var o=0;o<(n[t]||[]).length;o+=1){var c=n[t][o];if(c.reg.test(s))return a(c,i,s)}}),t.media=r,t};var o=function(e,t){var r=t.split(/=(.+)/,2);return 2===r.length?e[r[0]]=i(r[1]):1===r.length&&t.length>1&&(e[r[0]]=void 0),e};r.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(e){return e.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(e){for(var t=[],r=e.split(" ").map(i),a=0;a<r.length;a+=3)t.push({component:r[a],ip:r[a+1],port:r[a+2]});return t},r.parseImageAttributes=function(e){return e.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})})},r.parseSimulcastStreamList=function(e){return e.split(";").map(function(e){return e.split(",").map(function(e){var t,r=!1;return"~"!==e[0]?t=i(e):(t=i(e.substring(1,e.length)),r=!0),{scid:t,paused:r}})})}},{"./grammar":63}],66:[function(e,t,r){var i=e("./grammar"),a=/%[sdv%]/g,n=function(e,t,r){var i=[e+"="+(t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format)];if(t.names)for(var n=0;n<t.names.length;n+=1){var s=t.names[n];t.name?i.push(r[t.name][s]):i.push(r[t.names[n]])}else i.push(r[t.name]);return function(e){var t=1,r=arguments,i=r.length;return e.replace(a,function(e){if(t>=i)return e;var a=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(a);case"%d":return Number(a);case"%v":return""}})}.apply(null,i)},s=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var r=t.outerOrder||s,a=t.innerOrder||o,c=[];return r.forEach(function(t){i[t].forEach(function(r){r.name in e&&null!=e[r.name]?c.push(n(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach(function(e){c.push(n(t,r,e))})})}),e.media.forEach(function(e){c.push(n("m",i.m[0],e)),a.forEach(function(t){i[t].forEach(function(r){r.name in e&&null!=e[r.name]?c.push(n(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach(function(e){c.push(n(t,r,e))})})})}),c.join("\r\n")+"\r\n"}},{"./grammar":63}],67:[function(e,t,r){var i;try{i=e("es5-ext/global")}catch(e){}finally{if(i||"undefined"==typeof window||(i=window),!i)throw new Error("Could not determine global this")}var a=i.WebSocket||i.MozWebSocket,n=e("./version");function s(e,t){return t?new a(e,t):new a(e)}a&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e){Object.defineProperty(s,e,{get:function(){return a[e]}})}),t.exports={w3cwebsocket:a?s:null,version:n}},{"./version":68,"es5-ext/global":15}],68:[function(e,t,r){t.exports=e("../package.json").version},{"../package.json":69}],69:[function(e,t,r){t.exports={_args:[["websocket@1.0.31","/Users/Liuzq/project/node/SDK3/jssdk-v3"]],_from:"websocket@1.0.31",_id:"websocket@1.0.31",_inBundle:!1,_integrity:"sha512-VAouplvGKPiKFDTeCCO65vYHsyay8DqoBSlzIO3fayrfOgU94lQN5a1uWVnFrMLceTJw/+fQXR5PGbUVRaHshQ==",_location:"/websocket",_optional:!0,_phantomChildren:{ms:"2.0.0"},_requested:{type:"version",registry:!0,raw:"websocket@1.0.31",name:"websocket",escapedName:"websocket",rawSpec:"1.0.31",saveSpec:null,fetchSpec:"1.0.31"},_requiredBy:["/protoo-client"],_resolved:"https://registry.npmjs.org/websocket/-/websocket-1.0.31.tgz",_spec:"1.0.31",_where:"/Users/Liuzq/project/node/SDK3/jssdk-v3",author:{name:"Brian McKelvey",email:"theturtle32@gmail.com",url:"https://github.com/theturtle32"},browser:"lib/browser.js",bugs:{url:"https://github.com/theturtle32/WebSocket-Node/issues"},config:{verbose:!1},contributors:[{name:"Iñaki Baz Castillo",email:"ibc@aliax.net",url:"http://dev.sipdoc.net"}],dependencies:{debug:"^2.2.0","es5-ext":"^0.10.50",nan:"^2.14.0","typedarray-to-buffer":"^3.1.5",yaeti:"^0.0.6"},description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",devDependencies:{"buffer-equal":"^1.0.0",faucet:"^0.0.1",gulp:"^4.0.2","gulp-jshint":"^2.0.4",jshint:"^2.0.0","jshint-stylish":"^2.2.1",tape:"^4.9.1"},directories:{lib:"./lib"},engines:{node:">=0.10.0"},homepage:"https://github.com/theturtle32/WebSocket-Node",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],license:"Apache-2.0",main:"index",name:"websocket",repository:{type:"git",url:"git+https://github.com/theturtle32/WebSocket-Node.git"},scripts:{gulp:"gulp",install:"(node-gyp rebuild 2> builderror.log) || (exit 0)",test:"faucet test/unit"},version:"1.0.31"}},{}],70:[function(e,t,r){function i(){}t.exports=i,i.mixin=function(e){var t=e.prototype||e;t.isWildEmitter=!0,t.on=function(e,t,r){this.callbacks=this.callbacks||{};var i=3===arguments.length,a=i?arguments[1]:void 0,n=i?arguments[2]:arguments[1];return n._groupName=a,(this.callbacks[e]=this.callbacks[e]||[]).push(n),this},t.once=function(e,t,r){var i=this,a=3===arguments.length,n=a?arguments[1]:void 0,s=a?arguments[2]:arguments[1];return this.on(e,n,function t(){i.off(e,t),s.apply(this,arguments)}),this},t.releaseGroup=function(e){var t,r,i,a;for(t in this.callbacks=this.callbacks||{},this.callbacks)for(r=0,i=(a=this.callbacks[t]).length;r<i;r++)a[r]._groupName===e&&(a.splice(r,1),r--,i--);return this},t.off=function(e,t){this.callbacks=this.callbacks||{};var r,i=this.callbacks[e];return i?1===arguments.length?(delete this.callbacks[e],this):(-1!==(r=i.indexOf(t))&&(i.splice(r,1),0===i.length&&delete this.callbacks[e]),this):this},t.emit=function(e){this.callbacks=this.callbacks||{};var t,r,i,a=[].slice.call(arguments,1),n=this.callbacks[e],s=this.getWildcardCallbacks(e);if(n)for(t=0,r=(i=n.slice()).length;t<r&&i[t];++t)i[t].apply(this,a);if(s)for(r=s.length,t=0,r=(i=s.slice()).length;t<r&&i[t];++t)i[t].apply(this,[e].concat(a));return this},t.getWildcardCallbacks=function(e){this.callbacks=this.callbacks||{};var t,r,i=[];for(t in this.callbacks)r=t.split("*"),("*"===t||2===r.length&&e.slice(0,r[0].length)===r[0])&&(i=i.concat(this.callbacks[t]));return i}},i.mixin(i)},{}],71:[function(e,t,r){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var a=i(e("@babel/runtime/helpers/classCallCheck")),n=i(e("@babel/runtime/helpers/createClass")),s=i(e("debug")),o="Shinevv",c=function(){function e(t){(0,a.default)(this,e),t?(this._debug=(0,s.default)("".concat(o,":").concat(t)),this._warn=(0,s.default)("".concat(o,":WARN:").concat(t)),this._error=(0,s.default)("".concat(o,":ERROR:").concat(t))):(this._debug=(0,s.default)(o),this._warn=(0,s.default)("".concat(o,":WARN")),this._error=(0,s.default)("".concat(o,":ERROR"))),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}return(0,n.default)(e,[{key:"debug",get:function(){return console.log}},{key:"warn",get:function(){return this._warn}},{key:"error",get:function(){return this._error}}]),e}();r.default=c},{"@babel/runtime/helpers/classCallCheck":2,"@babel/runtime/helpers/createClass":3,"@babel/runtime/helpers/interopRequireDefault":5,debug:13}],72:[function(e,t,r){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault")(e("./Shinevv"));window.Shinevv=i.default},{"./Shinevv":73,"@babel/runtime/helpers/interopRequireDefault":5}],73:[function(e,t,r){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var a=i(e("@babel/runtime/helpers/classCallCheck")),n=i(e("@babel/runtime/helpers/createClass")),s=i(e("./ShinevvImpl")),o=new(i(e("./Logger")).default),c=function(){function e(t,r,i,n,c){(0,a.default)(this,e),o.debug('constructor() [memberId:"%s", displayName:"%s" serverIp:"%s", serverPort:"%d"]',t,r,n,c),this._shinevvImpl=new s.default({memberId:t,displayName:r,userObject:i,serverIp:n,serverPort:c})}return(0,n.default)(e,[{key:"setVideoLabel",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];o.debug("setVideoLabel()"),this._shinevvImpl.setVideoLabel({memberId:e,VideoLabelId:t,addAudio:r})}},{key:"setMasterVideoLabel",value:function(e,t){o.debug("setMasterVideoLabel()"),this._shinevvImpl.setMasterVideoLabel({memberId:e,VideoLabelId:t})}},{key:"setScreenShareLabel",value:function(e){o.debug("setScreenShareLabel()"),this._shinevvImpl.setScreenShareLabel(e)}},{key:"setAudioOnlyLabel",value:function(e){o.debug("setAudioOnlyLabel()"),this._shinevvImpl.setAudioOnlyLabel({VideoLabelId:e})}},{key:"deleteVideoLabel",value:function(e){o.debug("deleteVideoLabel()"),this._shinevvImpl.deleteVideoLabel(e)}},{key:"joinRoom",value:function(e,t,r,i,a,n,s,c,d,l,p,u,h,m,f,g,v,b){o.debug("joinRoom()");var _=!1,y=!1;switch(t){case"video":_=!0,y=!0;break;case"audio":_=!0,y=!1;break;case"none":_=!1,y=!1}this._shinevvImpl.joinRoom({roomId:e,mediaType:{audio:_,video:y},acessToken:r,onSuccess:i,onGetMemberList:a,onFail:n,onOpenMediaFail:s,onDisconnected:c,onClose:d,onNewMemberJoined:l,onMemberLeft:p,onMemberStatusChange:u,onRecvUserData:h,onRecvTimeRoomLast:m,onMemberVolumeChange:f,onRecvScreenShare:g,onActiveSpeaker:v,onRecvDeviceVideo:b})}},{key:"getDeviceList",value:function(e){o.debug("getDeviceList()"),this._shinevvImpl.getDeviceList(e)}},{key:"enableDevices",value:function(e,t){o.debug("enableDevices()"),this._shinevvImpl.enableDevices(e,t)}},{key:"disableDevices",value:function(e){o.debug("disableDevices()"),this._shinevvImpl.disableDevices(e)}},{key:"setResolution",value:function(e,t){o.debug("setResolution(%s x %s)",e,t),this._shinevvImpl.setResolution(e,t)}},{key:"getMemberList",value:function(){o.debug("getMemberList()"),this._shinevvImpl.getMemberList()}},{key:"leaveRoom",value:function(){o.debug("leaveRoom()"),this._shinevvImpl.leaveRoom()}},{key:"changeBitrate",value:function(e,t){o.debug("changeBitrate()"),this._shinevvImpl.changeBitrate(e,t)}},{key:"muteMic",value:function(){o.debug("muteMic()"),this._shinevvImpl.muteMic()}},{key:"unmuteMic",value:function(){o.debug("unmuteMic()"),this._shinevvImpl.unmuteMic()}},{key:"disableWebcam",value:function(){o.debug("disableWebcam()"),this._shinevvImpl.disableWebcam()}},{key:"enableWebcam",value:function(){o.debug("enableWebcam()"),this._shinevvImpl.tryToEnableWebcam()}},{key:"changeWebcam",value:function(){o.debug("enableWebcam()"),this._shinevvImpl.changeWebcam()}},{key:"enableMemberVideo",value:function(e){o.debug("enableMemberVideo()"),this._shinevvImpl.enableMemberVideo(e)}},{key:"disableMemberVideo",value:function(e){o.debug("disableMemberVideo()"),this._shinevvImpl.disableMemberVideo(e)}},{key:"enableMemberAudio",value:function(e){o.debug("enableMemberAudio()"),this._shinevvImpl.enableMemberAudio(e)}},{key:"disableMemberAudio",value:function(e){o.debug("disableMemberAudio()"),this._shinevvImpl.disableMemberAudio(e)}},{key:"enableScreenShare",value:function(e,t,r){o.debug("enableScreenShare()"),this._shinevvImpl.enableScreenShare(e,t,r)}},{key:"disableScreenShare",value:function(e,t){o.debug("disableScreenShare()"),this._shinevvImpl.disableScreenShare(e,t)}},{key:"startRecord",value:function(e,t,r){o.debug("startRecord()"),this._shinevvImpl.startRecord(e,t,r)}},{key:"stopRecord",value:function(e){o.debug("stopRecord()"),this._shinevvImpl.stopRecord(e)}},{key:"sendUserData",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];o.debug("sendUserData()"),this._shinevvImpl.sendUserData(e,t,r,i)}},{key:"getUserDataHistory",value:function(e,t){o.debug("getUserDataHistory()"),this._shinevvImpl.getUserDataHistory(e,t)}},{key:"focusOnMember",value:function(e){o.debug("focusOnMember() [memberId:%s]",e),this._shinevvImpl.focusOnMember(e)}},{key:"setMemberProfile",value:function(e,t){o.debug("setMemberProfile() [memberId:%s] [profile:%s]",e,t),this._shinevvImpl.setMemberProfile(e,t)}}]),e}();r.default=c},{"./Logger":71,"./ShinevvImpl":74,"@babel/runtime/helpers/classCallCheck":2,"@babel/runtime/helpers/createClass":3,"@babel/runtime/helpers/interopRequireDefault":5}],74:[function(e,t,r){"use strict";var i=e("@babel/runtime/helpers/interopRequireWildcard"),a=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var n=a(e("@babel/runtime/regenerator")),s=a(e("@babel/runtime/helpers/defineProperty")),o=a(e("@babel/runtime/helpers/asyncToGenerator")),c=a(e("@babel/runtime/helpers/classCallCheck")),d=a(e("@babel/runtime/helpers/createClass")),l=a(e("protoo-client")),p=i(e("mediasoup-client")),u=a(e("./Logger")),h=e("./urlFactory"),m=a(e("./deviceInfo")),f=a(e("hark")),g=a(e("recordrtc"));function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,i)}return r}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach(function(t){(0,s.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var _=new u.default("ShinevvImpl"),y={qvga:{width:{ideal:320},height:{ideal:240}},vga:{width:{ideal:640},height:{ideal:480}},hd:{width:{ideal:1280},height:{ideal:720}}},w={optional:[{googDscp:!0}]},S=[{maxBitrate:18e4,scaleResolutionDownBy:4},{maxBitrate:36e4,scaleResolutionDownBy:2},{maxBitrate:15e5,scaleResolutionDownBy:1}],R=[{scalabilityMode:"S3T3_KEY"}],k=[{scalabilityMode:"S3T3",dtx:!0}],P=function(){function e(t){(0,c.default)(this,e),_.debug('constructor() [memberId:"%s", displayName:"%s" userObject:%o serverIp:"%s", serverPort:"%d"]',t.memberId,t.displayName,t.userObject,t.serverIp,t.serverPort);this._closed=!1,this._roomId=null,this._peerName=t.memberId,this._displayName=t.displayName,this._userObject=t.userObject,this._serverIp=t.serverIp,this._serverPort=t.serverPort,this._useSimulcast=!0,this._protoo=null,this._device=(0,m.default)(),this._forceTcp=!1,this._produce=!0,this._consume=!0,this._mediasoupDevice=null,this._sendTransport=null,this._recvTransport=null,this._micProducer=null,this._webcamProducer=null,this._chatDataProducer=null,this._botDataProducer=null,this._screenShareProducer=null,this._deviceProducers=new Map,this._webcams=new Map,this._consumers=new Map,this._dataConsumers=new Map,this._webcam={device:null,resolution:"hd"},this._videoLabels=new Map,this._peerTracks=new Map,this._peerConsumerPause=new Map,this._joinRoomObject=null,this._recordRTC=null,this._recordStreams=[],this._screenShareStream=null,this._screenWidth=1280,this._screenHeight=720,this._joinedResponseData="",this._masterVideoLabelObject=null,this._audioOnlyLabelObject=null,this._focusOnPeer=null,this._peerHarkVolume=new Map,this._useSharingSimulcast=!0,this._capWidth=640,this._capHeight=640,this._screenShareLabel=void 0,this._peers=new Map,k[0].scalabilityMode="S3T3",R[0].scalabilityMode="".concat("S3T3","_KEY")}return(0,d.default)(e,[{key:"setVideoLabel",value:function(e){if(_.debug("impl setVideoLabel(OBJECT = %o)",e),e.memberId&&e.VideoLabelId)if(this._videoLabels.has(e.memberId)&&this._videoLabels.delete(e.memberId),this._videoLabels.set(e.memberId,e.VideoLabelId),this._peerTracks.has(e.memberId)){var t=this._peerTracks.get(e.memberId);t.addAudio=e.addAudio;var r=new MediaStream,i=!1;t.videoTrack&&(_.debug("impl setVideoLabel stream.addTrack(trackInfo.videoTrack)  peerName = %s",e.memberId),r.addTrack(t.videoTrack),i=!0),t.audioTrack&&e.memberId!=this._peerName&&t.addAudio&&(_.debug("impl setVideoLabel stream.addTrack(trackInfo.audioTrack)  peerName = %s",e.memberId),r.addTrack(t.audioTrack),i=!0);var a=document.getElementById(e.VideoLabelId);a&&i&&(a.srcObject=r)}else this._peerTracks.set(e.memberId,{videoTrack:null,audioTrack:null,addAudio:e.addAudio})}},{key:"setMasterVideoLabel",value:function(e){if(_.debug("impl setMasterVideoLabel(OBJECT = %o)",e),e.memberId&&e.VideoLabelId){this._masterVideoLabelObject=e;var t=document.getElementById(e.VideoLabelId),r=new MediaStream,i=!1,a=void 0;if(this._peerTracks.has(e.memberId))a=this._peerTracks.get(e.memberId).videoTrack;null!=a&&(r.addTrack(a),i=!0),i&&t&&(t.srcObject=r)}}},{key:"setScreenShareLabel",value:function(e){_.debug("impl setScreenShareLabel()"),this._screenShareLabel=e;var t=document.getElementById(e);t&&this._screenShareStream&&(t.srcObject=this._screenShareStream)}},{key:"setAudioOnlyLabel",value:function(e){var t=this;if(_.debug("impl setAudioOnlyLabel(OBJECT = %o)",e),e.VideoLabelId){this._audioOnlyLabelObject=e;var r=document.getElementById(e.VideoLabelId),i=new MediaStream,a=!1;this._peerTracks.forEach(function(e,r){var n=e;n.audioTrack&&r!=t._peerName&&(i.addTrack(n.audioTrack),a=!0)}),a&&r&&(r.srcObject=i)}}},{key:"deleteVideoLabel",value:function(e){if(_.debug("impl deleteVideoLabel() memberId=%s",e),e&&this._videoLabels.has(e)){var t=this._videoLabels.get(e);this._videoLabels.delete(e),document.getElementById(t).srcObject=null}}},{key:"joinRoom",value:function(e){_.debug("connectSocket(OBJECT = %o)",e),this._joinRoomObject=e,this._roomId=e.roomId;var t=(0,h.getProtooUrl)({server:this._serverIp,port:this._serverPort,peerName:this._peerName,roomId:this._roomId,role:"student",displayName:this._displayName,token:e.acessToken}),r=new l.default.WebSocketTransport(t);r||e.onFail&&e.onFail("can not connect the server"),this._protoo=new l.default.Peer(r),this._handleProtoo(),this._peerConsumerPause.set(this._peerName,{audio:!1,video:!1})}},{key:"_handleProtoo",value:function(){var e=this,t=this._joinRoomObject;this._protoo.on("open",function(){_.debug('_protoo "open" event'),t.onSuccess&&t.onSuccess(),e._joinRoom(t)}),this._protoo.on("disconnected",function(){_.warn('socket "disconnected" event'),t.onDisconnected&&t.onDisconnected()}),this._protoo.on("close",function(){e._joinedResponseData="",e._closed||t.onClose&&t.onClose("protoo close")}),this._protoo.on("failed",function(){t.onFail&&t.onFail("WebSocket connection failed")}),this._protoo.on("request",function(){var r=(0,o.default)(n.default.mark(function r(i,a,s){var o,c,d,l,p,u,h,m,f,g,v,y,w,S,R,k,P,T,C,D,x;return n.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:_.debug('proto "request" event [method:%s, data:%o]',i.method,i.data),r.t0=i.method,r.next="newConsumer"===r.t0?4:"newDataConsumer"===r.t0?23:"receive-user-data"===r.t0?45:"on-get-user-data-history"===r.t0?49:"answer-for-enable-webcam"===r.t0?53:57;break;case 4:if(e._consume){r.next=7;break}return s(403,"I do not want to consume"),r.abrupt("return");case 7:return o=i.data,c=o.peerId,d=o.producerId,l=o.id,p=o.kind,u=o.rtpParameters,o.type,h=o.appData,o.producerPaused,"audio"===p&&(m={opusStereo:1}),r.prev=9,r.next=12,e._recvTransport.consume({id:l,producerId:d,kind:p,rtpParameters:u,codecOptions:m,appData:b({},h,{peerId:c})});case 12:f=r.sent,e._consumers.set(f.id,f),f.on("transportclose",function(){e._consumers.delete(f.id)}),h.share?e._handleScreenShareConsumer(t,f,!0):e._setStreamForVideoLabel(c,p,f.track,t),a(),r.next=22;break;case 19:r.prev=19,r.t1=r.catch(9),_.error('"newConsumer" request failed:%o',r.t1);case 22:return r.abrupt("break",57);case 23:if(e._consume){r.next=26;break}return s(403,"I do not want to data consume"),r.abrupt("return");case 26:return g=i.data,v=g.peerId,y=g.dataProducerId,w=g.id,S=g.sctpStreamParameters,R=g.appData,r.prev=27,r.next=30,e._recvTransport.consumeData({id:w,dataProducerId:y,sctpStreamParameters:S,appData:b({},R,{peerId:v})});case 30:k=r.sent,e._dataConsumers.set(k.id,k),k.on("transportclose",function(){e._dataConsumers.delete(k.id)}),k.on("open",function(){_.debug('DataConsumer "open" event')}),k.on("close",function(){_.error('DataConsumer "close" event'),e._dataConsumers.delete(k.id)}),k.on("error",function(e){_.error('DataConsumer "error" event:%o',e)}),k.on("message",function(e){_.debug('DataConsumer "message" event: %o',e)}),window.DC=k,a(),r.next=44;break;case 41:r.prev=41,r.t2=r.catch(27),_.error('"newDataConsumer" request failed:%o',r.t2);case 44:return r.abrupt("break",57);case 45:return a(),P=i.data.message,t&&t.onRecvUserData&&t.onRecvUserData(P.peerName,P.data),r.abrupt("break",57);case 49:return a(),T=i.data.historyData,t&&t.onGetUserDataHistory&&t.onGetUserDataHistory(T),r.abrupt("break",57);case 53:return a(),C=i.data,D=C.ok,x=C.reason,D?e.enableWebcam():t&&t.onOpenMediaFail&&t.onOpenMediaFail(x),r.abrupt("break",57);case 57:case"end":return r.stop()}},r,null,[[9,19],[27,41]])}));return function(e,t,i){return r.apply(this,arguments)}}()),this._protoo.on("notification",function(r){switch(_.debug('proto "notification" event [method:%s, data:%o]',r.method,r.data),r.method){case"producerScore":break;case"newPeer":var i=r.data;t.onNewMemberJoined&&t.onNewMemberJoined(i.id,i.displayName,i.device),e._handlePeer(i,!0);break;case"peerClosed":var a=r.data.peerId,n=e._peers.get(a);e._handlePeer(n,!1);break;case"peerDisplayNameChanged":var s=r.data;s.peerId,s.displayName,s.oldDisplayName;break;case"consumerClosed":var o=r.data.consumerId,c=e._consumers.get(o);if(!c)break;c.close(),e._consumers.delete(o);var d=c.appData,l=d.share,p=d.peerId;l?e._handleScreenShareConsumer(t,c,!1):e._setStreamForVideoLabel(p,c.kind,null,t);break;case"consumerPaused":var u=r.data.consumerId,h=e._consumers.get(u);if(!h)break;var m=h.appData,f=m.share,g=m.peerId;f?e._handleScreenShareConsumer(t,h,!1):e._setStreamForVideoLabel(g,h.kind,null,t);break;case"consumerResumed":var v=r.data.consumerId,b=e._consumers.get(v);if(!b)break;var y=b.appData,w=y.share,S=y.peerId;w?e._handleScreenShareConsumer(t,b,!0):e._setStreamForVideoLabel(S,b.kind,b.track,t);break;case"consumerLayersChanged":var R=r.data,k=R.consumerId;R.spatialLayer,R.temporalLayer;if(!e._consumers.get(k))break;break;case"consumerScore":var P=r.data;P.consumerId,P.score;break;case"dataConsumerClosed":var T=r.data.dataConsumerId,C=e._dataConsumers.get(T);if(!C)break;C.close(),e._dataConsumers.delete(T);C.appData.peerId;break;case"activeSpeaker":var D=r.data.peerId;t.onActiveSpeaker&&t.onActiveSpeaker(D);break;default:_.error('unknown protoo notification.method "%s"',r.method)}})}},{key:"getDeviceList",value:function(e){var t=this;return _.debug("impl getDeviceList()"),this._webcams=new Map,Promise.resolve().then(function(){return _.debug("getDeviceList() | calling enumerateDevices()"),navigator.mediaDevices.enumerateDevices()}).then(function(r){var i=!0,a=!1,n=void 0;try{for(var s,o=r[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var c=s.value;"videoinput"===c.kind&&t._webcams.set(c.deviceId,c)}}catch(e){a=!0,n=e}finally{try{i||null==o.return||o.return()}finally{if(a)throw n}}e&&e(t._webcams)}).catch(function(e){_.error("getDeviceList() failed:%o",e)})}},{key:"_openDeviceStream",value:function(e,t,r,i){var a,n=this;return _.debug("impl openDeviceStream()"),Promise.resolve().then(function(){return navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:e},width:{ideal:t},height:{ideal:r}}})}).then(function(t){var r="device_".concat(String(e)),i=t.getVideoTracks()[0];return console.log("chence _openDeviceStream track = %o",i),a=n._room.createProducer(i,{simulcast:!1},{source:r}),console.log("111xw"),i.stop(),a.send(n._sendTransport)}).then(function(){n._deviceProducers.set(e,a),a.on("close",function(t){_.debug('device Producer "close" event [originator:%s]',t),n._deviceProducers.delete(e)}),a.on("pause",function(e){_.debug('device Producer "pause" event [originator:%s]',e)}),a.on("resume",function(e){_.debug('device Producer "resume" event [originator:%s]',e)}),a.on("handled",function(){_.debug('device Producer "handled" event')}),a.on("unhandled",function(){_.debug('device Producer "unhandled" event')}),i&&i(e,a.track)}).catch(function(e){throw _.error("_openDeviceStream() failed:%o",e),a&&a.close(),e})}},{key:"enableDevices",value:function(){var e=(0,o.default)(n.default.mark(function e(t,r){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _.debug("impl enableDevices()"),e.abrupt("return",Promise.resolve().then(function(){}).catch(function(e){_.error("enableWebcam() | failed: %o",e)}));case 2:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"disableDevices",value:function(e){var t=this;_.debug("impl disableDevices()");var r=!0,i=!1,a=void 0;try{for(var n,s=function(){var e=n.value,r=t._deviceProducers.get(e);Promise.resolve().then(function(){r.close()}).catch(function(t){_.error("disableDevices(%s) | failed: %o",e,t)})},o=e[Symbol.iterator]();!(r=(n=o.next()).done);r=!0)s()}catch(e){i=!0,a=e}finally{try{r||null==o.return||o.return()}finally{if(i)throw a}}}},{key:"setResolution",value:function(e,t){_.debug("impl setResolution()"),this._capWidth=e,this._capHeight=t}},{key:"leaveRoom",value:function(){var e=this;this._closed||(this._closed=!0,_.debug("leaveRoom()"),this._protoo.close(),this._sendTransport&&this._sendTransport.close(),this._recvTransport&&this._recvTransport.close(),this._peers.forEach(function(t,r,i){e._handlePeer(t,!1)}))}},{key:"changeBitrate",value:function(e,t){this._protoo&&this._protoo.request("changeTransportBitrate",{producing:e,consuming:t})}},{key:"muteMic",value:function(){(_.debug("muteMic()"),this._micProducer&&this._micProducer.pause(),this._protoo.request("pauseProducer",{producerId:this._micProducer.id}),this._peerConsumerPause.has(this._peerName))&&(this._peerConsumerPause.get(this._peerName).audio=!0)}},{key:"unmuteMic",value:function(){(_.debug("unmuteMic()"),this._micProducer&&this._micProducer.resume(),this._protoo.request("resumeProducer",{producerId:this._micProducer.id}),this._peerConsumerPause.has(this._peerName))&&(this._peerConsumerPause.get(this._peerName).audio=!1)}},{key:"enableWebcam",value:function(){var e=(0,o.default)(n.default.mark(function e(t){var r,i,a,s,o,c,d,l=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_.debug("enableWebcam()"),!this._webcamProducer){e.next=3;break}return e.abrupt("return");case 3:if(this._mediasoupDevice.canProduce("video")){e.next=6;break}return _.error("enableWebcam() | cannot produce video"),e.abrupt("return");case 6:if(e.prev=6,this._externalVideo){e.next=21;break}return e.next=10,this._updateWebcams();case 10:if(i=this._webcam.device,a=this._webcam.resolution,i){e.next=14;break}throw new Error("no webcam devices");case 14:return _.debug("enableWebcam() | calling getUserMedia()"),e.next=17,navigator.mediaDevices.getUserMedia({video:b({deviceId:{exact:i.deviceId}},y[a])});case 17:s=e.sent,r=s.getVideoTracks()[0],e.next=26;break;case 21:return i={label:"external video"},e.next=24,this._getExternalVideoStream();case 24:o=e.sent,r=o.getVideoTracks()[0].clone();case 26:if(!this._useSimulcast){e.next=34;break}return c=this._mediasoupDevice.rtpCapabilities.codecs.find(function(e){return"video"===e.kind}),d="video/vp9"===c.mimeType.toLowerCase()?R:S,e.next=31,this._sendTransport.produce({track:r,encodings:d,codecOptions:{videoGoogleStartBitrate:1e3}});case 31:this._webcamProducer=e.sent,e.next=37;break;case 34:return e.next=36,this._sendTransport.produce({track:r});case 36:this._webcamProducer=e.sent;case 37:this._setStreamForVideoLabel(this._peerName,"video",this._webcamProducer.track,t),this._webcamProducer.on("transportclose",function(){l._webcamProducer=null}),this._webcamProducer.on("trackended",function(){l.disableWebcam().catch(function(){})}),e.next=47;break;case 42:e.prev=42,e.t0=e.catch(6),_.error("enableWebcam() | failed:%o",e.t0),t.onOpenMediaFail&&t.onOpenMediaFail(e.t0.toString()),r&&r.stop();case 47:case"end":return e.stop()}},e,this,[[6,42]])}));return function(t){return e.apply(this,arguments)}}()},{key:"changeWebcam",value:function(){var e=(0,o.default)(n.default.mark(function e(){var t,r,i,a,s,o;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _.debug("changeWebcam()"),e.prev=1,e.next=4,this._updateWebcams();case 4:if(t=Array.from(this._webcams.keys()),r=t.length,i=this._webcam.device?this._webcam.device.deviceId:void 0,(a=t.indexOf(i))<r-1?a++:a=0,this._webcam.device=this._webcams.get(t[a]),_.debug("changeWebcam() | new selected webcam [device:%o]",this._webcam.device),this._webcam.resolution="hd",this._webcam.device){e.next=14;break}throw new Error("no webcam devices");case 14:return this._webcamProducer.track.stop(),_.debug("changeWebcam() | calling getUserMedia()"),e.next=18,navigator.mediaDevices.getUserMedia({video:b({deviceId:{exact:this._webcam.device.deviceId}},y[this._webcam.resolution])});case 18:return s=e.sent,o=s.getVideoTracks()[0],e.next=22,this._webcamProducer.replaceTrack({track:o});case 22:this._setStreamForVideoLabel(this._peerName,"video",o,this._joinRoomObject),this._peerConsumerPause.has(this._peerName)&&(this._peerConsumerPause.get(this._peerName).video=!1),e.next=29;break;case 26:e.prev=26,e.t0=e.catch(1),_.error("changeWebcam() | failed: %o",e.t0);case 29:case"end":return e.stop()}},e,this,[[1,26]])}));return function(){return e.apply(this,arguments)}}()},{key:"tryToEnableWebcam",value:function(){var e=this;this._protoo.request("ask-for-enable-webcam",{}).catch(function(t){_.error("ask-for-enable-webcam() | failed: %o",t),e._joinRoomObject.onOpenMediaFail&&e._joinRoomObject.onOpenMediaFail(t.toString())})}},{key:"disableWebcam",value:function(){(_.debug("disableWebcam()"),this._webcamProducer)&&(this._webcamProducer.close(),this._protoo.request("closeProducer",{producerId:this._webcamProducer.id}),this._webcamProducer=null,this._peerConsumerPause.has(this._peerName)&&(this._peerConsumerPause.get(this._peerName).video=!0))}},{key:"enableMemberVideo",value:function(e){(_.debug("impl enableMemberVideo(memberId=%o)",e),this._peerConsumerPause.has(e))&&(this._peerConsumerPause.get(e).video=!1);this._consumers.forEach(function(t,r,i){t.appData.peerId==e&&"video"==t.kind&&t.resume()})}},{key:"disableMemberVideo",value:function(e){(_.debug("impl disableMemberVideo(memberId=%s)",e),this._peerConsumerPause.has(e))&&(this._peerConsumerPause.get(e).video=!0);this._consumers.forEach(function(t,r,i){t.appData.peerId==e&&"video"==t.kind&&t.pause()})}},{key:"enableMemberAudio",value:function(e){(_.debug("enableMemberAudio()"),this._peerConsumerPause.has(e))&&(this._peerConsumerPause.get(e).audio=!1);this._consumers.forEach(function(t,r,i){t.appData.peerId==e&&"audio"==t.kind&&t.resume()})}},{key:"disableMemberAudio",value:function(e){(_.debug("disableMemberAudio()"),this._peerConsumerPause.has(e))&&(this._peerConsumerPause.get(e).audio=!0);this._consumers.forEach(function(t,r,i){t.appData.peerId==e&&"audio"==t.kind&&t.pause()})}},{key:"enableScreenShare",value:function(){var e=(0,o.default)(n.default.mark(function e(t,r,i){var a,s,o,c,d,l=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_.debug("enableScreenShare()"),!this._screenShareProducer){e.next=3;break}return e.abrupt("return");case 3:if(this._mediasoupDevice.canProduce("video")){e.next=6;break}return _.error("enableShare() | cannot produce video"),e.abrupt("return");case 6:return e.prev=6,e.next=9,this._prepareScreenShareStream(t);case 9:if(o=e.sent){e.next=12;break}return e.abrupt("return");case 12:if(a=o.getVideoTracks()[0],s=o.getAudioTracks()[0],!this._useSharingSimulcast){e.next=22;break}return c=this._mediasoupDevice.rtpCapabilities.codecs.find(function(e){return"video"===e.kind}),d="video/vp9"===c.mimeType.toLowerCase()?k:S.map(function(e){return b({},e,{dtx:!0})}),e.next=19,this._sendTransport.produce({track:a,encodings:d,codecOptions:{videoGoogleStartBitrate:1e3},appData:{share:!0}});case 19:this._screenShareProducer=e.sent,e.next=25;break;case 22:return e.next=24,this._sendTransport.produce({track:a});case 24:this._screenShareProducer=e.sent;case 25:r&&r(),this._screenShareProducer.on("transportclose",function(){l._screenShareProducer=null}),this._screenShareProducer.on("trackended",function(){l.disableShare()}),e.next=35;break;case 30:e.prev=30,e.t0=e.catch(6),_.error("enableScreenShare() failed:%o",e.t0),i&&i(e.t0.toString()),a&&(a.stop(),s.stop());case 35:case"end":return e.stop()}},e,this,[[6,30]])}));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"disableShare",value:function(){var e=(0,o.default)(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_.debug("disableShare()"),this._screenShareProducer){e.next=3;break}return e.abrupt("return");case 3:return this._screenShareProducer.close(),e.next=6,this._protoo.request("closeProducer",{producerId:this._screenShareProducer.id});case 6:this._screenShareProducer=null;case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"disableScreenShare",value:function(){var e=(0,o.default)(n.default.mark(function e(t,r){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _.debug("disableScreenShare()"),e.prev=1,e.next=4,this.disableShare();case 4:t&&t(),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),_.error("disableScreenShare() | failed: %o",e.t0),r&&r();case 11:case"end":return e.stop()}},e,this,[[1,7]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"startRecord",value:function(e,t,r){var i=this;return _.debug("startRecord()"),Promise.resolve().then(function(){return i._prepareScreenShareStream()}).then(function(a){i._peerTracks.forEach(function(e,t,r){var a=e,n=new MediaStream;a.audioTrack&&n.addTrack(a.audioTrack),i._recordStreams.push(n)}),i._recordStreams.push(a),console.log("screenShareStream width:%s , height:%s",a.getVideoTracks()[0].getSettings().width,a.getVideoTracks()[0].getSettings().height);var n=i._screenWidth,s=i._screenHeight,o=2e6;e&&(n=e),t&&(s=t),r&&(o=r);var c={mimeType:"video/webm;codecs=vp9",audioBitsPerSecond:o,videoBitsPerSecond:o,bitsPerSecond:o,frameInterval:40,video:{width:n,height:s}};i._recordRTC=(0,g.default)(i._recordStreams,c),i._recordRTC.startRecording()})}},{key:"stopRecord",value:function(e){var t=this;_.debug("impl stopRecord()"),this._recordRTC.stopRecording(function(r){var i=t._recordRTC.getBlob();e&&e(i),t._recordRTC.getDataURL(function(e){}),t._screenShareStream.getTracks()[0].stop(),t._screenShareStream=null,t._recordRTC.destroy(),t._recordRTC=null})}},{key:"sendUserData",value:function(e,t,r,i){_.debug("impl sendUserData()");var a=[],n=!0,s=!1,o=void 0;try{for(var c,d=i[Symbol.iterator]();!(n=(c=d.next()).done);n=!0){var l=c.value;a.push({target:l})}}catch(e){s=!0,o=e}finally{try{n||null==d.return||d.return()}finally{if(s)throw o}}var p={data:e,peerName:this._peerName,targets:a};return this._protoo.request("send-user-data",{message:p}).then(function(){t&&t()}).catch(function(e){_.error("sendUserData() | failed: %o",e),r&&r(e.toString())})}},{key:"getUserDataHistory",value:function(e,t){return _.debug("impl getUserDataHistory()"),e&&this._joinRoomObject&&(this._joinRoomObject.onGetUserDataHistory=e),this._protoo.request("get-user-data-history",{}).then(function(){}).catch(function(e){_.error("getUserDataHistory() | failed: %o",e),t&&t(e.toString())})}},{key:"focusOnMember",value:function(e){if(_.debug("impl focusOnMember() [memberId:%s]",e),this._peerName!=e){this._focusOnPeer=e;var t=!0,r=!1,i=void 0;try{for(var a,n=this._room.peers[Symbol.iterator]();!(t=(a=n.next()).done);t=!0){var s=a.value;if(s.name==e){var o=!0,c=!1,d=void 0;try{for(var l,p=s.consumers[Symbol.iterator]();!(o=(l=p.next()).done);o=!0){var u=l.value;if("video"==u.kind){u.setPreferredProfile("high");break}}}catch(e){c=!0,d=e}finally{try{o||null==p.return||p.return()}finally{if(c)throw d}}}else{var h=!0,m=!1,f=void 0;try{for(var g,v=s.consumers[Symbol.iterator]();!(h=(g=v.next()).done);h=!0){var b=g.value;if("video"==b.kind){b.setPreferredProfile("low");break}}}catch(e){m=!0,f=e}finally{try{h||null==v.return||v.return()}finally{if(m)throw f}}}}}catch(e){r=!0,i=e}finally{try{t||null==n.return||n.return()}finally{if(r)throw i}}}}},{key:"setMemberProfile",value:function(e,t){if(_.debug("impl setMemberProfile() [memberId:%s] [profile:%s]",e,t),"high"==t||"low"==t){var r=this._room.peers,i=!0,a=!1,n=void 0;try{for(var s,o=r[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var c=s.value;if(c.name==e){var d=!0,l=!1,p=void 0;try{for(var u,h=c.consumers[Symbol.iterator]();!(d=(u=h.next()).done);d=!0){var m=u.value;if("video"==m.kind){m.setPreferredProfile(t);break}}}catch(e){l=!0,p=e}finally{try{d||null==h.return||h.return()}finally{if(l)throw p}}break}}}catch(e){a=!0,n=e}finally{try{i||null==o.return||o.return()}finally{if(a)throw n}}}}},{key:"enableMic",value:function(){var e=(0,o.default)(n.default.mark(function e(t){var r,i,a=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_.debug("enableMic()"),!this._micProducer){e.next=3;break}return e.abrupt("return");case 3:if(this._mediasoupDevice.canProduce("audio")){e.next=6;break}return _.error("enableMic() | cannot produce audio"),e.abrupt("return");case 6:return e.prev=6,_.debug("enableMic() | calling getUserMedia()"),e.next=10,navigator.mediaDevices.getUserMedia({audio:!0});case 10:return i=e.sent,r=i.getAudioTracks()[0],e.next=14,this._sendTransport.produce({track:r,codecOptions:{opusStereo:1,opusDtx:1}});case 14:this._micProducer=e.sent,this._micProducer.on("transportclose",function(){a._micProducer=null}),this._micProducer.on("trackended",function(){a.disableMic().catch(function(){})}),this._setStreamForVideoLabel(this._peerName,"audio",r,t),e.next=25;break;case 20:e.prev=20,e.t0=e.catch(6),_.error("enableMic() | failed:%o",e.t0),t.onOpenMediaFail&&t.onOpenMediaFail(e.t0.toString()),r&&r.stop();case 25:case"end":return e.stop()}},e,this,[[6,20]])}));return function(t){return e.apply(this,arguments)}}()},{key:"disableMic",value:function(){var e=(0,o.default)(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_.debug("disableMic()"),this._micProducer){e.next=3;break}return e.abrupt("return");case 3:return this._micProducer.close(),e.prev=4,e.next=7,this._protoo.request("closeProducer",{producerId:this._micProducer.id});case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(4),_.error("Error closing server-side mic Producer: ".concat(e.t0));case 12:this._micProducer=null;case 13:case"end":return e.stop()}},e,this,[[4,9]])}));return function(){return e.apply(this,arguments)}}()},{key:"_setWebcamProducer",value:function(e){var t,r=this;return this._room.canSend("video")?this._webcamProducer?Promise.reject(new Error("webcam Producer already exists")):Promise.resolve().then(function(){var e=r._webcam,t=e.device,i=e.resolution;if(!t)throw new Error("no webcam devices");return _.debug("_setWebcamProducer() | calling getUserMedia() resolution = %s",i),navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:t.deviceId},width:{ideal:r._capWidth},height:{ideal:r._capHeight}}})}).then(function(e){var i=e.getVideoTracks()[0];return t=r._room.createProducer(i,{simulcast:r._useSimulcast},{source:"webcam"}),i.stop(),t.send(r._sendTransport)}).then(function(){r._webcamProducer=t;r._webcam.device;r._setStreamForVideoLabel(r._peerName,"video",t.track,e),t.on("close",function(t){_.debug('webcam Producer "close" event [originator:%s]',t),r._webcamProducer=null,r._setStreamForVideoLabel(r._peerName,"video",null,e)}),t.on("pause",function(t){_.debug('webcam Producer "pause" event [originator:%s]',t),r._setStreamForVideoLabel(r._peerName,"video",null,e)}),t.on("resume",function(i){_.debug('webcam Producer "resume" event [originator:%s]',i),r._setStreamForVideoLabel(r._peerName,"video",t.track,e)}),t.on("handled",function(){_.debug('webcam Producer "handled" event')}),t.on("unhandled",function(){_.debug('webcam Producer "unhandled" event')})}).then(function(){_.debug("_setWebcamProducer() succeeded")}).catch(function(r){throw _.error("_setWebcamProducer() failed:%o",r),e.onOpenMediaFail&&e.onOpenMediaFail(r.toString()),t&&t.close(),r}):Promise.reject(new Error("cannot send video"))}},{key:"_updateWebcams",value:function(){var e=(0,o.default)(n.default.mark(function e(){var t,r,i,a,s,o,c,d,l,p;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _.debug("_updateWebcams()"),this._webcams=new Map,_.debug("_updateWebcams() | calling enumerateDevices()"),e.next=5,navigator.mediaDevices.enumerateDevices();case 5:t=e.sent,r=!0,i=!1,a=void 0,e.prev=9,s=t[Symbol.iterator]();case 11:if(r=(o=s.next()).done){e.next=19;break}if("videoinput"===(c=o.value).kind){e.next=15;break}return e.abrupt("continue",16);case 15:this._webcams.set(c.deviceId,c);case 16:r=!0,e.next=11;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(9),i=!0,a=e.t0;case 25:e.prev=25,e.prev=26,r||null==s.return||s.return();case 28:if(e.prev=28,!i){e.next=31;break}throw a;case 31:return e.finish(28);case 32:return e.finish(25);case 33:d=Array.from(this._webcams.values()),l=d.length,p=this._webcam.device?this._webcam.device.deviceId:void 0,_.debug("_updateWebcams() [webcams:%o]",d),0===l?this._webcam.device=null:this._webcams.has(p)||(this._webcam.device=d[0]);case 38:case"end":return e.stop()}},e,this,[[9,21,25,33],[26,,28,32]])}));return function(){return e.apply(this,arguments)}}()},{key:"_joinRoom",value:function(){var e=(0,o.default)(n.default.mark(function e(t){var r,i,a,s,c,d,l,u,h,m,f,g,v,b,y,S,R,k,P,T,C,D,x,M=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _.debug("_joinRoom()"),e.prev=1,this._mediasoupDevice=new p.Device,e.next=5,this._protoo.request("getRouterRtpCapabilities");case 5:return r=e.sent,e.next=8,this._mediasoupDevice.load({routerRtpCapabilities:r});case 8:return e.next=10,navigator.mediaDevices.getUserMedia({audio:!0});case 10:if(i=e.sent,(a=i.getAudioTracks()[0]).enabled=!1,setTimeout(function(){return a.stop()},12e4),!this._produce){e.next=23;break}return e.next=17,this._protoo.request("createWebRtcTransport",{forceTcp:this._forceTcp,producing:!0,consuming:!1,sctpCapabilities:this._mediasoupDevice.sctpCapabilities});case 17:s=e.sent,c=s.id,d=s.iceParameters,l=s.iceCandidates,u=s.dtlsParameters,h=s.sctpParameters,this._sendTransport=this._mediasoupDevice.createSendTransport({id:c,iceParameters:d,iceCandidates:l,dtlsParameters:u,sctpParameters:h,proprietaryConstraints:w}),this._sendTransport.on("connect",function(e,t,r){var i=e.dtlsParameters;M._protoo.request("connectWebRtcTransport",{transportId:M._sendTransport.id,dtlsParameters:i}).then(t).catch(r)}),this._sendTransport.on("produce",function(){var e=(0,o.default)(n.default.mark(function e(t,r,i){var a,s,o,c,d;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.kind,s=t.rtpParameters,o=t.appData,e.prev=1,e.next=4,M._protoo.request("produce",{transportId:M._sendTransport.id,kind:a,rtpParameters:s,appData:o});case 4:c=e.sent,d=c.id,r({id:d}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),i(e.t0);case 12:case"end":return e.stop()}},e,null,[[1,9]])}));return function(t,r,i){return e.apply(this,arguments)}}()),this._sendTransport.on("produceData",function(){var e=(0,o.default)(n.default.mark(function e(t,r,i){var a,s,o,c;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.sctpStreamParameters,s=t.appData,_.debug('"produceData" event: [sctpStreamParameters:%o, appData:%o]',a,s),e.prev=2,e.next=5,M._protoo.request("produceData",{transportId:M._sendTransport.id,sctpStreamParameters:a,appData:s});case 5:o=e.sent,c=o.id,r({id:c}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),i(e.t0);case 13:case"end":return e.stop()}},e,null,[[2,10]])}));return function(t,r,i){return e.apply(this,arguments)}}());case 23:if(!this._consume){e.next=30;break}return e.next=26,this._protoo.request("createWebRtcTransport",{forceTcp:this._forceTcp,producing:!1,consuming:!0,sctpCapabilities:this._mediasoupDevice.sctpCapabilities});case 26:m=e.sent,f=m.id,g=m.iceParameters,v=m.iceCandidates,b=m.dtlsParameters,y=m.sctpParameters,this._recvTransport=this._mediasoupDevice.createRecvTransport({id:f,iceParameters:g,iceCandidates:v,dtlsParameters:b,sctpParameters:y}),this._recvTransport.on("connect",function(e,t,r){var i=e.dtlsParameters;M._protoo.request("connectWebRtcTransport",{transportId:M._recvTransport.id,dtlsParameters:i}).then(t).catch(r)});case 30:return e.next=32,this._protoo.request("join",{displayName:this._displayName,device:this._device,rtpCapabilities:this._consume?this._mediasoupDevice.rtpCapabilities:void 0,sctpCapabilities:this._mediasoupDevice.sctpCapabilities});case 32:for(S=e.sent,R=S.peers,k=!0,P=!1,T=void 0,e.prev=37,C=R[Symbol.iterator]();!(k=(D=C.next()).done);k=!0)x=D.value,this._handlePeer(x,!0);e.next=45;break;case 41:e.prev=41,e.t0=e.catch(37),P=!0,T=e.t0;case 45:e.prev=45,e.prev=46,k||null==C.return||C.return();case 48:if(e.prev=48,!P){e.next=51;break}throw T;case 51:return e.finish(48);case 52:return e.finish(45);case 53:this._joinRoomObject.onGetMemberList&&this._joinRoomObject.onGetMemberList({memberList:Array.from(this._peers.values())}),this._produce&&(t&&t.mediaType.audio&&this.enableMic(t),t&&t.mediaType.video&&this.enableWebcam(t)),e.next=61;break;case 57:e.prev=57,e.t1=e.catch(1),_.error("_joinRoom() failed:%o",e.t1),this.leaveRoom();case 61:case"end":return e.stop()}},e,this,[[1,57],[37,41,45,53],[46,,48,52]])}));return function(t){return e.apply(this,arguments)}}()},{key:"close",value:function(){this._closed||(this._closed=!0,_.debug("close()"),this._protoo.close(),this._sendTransport&&this._sendTransport.close(),this._recvTransport&&this._recvTransport.close())}},{key:"_handlePeer",value:function(e,t){if(t)this._peerConsumerPause.set(e.id,{audio:!1,video:!1}),this._peerHarkVolume.set(e.id,{hark:null,volume:0}),this._peers.set(e.id,{memberId:e.id,displayName:e.displayName,userObject:e.device});else{var r=e.memberId;this._videoLabels.has(r)&&this._videoLabels.delete(r),this._peerTracks.has(r)&&this._peerTracks.delete(r),this._peerConsumerPause.has(r)&&this._peerConsumerPause.delete(r),this._peerHarkVolume.has(r)&&this._peerHarkVolume.delete(r),this._joinRoomObject&&this._joinRoomObject.onMemberLeft&&this._joinRoomObject.onMemberLeft(r,e.displayName),this._peers.delete(r)}}},{key:"_handleConsumer",value:function(e,t){var r=this;t.on("close",function(i){var a;_.debug('consumer "close" event [id:%s, originator:%s, consumer:%o]',t.id,i,t),"mic"===t.appData.source?a="audio":"webcam"===t.appData.source&&(a="video"),r._setStreamForVideoLabel(t.peer.name,a,null,e)}),t.on("pause",function(i){var a;_.debug('consumer "pause" event [id:%s, originator:%s, consumer:%o]',t.id,i,t),"mic"===t.appData.source?a="audio":"webcam"===t.appData.source&&(a="video"),r._setStreamForVideoLabel(t.peer.name,a,null,e)}),t.on("resume",function(i){var a;_.debug('consumer "resume" event [id:%s, originator:%s, consumer:%o]',t.id,i,t),"mic"===t.appData.source?a="audio":"webcam"===t.appData.source&&(a="video"),r._setStreamForVideoLabel(t.peer.name,a,t.track,e)}),t.supported&&t.receive(this._recvTransport).then(function(i){var a;"mic"===t.appData.source?a="audio":"webcam"===t.appData.source&&(a="video");var n=Boolean(t)&&!t.locallyPaused&&!t.remotelyPaused;if(r._setStreamForVideoLabel(t.peer.name,a,n?i:null,e),r._peerConsumerPause.has(t.peer.name)){var s=r._peerConsumerPause.get(t.peer.name);"audio"==a&&s.audio?t.pause("disableMemberAudio"):"video"==a&&s.video&&t.pause("disableMemberVideo")}t.peer.name==r._focusOnPeer&&"video"==a&&r.focusOnMember(t.peer.name)}).catch(function(e){_.error("unexpected error while receiving a new Consumer:%o",e)})}},{key:"_handleScreenShareConsumer",value:function(e,t,r){if(e&&e.onRecvScreenShare&&e.onRecvScreenShare(t.appData.peerId,r),r){var i=new MediaStream;i.addTrack(t.track),this._screenShareStream=i;var a=document.getElementById(this._screenShareLabel);a&&this._screenShareStream&&(a.srcObject=this._screenShareStream)}}},{key:"_setStreamForVideoLabel",value:function(e,t,r,i){_.debug("_setStreamForVideoLabel [peerName:%s, kind:%s, track:%o OBJECT:%o]",e,t,r,i);var a,n=!1,s=new MediaStream;if(this._peerTracks.has(e)?(a=this._peerTracks.get(e),"audio"==t?(_.debug("trackInfo.audioTrack = track  peerName = %s",e),a.audioTrack=r):(_.debug("trackInfo.videoTrack = track  peerName = %s",e),a.videoTrack=r),this._peerTracks[this._peerName]=a):(a={videoTrack:null,audioTrack:null,addAudio:!0},"audio"==t?(_.debug("trackInfo.audioTrack = track  peerName = %s",e),a.audioTrack=r):(_.debug("trackInfo.videoTrack = track  peerName = %s",e),a.videoTrack=r),this._peerTracks.set(e,a)),a.videoTrack&&(_.debug("stream.addTrack(trackInfo.videoTrack)  peerName = %s",e),s.addTrack(a.videoTrack),n=!0),a.audioTrack&&e!=this._peerName&&a.addAudio&&(_.debug("stream.addTrack(trackInfo.audioTrack)  peerName = %s",e),s.addTrack(a.audioTrack),n=!0),this._videoLabels.has(e)&&n){var o=this._videoLabels.get(e),c=document.getElementById(o);_.debug("show media:====peer name - %s, kind - %s, video label id : %s",e,t,o),c&&(c.srcObject=s)}if(this._masterVideoLabelObject&&this._masterVideoLabelObject.memberId==e&&this.setMasterVideoLabel(this._masterVideoLabelObject),this._audioOnlyLabelObject&&"audio"==t&&this.setAudioOnlyLabel(this._audioOnlyLabelObject),i.onMemberStatusChange&&i.onMemberStatusChange(e,t,null!=r,r),"audio"==t&&r&&this._peerHarkVolume.has(e)){var d=new MediaStream;d.addTrack(r);var l=this._peerHarkVolume.get(e),p=l.hark;l.volume;p&&p.stop(),(p=(0,f.default)(d,{play:!1})).on("volume_change",function(t,r){var a=Math.round(10*Math.pow(10,t/85));1===a&&(a=0),a!==l.volume&&(l.hark=p,l.volume=a,i&&i.onMemberVolumeChange&&i.onMemberVolumeChange(e,a))})}}},{key:"_prepareScreenShareStream",value:function(){var e=(0,o.default)(n.default.mark(function e(t){var r,i;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_.debug("_prepareScreenShareStream"),e.prev=1,i=t||"tab",!("getDisplayMedia"in window.navigator)){e.next=10;break}return _.debug("_prepareScreenShareStream() | getDisplayMedia"),e.next=7,window.navigator.getDisplayMedia({video:!0});case 7:r=e.sent,e.next=21;break;case 10:if(!("getDisplayMedia"in window.navigator.mediaDevices)){e.next=17;break}return _.debug("_prepareScreenShareStream() | mediaDevices.getDisplayMedia"),e.next=14,window.navigator.mediaDevices.getDisplayMedia({video:!0});case 14:r=e.sent,e.next=21;break;case 17:return _.debug("_prepareScreenShareStream() | getUserMedia"),e.next=20,navigator.mediaDevices.getUserMedia({video:{mandatory:{chromeMediaSource:i},optional:[]}});case 20:r=e.sent;case 21:return e.abrupt("return",r);case 24:e.prev=24,e.t0=e.catch(1),_.error("_prepareScreenShareStream() failed:%o",e.t0);case 27:case"end":return e.stop()}},e,null,[[1,24]])}));return function(t){return e.apply(this,arguments)}}()}]),e}();r.default=P},{"./Logger":71,"./deviceInfo":75,"./urlFactory":76,"@babel/runtime/helpers/asyncToGenerator":1,"@babel/runtime/helpers/classCallCheck":2,"@babel/runtime/helpers/createClass":3,"@babel/runtime/helpers/defineProperty":4,"@babel/runtime/helpers/interopRequireDefault":5,"@babel/runtime/helpers/interopRequireWildcard":6,"@babel/runtime/regenerator":8,hark:17,"mediasoup-client":43,"protoo-client":54,recordrtc:58}],75:[function(e,t,r){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(){var e,t=navigator.userAgent,r=a.default.getParser(t);e=r.satisfies({chrome:">=0",chromium:">=0"})?"chrome":r.satisfies({firefox:">=0"})?"firefox":r.satisfies({safari:">=0"})?"safari":r.satisfies({opera:">=0"})?"opera":r.satisfies({"microsoft edge":">=0"})?"edge":"unknown";return{flag:e,name:r.getBrowserName(),version:r.getBrowserVersion()}};var a=i(e("bowser"));window.BB=a.default},{"@babel/runtime/helpers/interopRequireDefault":5,bowser:10}],76:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.getProtooUrl=function(e){var t=e.server,r=e.port,i=e.peerName,a=e.roomId,n=e.role,s=e.displayName,o=e.token;return"wss://".concat(t,":").concat(r,"/?peerId=").concat(i,"&roomId=").concat(a,"&role=").concat(n,"&token=").concat(o,"&displayName=").concat(s)}},{}]},{},[72]);